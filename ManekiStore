<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maneki Store - Sistema de Gesti√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        :root {
            --color-gold: #C5A572;
            --color-purple: #D8BFD8;
            --color-dark-purple: #9370DB;
            --color-light-purple: #E6D5E6;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(197, 165, 114, 0.2);
        }
        
        .product-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 16px rgba(197, 165, 114, 0.3);
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
        }
        
        .sidebar-item:hover {
            background: rgba(197, 165, 114, 0.1);
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, #C5A572 0%, #B8965F 100%);
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #C5A572 0%, #B8965F 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(197, 165, 114, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #D8BFD8 0%, #C8B0D8 100%);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(216, 191, 216, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
        }
        
        .badge-success {
            background: #10B981;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-warning {
            background: #F59E0B;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-danger {
            background: #EF4444;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-vip {
            background: linear-gradient(135deg, #C5A572, #D4AF37);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sidebar {
            transition: all 0.3s ease;
            background: linear-gradient(180deg, #FFFFFF 0%, #FAF9F7 100%);
        }
        
        .category-card {
            transition: all 0.2s ease;
        }
        
        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(197, 165, 114, 0.2);
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 12px;
        }
        
        .variant-tag {
            display: inline-block;
            background: #E6D5E6;
            padding: 4px 12px;
            border-radius: 8px;
            margin: 2px;
            font-size: 12px;
        }
        
        .receipt {
            background: white;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .receipt-header {
            text-align: center;
            border-bottom: 2px solid #C5A572;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .receipt-logo {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .receipt-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }
        
        .receipt-table th {
            background: #E6D5E6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .receipt-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        @media (max-width: 768px) {
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
        }
        
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 shadow-xl z-50 flex flex-col">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-xl flex items-center justify-center">
                        <span class="text-3xl">üê±</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold" style="color: #000;">Maneki Store</h1>
                        <p class="text-xs" style="color: #C5A572;">Regalos Personalizados</p>
                    </div>
                </div>
                <button id="closeSidebar" class="md:hidden text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="showSection('dashboard')" data-section="dashboard" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium">
                <i class="fas fa-home w-5"></i>
                <span>Dashboard</span>
            </button>
            <button onclick="showSection('pos')" data-section="pos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-cash-register w-5"></i>
                <span>Punto de Venta</span>
            </button>
            <button onclick="showSection('abonos')" data-section="abonos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
    <i class="fas fa-hand-holding-usd w-5"></i>
    <span>Ventas en Abonos</span>
</button>
<button onclick="showSection('pedidos')" data-section="pedidos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
    <i class="fas fa-clipboard-list w-5"></i>
    <span>Pedidos por Encargo</span>
</button>
            <button onclick="showSection('quotes')" data-section="quotes" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-file-invoice w-5"></i>
                <span>Cotizaciones</span>
            </button>
            <button onclick="showSection('inventory')" data-section="inventory" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-boxes w-5"></i>
                <span>Inventario</span>
            </button>
            <button onclick="showSection('balance')" data-section="balance" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-balance-scale w-5"></i>
                <span>Balance</span>
            </button>
            <button onclick="showSection('clientes')" data-section="clientes" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-users w-5"></i>
                <span>Clientes</span>
            </button>
            <button onclick="showSection('categorias')" data-section="categorias" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-tags w-5"></i>
                <span>Categor√≠as</span>
            </button>
            <button onclick="showSection('reportes')" data-section="reportes" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-chart-line w-5"></i>
                <span>Reportes</span>
            </button>
        </nav>
        
        <div class="p-4 border-t border-gray-200">
            <button onclick="exportData()" class="w-full mb-2 px-4 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-semibold hover:bg-green-200 transition-all">
                <i class="fas fa-download mr-2"></i>Exportar Datos
            </button>
            <button onclick="clearAllData()" class="w-full mb-3 px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-200 transition-all">
                <i class="fas fa-trash mr-2"></i>Borrar Todo
            </button>
            <div class="flex items-center gap-3 px-4 py-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: #E6D5E6;">
                    <i class="fas fa-user" style="color: #C5A572;"></i>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-semibold text-gray-800">Usuario Admin</p>
                    <p class="text-xs text-gray-500">admin@maneki.com</p>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Mobile Menu Button -->
    <button id="openSidebar" class="md:hidden fixed top-4 left-4 z-40 bg-white p-3 rounded-lg shadow-lg">
        <i class="fas fa-bars text-gray-700"></i>
    </button>
    
    <!-- Main Content -->
    <main class="md:ml-64 min-h-screen">
        
        <!-- DASHBOARD SECTION -->
        <section id="dashboard-section" class="p-4 md:p-8 animate-fade-in">
            <div class="max-w-7xl mx-auto">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard</h2>
                    <p class="text-gray-600">Bienvenido de vuelta, aqu√≠ est√° el resumen de hoy</p>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #E6D5E6;">
                                <i class="fas fa-dollar-sign text-xl" style="color: #C5A572;"></i>
                            </div>
                            <span class="text-green-600 text-sm font-semibold" id="salesTrend">+0%</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Ventas del D√≠a</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="dailySales">$0</h3>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #FFF9F0;">
                                <i class="fas fa-chart-line text-xl" style="color: #C5A572;"></i>
                            </div>
                            <span class="text-green-600 text-sm font-semibold" id="profitTrend">+0%</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Ganancia Neta</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="netProfit">$0</h3>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #FFF9F0;">
                                <i class="fas fa-box text-xl" style="color: #C5A572;"></i>
                            </div>
                            <span class="text-orange-600 text-sm font-semibold" id="lowStockBadge">0 items</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Productos Bajos</p>
                        <h3 class="text-3xl font-bold text-gray-800">Stock</h3>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #E6D5E6;">
                                <i class="fas fa-receipt text-xl" style="color: #C5A572;"></i>
                            </div>
                            <span class="text-red-600 text-sm font-semibold">Pendientes</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Cuentas por Cobrar</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="accountsReceivable">$0</h3>
                    </div>
                </div>
                
                <!-- Chart Section -->
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Ventas de la Semana</h3>
                    <canvas id="salesChart" height="80"></canvas>
                </div>
            </div>
        </section>
        
        <!-- POS SECTION -->
        <section id="pos-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Punto de Venta</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Products Grid -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <div class="mb-6">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="searchProduct" placeholder="Buscar productos..." 
                                           class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                                </div>
                            </div>
                            
                            <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[600px] overflow-y-auto">
                                <!-- Products will be inserted here by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ticket Section -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Ticket de Venta</h3>
                            
                            <!-- Customer Name -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Cliente</label>
                                <input type="text" id="customerName" placeholder="Nombre del cliente (opcional)"
                                       class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none text-sm">
                            </div>
                            
                            <div id="ticketItems" class="space-y-3 mb-6 max-h-[200px] overflow-y-auto">
                                <p class="text-gray-400 text-center py-8 text-sm">No hay productos agregados</p>
                            </div>
                            
                            <div class="border-t border-gray-200 pt-4 space-y-3 mb-4">
                                <div class="flex justify-between text-gray-600">
                                    <span>Subtotal:</span>
                                    <span id="subtotal">$0.00</span>
                                </div>
                                
                                <!-- Discount -->
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Descuento:</span>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="discountPercent" min="0" max="100" value="0" 
                                               class="w-16 px-2 py-1 border border-gray-200 rounded-lg text-sm text-right"
                                               onchange="updateTotals()">
                                        <span class="text-gray-600 text-sm">%</span>
                                        <span id="discountAmount" class="text-red-600 font-semibold">-$0.00</span>
                                    </div>
                                </div>
                                
                                <!-- Tax -->
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="includeTax" onchange="updateTotals()" class="rounded">
                                        <span class="text-gray-600">IVA:</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="taxPercent" min="0" max="100" value="16" 
                                               class="w-16 px-2 py-1 border border-gray-200 rounded-lg text-sm text-right"
                                               onchange="updateTotals()">
                                        <span class="text-gray-600 text-sm">%</span>
                                        <span id="tax" class="font-semibold">$0.00</span>
                                    </div>
                                </div>
                                
                                <div class="flex justify-between text-xl font-bold text-gray-800 pt-2 border-t">
                                    <span>Total:</span>
                                    <span id="total">$0.00</span>
                                </div>
                            </div>
                            
                            <!-- Concept & Notes -->
                            <div class="mb-4 space-y-3">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Concepto</label>
                                    <input type="text" id="saleNotes" placeholder="Ej: Venta de productos"
                                           class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nota</label>
                                    <textarea id="saleNote" placeholder="Nota adicional (opcional)" rows="2"
                                              class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none text-sm"></textarea>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M√©todo de Pago</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="selectPaymentMethod('cash')" 
                                            class="payment-method-btn border-2 rounded-xl py-3 hover:border-opacity-80 transition-all" style="border-color: #C5A572; background: #FFF9F0;">
                                        <i class="fas fa-money-bill-wave text-green-600 text-xl mb-1"></i>
                                        <p class="text-xs font-semibold text-gray-700">Efectivo</p>
                                    </button>
                                    <button onclick="selectPaymentMethod('card')" 
                                            class="payment-method-btn border-2 border-gray-200 rounded-xl py-3 transition-all">
                                        <i class="fas fa-credit-card text-blue-600 text-xl mb-1"></i>
                                        <p class="text-xs font-semibold text-gray-700">Tarjeta</p>
                                    </button>
                                    <button onclick="selectPaymentMethod('transfer')" 
                                            class="payment-method-btn border-2 border-gray-200 rounded-xl py-3 transition-all">
                                        <i class="fas fa-exchange-alt text-purple-600 text-xl mb-1"></i>
                                        <p class="text-xs font-semibold text-gray-700">Transfer.</p>
                                    </button>
                                </div>
                            </div>
                            
                            <button onclick="processPayment()" 
                                    class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg">
                                <i class="fas fa-check mr-2"></i>
                                Cobrar
                            </button>
                            
                            <button onclick="clearTicket()" 
                                    class="w-full mt-3 py-3 rounded-xl text-gray-600 font-semibold border-2 border-gray-200 hover:bg-gray-50 transition-all">
                                <i class="fas fa-trash mr-2"></i>
                                Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- COTIZACIONES SECTION -->
        <section id="quotes-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800">Cotizaciones</h2>
                    <button onclick="openQuoteModal()" 
                            class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">
                        <i class="fas fa-plus mr-2"></i>
                        Nueva Cotizaci√≥n
                    </button>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Folio</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Cliente</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Fecha</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Total</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Estado</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="quotesTable" class="divide-y divide-gray-200">
                                <!-- Rows will be inserted here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- INVENTORY SECTION -->
        <section id="inventory-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800">Inventario</h2>
                    <button onclick="openAddProductModal()" 
                            class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">
                        <i class="fas fa-plus mr-2"></i>
                        Agregar Producto
                    </button>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Imagen</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Producto</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">SKU</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Categor√≠a</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Variantes</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Precio</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Stock</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Estado</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable" class="divide-y divide-gray-200">
                                <!-- Rows will be inserted here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- BALANCE SECTION -->
        <section id="balance-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Balance Financiero</h2>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-arrow-up text-white text-xl"></i>
                            </div>
                        </div>
                        <p class="text-white/80 text-sm mb-1">Total Ingresos</p>
                        <h3 class="text-3xl font-bold" id="totalIncome">$0</h3>
                    </div>
                    
                    <div class="stat-card bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-arrow-down text-white text-xl"></i>
                            </div>
                        </div>
                        <p class="text-white/80 text-sm mb-1">Total Egresos</p>
                        <h3 class="text-3xl font-bold" id="totalExpenses">$0</h3>
                    </div>
                    
                    <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-hand-holding-usd text-white text-xl"></i>
                            </div>
                        </div>
                        <p class="text-white/80 text-sm mb-1">Cuentas por Cobrar</p>
                        <h3 class="text-3xl font-bold" id="totalReceivables">$0</h3>
                    </div>
                    
                    <div class="stat-card bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-file-invoice-dollar text-white text-xl"></i>
                            </div>
                        </div>
                        <p class="text-white/80 text-sm mb-1">Cuentas por Pagar</p>
                        <h3 class="text-3xl font-bold" id="totalPayables">$0</h3>
                    </div>
                </div>
                
                <!-- Transactions Tables -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Ingresos -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Ingresos</h3>
                            <button onclick="openIncomeModal()" class="text-green-600 hover:text-green-700">
                                <i class="fas fa-plus-circle text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto" id="incomeList">
                            <!-- Income items will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Egresos -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Egresos</h3>
                            <button onclick="openExpenseModal()" class="text-red-600 hover:text-red-700">
                                <i class="fas fa-plus-circle text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto" id="expenseList">
                            <!-- Expense items will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Accounts Tables -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Cuentas por Cobrar -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Cuentas por Cobrar</h3>
                            <button onclick="openReceivableModal()" class="text-blue-600 hover:text-blue-700">
                                <i class="fas fa-plus-circle text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto" id="receivablesList">
                            <!-- Receivables will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Cuentas por Pagar -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Cuentas por Pagar</h3>
                            <button onclick="openPayableModal()" class="text-orange-600 hover:text-orange-700">
                                <i class="fas fa-plus-circle text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto" id="payablesList">
                            <!-- Payables will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- CLIENTES SECTION -->
        <section id="clientes-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800">Clientes</h2>
                    <button onclick="openAddClientModal()" 
                            class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">
                        <i class="fas fa-user-plus mr-2"></i>
                        Agregar Cliente
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #E6D5E6;">
                                <i class="fas fa-users text-xl" style="color: #C5A572;"></i>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Total Clientes</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="totalClients">0</h3>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #FFF9F0;">
                                <i class="fas fa-star text-xl" style="color: #C5A572;"></i>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Clientes VIP</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="vipClients">0</h3>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #E6D5E6;">
                                <i class="fas fa-shopping-bag text-xl" style="color: #C5A572;"></i>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Compras Totales</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="totalPurchases">$0</h3>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="searchClient" placeholder="Buscar clientes..." 
                                   class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Cliente</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Tel√©fono</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Email</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Total Compras</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">√öltima Compra</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Tipo</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTable" class="divide-y divide-gray-200">
                                <!-- Rows will be inserted here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- CATEGOR√çAS SECTION -->
        <section id="categorias-section" class="p-4 md:p-8 hidden">
            <div class="max-w-5xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Gesti√≥n de Categor√≠as</h2>
                        <p class="text-gray-600 mt-1">Administra las categor√≠as de tus productos</p>
                    </div>
                    <button onclick="openAddCategoryModal()" 
                            class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">
                        <i class="fas fa-plus mr-2"></i>
                        Nueva Categor√≠a
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="categoriesGrid">
                    <!-- Categories will be inserted here by JS -->
                </div>
            </div>
        </section>
        
        <!-- REPORTES SECTION -->
        <section id="reportes-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Reportes y An√°lisis</h2>
                <button onclick="descargarReporteVentas()" class="px-5 py-3 text-white rounded-xl font-semibold flex items-center gap-2" style="background:#C5A572">
  <i class="fas fa-download"></i> Descargar Reporte CSV
</button>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Productos M√°s Vendidos</h3>
                        <div id="topProductsList" class="space-y-3">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Ventas por Categor√≠a</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Resumen Mensual</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ventas del Mes:</span>
                                <span class="font-bold text-gray-800" id="monthlySales">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ganancia Neta:</span>
                                <span class="font-bold text-green-600" id="monthlyProfit">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Productos Vendidos:</span>
                                <span class="font-bold text-gray-800" id="monthlyUnitsSold">0 unidades</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Inventario</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Valor Total:</span>
                                <span class="font-bold text-gray-800" id="inventoryValue">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Productos Activos:</span>
                                <span class="font-bold text-gray-800" id="activeProducts">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Bajo Stock:</span>
                                <span class="font-bold text-orange-600" id="lowStockCount">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">M√©todos de Pago</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600"><i class="fas fa-money-bill-wave text-green-600 mr-2"></i>Efectivo:</span>
                                <span class="font-bold text-gray-800" id="cashPercentage">0%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600"><i class="fas fa-credit-card text-blue-600 mr-2"></i>Tarjeta:</span>
                                <span class="font-bold text-gray-800" id="cardPercentage">0%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600"><i class="fas fa-exchange-alt text-purple-600 mr-2"></i>Transferencia:</span>
                                <span class="font-bold text-gray-800" id="transferPercentage">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Historial de Ventas Recientes</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Fecha</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Cliente</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Productos</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">M√©todo</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Total</th>
                                </tr>
                            </thead>
                            <tbody id="salesHistoryTable" class="divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- VENTAS EN ABONOS -->
<section id="abonos-section" class="p-4 md:p-8 hidden">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Ventas en Abonos</h2>
            <button onclick="openAbonoModal()" class="btn-primary px-6 py-3 rounded-xl text-white font-semibold"><i class="fas fa-plus mr-2"></i>Nueva Venta en Abonos</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border"><p class="text-gray-600 text-sm mb-1">Total por Cobrar</p><h3 class="text-3xl font-bold text-red-600" id="abonosTotalPendiente">$0</h3></div>
            <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border"><p class="text-gray-600 text-sm mb-1">Clientes con Deuda</p><h3 class="text-3xl font-bold" id="abonosClientesDeuda">0</h3></div>
            <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border"><p class="text-gray-600 text-sm mb-1">Total Cobrado</p><h3 class="text-3xl font-bold text-green-600" id="abonosTotalCobrado">$0</h3></div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b"><tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Folio</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Cliente</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Contacto</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Concepto</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Total</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Abonado</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Resta</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Acciones</th>
                    </tr></thead>
                    <tbody id="abonosTable" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- PEDIDOS POR ENCARGO -->
<section id="pedidos-section" class="p-4 md:p-8 hidden">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Pedidos por Encargo</h2>
            <button onclick="openPedidoModal()" class="btn-primary px-6 py-3 rounded-xl text-white font-semibold"><i class="fas fa-plus mr-2"></i>Nuevo Pedido</button>
        </div>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-xs text-gray-500 mb-1">Activos</p><h3 class="text-2xl font-bold" id="pedidosActivos">0</h3></div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-xs text-gray-500 mb-1">Por Cobrar</p><h3 class="text-2xl font-bold text-red-600" id="pedidosPorCobrar">$0</h3></div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-xs text-gray-500 mb-1">Anticipo Cobrado</p><h3 class="text-2xl font-bold text-green-600" id="pedidosAnticipos">$0</h3></div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-xs text-gray-500 mb-1">Este Mes</p><h3 class="text-2xl font-bold" style="color:#C5A572" id="pedidosMes">0</h3></div>
        </div>
        <div class="flex flex-wrap gap-2 mb-4">
            <button onclick="filterPedidos('todos',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 cursor-pointer" style="border-color:#C5A572;background:#FFF9F0;color:#C5A572;">Todos</button>
            <button onclick="filterPedidos('confirmado',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">‚úÖ Confirmado</button>
            <button onclick="filterPedidos('pago',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">üí∞ Pago</button>
            <button onclick="filterPedidos('produccion',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">üîß Producci√≥n</button>
            <button onclick="filterPedidos('envio',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">üì¶ Env√≠o</button>
            <button onclick="filterPedidos('salida',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">üöö Sali√≥</button>
            <button onclick="filterPedidos('retirar',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">üè™ Retirar</button>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b"><tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Folio</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Cliente</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Concepto</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">F.Pedido</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">F.Entrega</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Total</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Anticipo</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Resta</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Acciones</th>
                    </tr></thead>
                    <tbody id="pedidosTable" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

    </main>
    
    <!-- MODALS -->
    
    <!-- Quote Modal -->
    <div id="quoteModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 p-8 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Nueva Cotizaci√≥n</h3>
                <button onclick="closeQuoteModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="quoteForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Cliente *</label>
                        <input type="text" id="quoteCustomer" required
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">V√°lido hasta</label>
                        <input type="date" id="quoteValidUntil"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Productos</label>
                    <div id="quoteProductsContainer" class="space-y-3 mb-3 max-h-60 overflow-y-auto border border-gray-200 rounded-xl p-4">
                        <!-- Quote products will be added here -->
                    </div>
                    <button type="button" onclick="addProductToQuote()" class="text-sm font-semibold" style="color: #C5A572;">
                        <i class="fas fa-plus mr-1"></i> Agregar Producto
                    </button>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Notas</label>
                    <textarea id="quoteNotes" rows="3" placeholder="Condiciones, observaciones..."
                              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none"></textarea>
                </div>
                
                <div class="flex justify-between items-center pt-4 border-t">
                    <span class="text-lg font-bold">Total:</span>
                    <span id="quoteTotal" class="text-2xl font-bold" style="color: #C5A572;">$0.00</span>
                </div>
                
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-6">
                    <i class="fas fa-save mr-2"></i>
                    Generar Cotizaci√≥n
                </button>
            </form>
        </div>
    </div>
    
    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 p-8 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 no-print">
                <h3 class="text-2xl font-bold text-gray-800">Comprobante</h3>
                <button onclick="closeReceiptModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="receiptContent" class="receipt">
                <!-- Receipt content will be generated here -->
            </div>
            
            <div class="flex gap-3 mt-6 no-print">
                <button onclick="downloadReceipt()" class="btn-primary flex-1 py-3 rounded-xl text-white font-semibold">
                    <i class="fas fa-download mr-2"></i>
                    Descargar PDF
                </button>
                <button onclick="printReceipt()" class="btn-secondary flex-1 py-3 rounded-xl text-white font-semibold">
                    <i class="fas fa-print mr-2"></i>
                    Imprimir
                </button>
                <button onclick="shareReceipt()" class="border-2 px-6 py-3 rounded-xl font-semibold" style="border-color: #C5A572; color: #C5A572;">
                    <i class="fas fa-share-alt mr-2"></i>
                    Compartir
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-8 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Nuevo Producto</h3>
                <button onclick="closeAddProductModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addProductForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Imagen del Producto</label>
                    <input type="file" id="productImage" accept="image/*"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                    <div id="imagePreview" class="mt-3 hidden">
                        <img id="previewImg" class="image-preview mx-auto" src="" alt="Preview">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre del Producto</label>
                    <input type="text" id="productName" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">C√≥digo SKU</label>
                    <input type="text" id="productSKU" placeholder="Se generar√° autom√°ticamente si est√° vac√≠o"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Categor√≠a</label>
                    <select id="productCategory" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Variantes (Opcional)</label>
                    <div class="grid grid-cols-2 gap-4 mb-2">
                        <input type="text" id="variantType" placeholder="Ej: Talla, Color"
                               class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                        <input type="text" id="variantValue" placeholder="Ej: M, Rojo"
                               class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                    </div>
                    <button type="button" onclick="addVariant()" 
                            class="text-sm font-semibold" style="color: #C5A572;">
                        <i class="fas fa-plus mr-1"></i> Agregar Variante
                    </button>
                    <div id="variantsList" class="mt-3"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Costo</label>
                        <input type="number" id="productCost" required step="0.01" min="0"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Precio Venta</label>
                        <input type="number" id="productPrice" required step="0.01" min="0"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Stock Inicial</label>
                    <input type="number" id="productStock" required min="0"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-6">
                    <i class="fas fa-save mr-2"></i>
                    Guardar Producto
                </button>
            </form>
        </div>
    </div>
    
    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Nuevo Cliente</h3>
                <button onclick="closeAddClientModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addClientForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre Completo</label>
                    <input type="text" id="clientName" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono</label>
                    <input type="tel" id="clientPhone" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input type="email" id="clientEmail" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-6">
                    <i class="fas fa-save mr-2"></i>
                    Guardar Cliente
                </button>
            </form>
        </div>
    </div>
    
    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Nueva Categor√≠a</h3>
                <button onclick="closeAddCategoryModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addCategoryForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre de la Categor√≠a</label>
                    <input type="text" id="categoryName" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Emoji/Icono</label>
                    <input type="text" id="categoryEmoji" required maxlength="2" placeholder="üì¶"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none text-center text-3xl">
                    <p class="text-xs text-gray-500 mt-1">Elige un emoji para identificar esta categor√≠a</p>
                </div>
                
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-6">
                    <i class="fas fa-save mr-2"></i>
                    Crear Categor√≠a
                </button>
            </form>
        </div>
    </div>
    
    <!-- Balance Modal -->
    <div id="transactionModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="transactionModalTitle">Nueva Transacci√≥n</h3>
                <button onclick="closeTransactionModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="transactionForm" class="space-y-4">
                <input type="hidden" id="transactionType">
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Concepto</label>
                    <input type="text" id="transactionConcept" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Monto</label>
                    <input type="number" id="transactionAmount" required step="0.01" min="0"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha</label>
                    <input type="date" id="transactionDate" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                </div>
                
                <div id="clientFieldContainer" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Cliente/Proveedor</label>
                    <input type="text" id="transactionClient"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                </div>
                
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-6">
                    <i class="fas fa-save mr-2"></i>
                    Guardar
                </button>
            </form>
        </div>
    </div>
    
    <script>
  // ============================================================
// SUPABASE CONFIG
// ============================================================
const SUPABASE_URL = 'https://hoqcrljgmamaumtdrtzi.supabase.co';
const SUPABASE_KEY = 'sb_publishable_nYdOuvLjAeE6Zwc0ZcSH5g_JT0jOF-M';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function sbSave(key, data) {
            const { error } = await db.from('store').upsert({ key: key, value: JSON.stringify(data) }, { onConflict: 'key' });
            if (error) console.error('sbSave error:', key, error);
        }
        async function sbLoad(key, def) {
            const { data, error } = await db.from('store').select('value').eq('key', key).single();
            if (error || !data) return def;
            try { return JSON.parse(data.value); } catch(e) { return def; }
        }

// Compatibilidad - ya no usamos localStorage
function saveToLocalStorage(key, data) {}
        
        // Auto-save functions
  function saveCategories()  { sbSave('categories', categories); }
function saveProducts()    { sbSave('products', products); }
function saveClients()     { sbSave('clients', clients); }
function saveSalesHistory(){ sbSave('salesHistory', salesHistory); }
function saveQuotes()      { sbSave('quotes', quotes); }
function saveIncomes()     { sbSave('incomes', incomes); }
function saveExpenses()    { sbSave('expenses', expenses); }
function saveReceivables() { sbSave('receivables', receivables); }
function savePayables()    { sbSave('payables', payables); }
function saveAbonos()      { sbSave('abonos', abonos); }
function savePedidos()     { sbSave('pedidos', pedidos); }
        
        // ============== DEFAULT DATA ==============
        const defaultCategories = [
            { id: 'tazas', name: 'Tazas', emoji: '‚òï' },
            { id: 'llaveros', name: 'Llaveros', emoji: 'üîë' },
            { id: 'libretas', name: 'Libretas', emoji: 'üìì' },
            { id: 'peluches', name: 'Peluches', emoji: 'üß∏' },
            { id: 'otros', name: 'Otros', emoji: 'üéÅ' }
        ];
        
        // ============== DATA (Supabase - se carga en initApp) ==============
let categories = [];
let products = [];
let clients = [];
let salesHistory = [];
let quotes = [];
let incomes = [];
let expenses = [];
let receivables = [];
let payables = [];
        
        let ticket = [];
        let selectedPaymentMethod = 'cash';
        let categoryChart = null;
        let salesWeekChart = null;
        let currentVariants = [];
        let currentProductImage = null;
        let currentQuoteProducts = [];
        let lastReceipt = null;
        
        document.addEventListener('DOMContentLoaded', function() { initApp(); });

        async function initApp() {
            try {
                categories   = await sbLoad('categories', defaultCategories);
                products     = await sbLoad('products', []);
                clients      = await sbLoad('clients', []);
                salesHistory = await sbLoad('salesHistory', []);
                quotes       = await sbLoad('quotes', []);
                incomes      = await sbLoad('incomes', []);
                expenses     = await sbLoad('expenses', []);
                receivables  = await sbLoad('receivables', []);
                payables     = await sbLoad('payables', []);
                abonos       = await sbLoad('abonos', []);
                pedidos      = await sbLoad('pedidos', []);
                const today = new Date().toISOString().split('T')[0];
                const vu = new Date(); vu.setDate(vu.getDate()+15);
                const qv = document.getElementById('quoteValidUntil');
                const td = document.getElementById('transactionDate');
                if(qv) qv.value = vu.toISOString().split('T')[0];
                if(td) td.value = today;
                updateDashboard(); renderProducts(); renderInventoryTable();
                renderClientsTable(); renderCategoriesGrid(); renderQuotesTable();
                renderBalance(); updateCategorySelects(); initChart(); initReports();
                setupSearchFilter(); setupClientSearch(); setupMobileMenu();
                setupImageUpload(); renderAbonosTable(); renderPedidosTable();
                const lastSection = localStorage.getItem('maneki_activeSection');
                if (lastSection) { try { showSection(lastSection); } catch(e) {} }
                console.log('Maneki - Supabase OK');
            } catch(err) { console.error('initApp error:', err); }
        }

// Inicializaci√≥n real con Supabase
(async function initApp() {
    try {
        const [
            { data: cats },
            { data: prods },
            { data: cls },
            { data: sales },
            { data: qs },
            { data: inc },
            { data: exp },
            { data: rec },
            { data: pay },
            { data: abs },
            { data: peds }
        ] = await Promise.all([
            db.from('categories').select('*'),
            db.from('products').select('*'),
            db.from('clients').select('*'),
            db.from('sales').select('*'),
            db.from('quotes').select('*'),
            db.from('incomes').select('*'),
            db.from('expenses').select('*'),
            db.from('receivables').select('*'),
            db.from('payables').select('*'),
            db.from('abonos').select('*'),
            db.from('pedidos').select('*')
        ]);

        categories   = cats || [];
        products     = prods || [];
        clients      = cls || [];
        salesHistory = sales || [];
        quotes       = qs || [];
        incomes      = inc || [];
        expenses     = exp || [];
        receivables  = rec || [];
        payables     = pay || [];
        abonos       = abs || [];
        pedidos      = peds || [];

        // Si no hay categor√≠as, insertar las por defecto
        if (categories.length === 0) {
            await db.from('categories').insert(defaultCategories);
            categories = [...defaultCategories];
        }

        const today = new Date().toISOString().split('T')[0];
        const validUntil = new Date();
        validUntil.setDate(validUntil.getDate() + 15);
        document.getElementById('quoteValidUntil').value = validUntil.toISOString().split('T')[0];
        document.getElementById('transactionDate').value = today;

        updateDashboard();
        renderProducts();
        renderInventoryTable();
        renderClientsTable();
        renderCategoriesGrid();
        renderQuotesTable();
        renderBalance();
        updateCategorySelects();
        initChart();
        initReports();
        setupSearchFilter();
        setupClientSearch();
        setupMobileMenu();
        setupImageUpload();
        renderAbonosTable();
        renderPedidosTable();

        // Restaurar secci√≥n activa
        const lastSection = localStorage.getItem('maneki_activeSection');
        if (lastSection) { try { showSection(lastSection); } catch(e) {} }

        console.log('‚úÖ Maneki Store conectado a Supabase');
    } catch(err) {
        console.error('Error iniciando app:', err);
        alert('Error conectando a Supabase. Revisa la consola.');
    }
})();

        
        // ============== DASHBOARD ==============
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            
            const todaySales = salesHistory
                .filter(s => s.date === today)
                .reduce((sum, s) => sum + s.total, 0);
            
            const totalSales = salesHistory.reduce((sum, s) => sum + s.total, 0);
            const totalCosts = products.reduce((sum, p) => sum + (p.cost * p.stock), 0);
            const netProfit = totalSales - totalCosts;
            
            const lowStock = products.filter(p => p.stock > 0 && p.stock <= 10).length;
            
            const accountsReceivable = receivables
                .filter(r => r.status === 'pending')
                .reduce((sum, r) => sum + r.amount, 0);
            
            document.getElementById('dailySales').textContent = `$${todaySales.toFixed(2)}`;
            document.getElementById('salesTrend').textContent = todaySales > 0 ? '+12%' : '0%';
            document.getElementById('netProfit').textContent = `$${netProfit.toFixed(2)}`;
            document.getElementById('profitTrend').textContent = netProfit > 0 ? '+8%' : '0%';
            document.getElementById('lowStockBadge').textContent = `${lowStock} items`;
            document.getElementById('accountsReceivable').textContent = `$${accountsReceivable.toFixed(2)}`;
        }
        
        // ============== POS MODULE ==============
        
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            
            if (products.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-400 text-lg">No hay productos agregados</p><p class="text-gray-500 text-sm mt-2">Ve a Inventario para agregar tu primer producto</p></div>';
                return;
            }
            
            grid.innerHTML = products.map(product => {
                const imageDisplay = product.imageUrl ? 
                    `<img src="${product.imageUrl}" class="w-full h-24 object-cover rounded-lg mb-2">` :
                    `<div class="text-4xl mb-3 text-center">${product.image}</div>`;
                    
                return `
                    <div class="product-card bg-gray-50 rounded-xl p-4 border-2 border-transparent hover:shadow-lg" 
                         onclick="addToTicket(${product.id})">
                        ${imageDisplay}
                        <h4 class="font-semibold text-gray-800 text-sm mb-2 line-clamp-2">${product.name}</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold" style="color: #C5A572;">$${product.price.toFixed(2)}</span>
                            <span class="text-xs ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-orange-600' : 'text-red-600'}">
                                Stock: ${product.stock}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function addToTicket(productId) {
            const product = products.find(p => p.id === productId);
            if (product.stock <= 0) {
                alert('Producto agotado');
                return;
            }
            
            const existingItem = ticket.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                } else {
                    alert('Stock insuficiente');
                    return;
                }
            } else {
                ticket.push({ ...product, quantity: 1 });
            }
            
            renderTicket();
        }
        
        function renderTicket() {
            const container = document.getElementById('ticketItems');
            
            if (ticket.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8 text-sm">No hay productos agregados</p>';
                updateTotals();
                return;
            }
            
            container.innerHTML = ticket.map(item => `
                <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl">
                    <span class="text-2xl">${item.image}</span>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 text-sm truncate">${item.name}</p>
                        <p class="text-xs text-gray-500">$${item.price.toFixed(2)} c/u</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateQuantity(${item.id}, -1)" 
                                class="w-6 h-6 bg-gray-200 rounded-lg hover:bg-gray-300 text-gray-700">
                            <i class="fas fa-minus text-xs"></i>
                        </button>
                        <span class="w-8 text-center font-semibold">${item.quantity}</span>
                        <button onclick="updateQuantity(${item.id}, 1)" 
                                class="w-6 h-6 bg-gray-200 rounded-lg hover:bg-gray-300 text-gray-700">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                    <button onclick="removeFromTicket(${item.id})" 
                            class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
            `).join('');
            
            updateTotals();
        }
        
        function updateQuantity(productId, change) {
            const item = ticket.find(i => i.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromTicket(productId);
                } else if (item.quantity > product.stock) {
                    item.quantity = product.stock;
                    alert('Stock m√°ximo alcanzado');
                }
                renderTicket();
            }
        }
        
        function removeFromTicket(productId) {
            ticket = ticket.filter(item => item.id !== productId);
            renderTicket();
        }
        
        function updateTotals() {
            const subtotal = ticket.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const subtotalAfterDiscount = subtotal - discountAmount;
            
            const includeTax = document.getElementById('includeTax').checked;
            const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;
            const taxAmount = includeTax ? subtotalAfterDiscount * (taxPercent / 100) : 0;
            
            const total = subtotalAfterDiscount + taxAmount;
            
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('discountAmount').textContent = `-$${discountAmount.toFixed(2)}`;
            document.getElementById('tax').textContent = `$${taxAmount.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }
        
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-method-btn').forEach(btn => {
                btn.classList.remove('border-gray-200');
                btn.style.borderColor = '#E5E7EB';
                btn.style.background = 'white';
            });
            const selectedBtn = event.target.closest('.payment-method-btn');
            selectedBtn.style.borderColor = '#C5A572';
            selectedBtn.style.background = '#FFF9F0';
        }
        
        function processPayment() {
            if (ticket.length === 0) {
                alert('Agrega productos al ticket primero');
                return;
            }
            
            const customerName = document.getElementById('customerName').value || 'Cliente General';
            const concept = document.getElementById('saleNotes').value || 'Venta de productos';
            const note = document.getElementById('saleNote').value || '';
            
            const subtotal = ticket.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const subtotalAfterDiscount = subtotal - discountAmount;
            
            const includeTax = document.getElementById('includeTax').checked;
            const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;
            const taxAmount = includeTax ? subtotalAfterDiscount * (taxPercent / 100) : 0;
            
            const total = subtotalAfterDiscount + taxAmount;
            
            ticket.forEach(item => {
                const product = products.find(p => p.id === item.id);
                product.stock -= item.quantity;
            });
            
            const paymentMethodNames = {
                'cash': 'Efectivo',
                'card': 'Tarjeta',
                'transfer': 'Transferencia'
            };
            
            const saleRecord = {
                id: salesHistory.length + 1,
                folio: `V-${String(salesHistory.length + 1).padStart(6, '0')}`,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('es-MX'),
                customer: customerName,
                concept: concept,
                note: note,
                products: [...ticket],
                subtotal: subtotal,
                discount: discountAmount,
                discountPercent: discountPercent,
                tax: taxAmount,
                taxPercent: includeTax ? taxPercent : 0,
                total: total,
                method: paymentMethodNames[selectedPaymentMethod]
            };
            
            salesHistory.push(saleRecord);
            lastReceipt = saleRecord;
            
            incomes.push({
                id: incomes.length + 1,
                concept: `Venta ${saleRecord.folio}`,
                amount: total,
                date: saleRecord.date
            });
            
            saveProducts();
            saveSalesHistory();
            saveIncomes();
            
            generateReceipt(saleRecord);
            document.getElementById('receiptModal').classList.add('active');
            
            clearTicket();
            renderProducts();
            renderInventoryTable();
            updateDashboard();
            renderBalance();
            
            if (salesWeekChart) {
                salesWeekChart.destroy();
            }
            initChart();
        }
        
        function clearTicket() {
            ticket = [];
            document.getElementById('customerName').value = '';
            document.getElementById('saleNotes').value = '';
            document.getElementById('saleNote').value = '';
            document.getElementById('discountPercent').value = '0';
            document.getElementById('includeTax').checked = false;
            renderTicket();
        }
        
        // ============== RECEIPT GENERATION ==============
        
        function generateReceipt(sale) {
            const receiptHTML = `
                <div class="receipt-header">
                    <div class="receipt-logo">üê±</div>
                    <h1 class="text-3xl font-bold mb-2" style="color: #000;">Maneki Store</h1>
                    <p class="text-gray-600">Regalos Personalizados</p>
                    <div class="mt-4" style="background: #E6D5E6; padding: 8px 16px; border-radius: 8px; display: inline-block;">
                        <p class="text-sm font-bold" style="color: #C5A572;">Folio: ${sale.folio}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-sm text-gray-600">Cliente</p>
                        <p class="font-semibold text-gray-800">${sale.customer}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Fecha y Hora</p>
                        <p class="font-semibold text-gray-800">${sale.date} ${sale.time}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">M√©todo de Pago</p>
                        <p class="font-semibold text-gray-800">${sale.method}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Concepto</p>
                        <p class="font-semibold text-gray-800">${sale.concept}</p>
                    </div>
                </div>
                
                <table class="receipt-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant.</th>
                            <th>Precio</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sale.products.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td>$${item.price.toFixed(2)}</td>
                                <td>$${(item.price * item.quantity).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="space-y-2 mt-6 text-right">
                    <div class="flex justify-between text-gray-700">
                        <span>Subtotal:</span>
                        <span>$${sale.subtotal.toFixed(2)}</span>
                    </div>
                    ${sale.discount > 0 ? `
                        <div class="flex justify-between text-red-600">
                            <span>Descuento (${sale.discountPercent}%):</span>
                            <span>-$${sale.discount.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    ${sale.tax > 0 ? `
                        <div class="flex justify-between text-gray-700">
                            <span>IVA (${sale.taxPercent}%):</span>
                            <span>$${sale.tax.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    <div class="flex justify-between text-2xl font-bold pt-3 border-t-2" style="border-color: #C5A572; color: #000;">
                        <span>Total:</span>
                        <span>$${sale.total.toFixed(2)}</span>
                    </div>
                </div>
                
                ${sale.note ? `
                    <div class="mt-6 p-4 rounded-lg" style="background: #FFF9F0;">
                        <p class="text-sm font-semibold text-gray-700 mb-1">Nota:</p>
                        <p class="text-sm text-gray-600">${sale.note}</p>
                    </div>
                ` : ''}
                
                <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                    <p class="text-sm text-gray-600">¬°Gracias por tu compra!</p>
                    <p class="text-xs text-gray-500 mt-2">www.manekistore.com</p>
                </div>
            `;
            
            document.getElementById('receiptContent').innerHTML = receiptHTML;
        }
        
        function downloadReceipt() {
            const element = document.getElementById('receiptContent');
            const opt = {
                margin: 10,
                filename: `Maneki-${lastReceipt.folio}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }
        
        function printReceipt() {
            window.print();
        }
        
        function shareReceipt() {
            const shareText = `Comprobante de compra\n\nFolio: ${lastReceipt.folio}\nCliente: ${lastReceipt.customer}\nTotal: $${lastReceipt.total.toFixed(2)}\n\n¬°Gracias por tu compra!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Comprobante Maneki Store',
                    text: shareText,
                }).catch(err => console.log('Error sharing', err));
            } else {
                navigator.clipboard.writeText(shareText);
                alert('‚úÖ Texto copiado al portapapeles. Puedes pegarlo en WhatsApp o donde desees.');
            }
        }
        
        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.remove('active');
        }
        
        // ============== QUOTES MODULE ==============
        
        function openQuoteModal() {
            currentQuoteProducts = [];
            document.getElementById('quoteProductsContainer').innerHTML = '';
            document.getElementById('quoteModal').classList.add('active');
            updateQuoteTotal();
        }
        
        function closeQuoteModal() {
            document.getElementById('quoteModal').classList.remove('active');
            document.getElementById('quoteForm').reset();
            currentQuoteProducts = [];
        }
        
        function addProductToQuote() {
            if (products.length === 0) {
                alert('No hay productos disponibles. Agrega productos primero en Inventario.');
                return;
            }
            
            const productSelect = `
                <div class="flex gap-2 items-start p-3 bg-gray-50 rounded-lg quote-product-row">
                    <select class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" onchange="updateQuoteTotal()">
                        <option value="">Seleccionar producto...</option>
                        ${products.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} - $${p.price}</option>`).join('')}
                    </select>
                    <input type="number" min="1" value="1" placeholder="Cant." 
                           class="w-20 px-3 py-2 border border-gray-200 rounded-lg text-sm" 
                           onchange="updateQuoteTotal()">
                    <button type="button" onclick="removeQuoteProduct(this)" class="text-red-500 hover:text-red-700 px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            document.getElementById('quoteProductsContainer').insertAdjacentHTML('beforeend', productSelect);
            updateQuoteTotal();
        }
        
        function removeQuoteProduct(button) {
            button.closest('.quote-product-row').remove();
            updateQuoteTotal();
        }
        
        function updateQuoteTotal() {
            let total = 0;
            const productRows = document.getElementById('quoteProductsContainer').querySelectorAll('.quote-product-row');
            
            productRows.forEach(row => {
                const select = row.querySelector('select');
                const quantityInput = row.querySelector('input[type="number"]');
                const selectedOption = select.options[select.selectedIndex];
                
                if (selectedOption && selectedOption.value) {
                    const price = parseFloat(selectedOption.dataset.price);
                    const quantity = parseInt(quantityInput.value) || 1;
                    total += price * quantity;
                }
            });
            
            document.getElementById('quoteTotal').textContent = `$${total.toFixed(2)}`;
        }
        
        document.getElementById('quoteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customer = document.getElementById('quoteCustomer').value;
            const validUntil = document.getElementById('quoteValidUntil').value;
            const notes = document.getElementById('quoteNotes').value;
            
            const productRows = document.getElementById('quoteProductsContainer').querySelectorAll('.quote-product-row');
            const quoteProducts = [];
            let total = 0;
            
            productRows.forEach(row => {
                const select = row.querySelector('select');
                const quantityInput = row.querySelector('input[type="number"]');
                const selectedOption = select.options[select.selectedIndex];
                
                if (selectedOption && selectedOption.value) {
                    const productId = parseInt(selectedOption.value);
                    const product = products.find(p => p.id === productId);
                    const quantity = parseInt(quantityInput.value) || 1;
                    const subtotal = product.price * quantity;
                    
                    quoteProducts.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        quantity: quantity,
                        subtotal: subtotal
                    });
                    
                    total += subtotal;
                }
            });
            
            if (quoteProducts.length === 0) {
                alert('Agrega al menos un producto a la cotizaci√≥n');
                return;
            }
            
            const newQuote = {
                id: quotes.length + 1,
                folio: `COT-${String(quotes.length + 1).padStart(6, '0')}`,
                customer: customer,
                date: new Date().toISOString().split('T')[0],
                validUntil: validUntil,
                products: quoteProducts,
                notes: notes,
                total: total,
                status: 'pending'
            };
            
            quotes.push(newQuote);
            saveQuotes();
            
            alert('‚úÖ Cotizaci√≥n generada exitosamente');
            closeQuoteModal();
            renderQuotesTable();
            
            generateQuoteDocument(newQuote);
        });
        
        function renderQuotesTable() {
            const tbody = document.getElementById('quotesTable');
            
            if (quotes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-400">No hay cotizaciones creadas</td></tr>';
                return;
            }
            
            tbody.innerHTML = quotes.map(quote => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold" style="color: #C5A572;">${quote.folio}</td>
                    <td class="px-6 py-4 text-gray-800">${quote.customer}</td>
                    <td class="px-6 py-4 text-gray-600">${quote.date}</td>
                    <td class="px-6 py-4 text-gray-800 font-semibold">$${quote.total.toFixed(2)}</td>
                    <td class="px-6 py-4">
                        <span class="badge-${quote.status === 'pending' ? 'warning' : 'success'}">
                            ${quote.status === 'pending' ? 'Pendiente' : 'Aprobada'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="viewQuote(${quote.id})" class="text-blue-600 hover:text-blue-800 mr-3" title="Ver">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="shareQuote(${quote.id})" class="text-green-600 hover:text-green-800 mr-3" title="Compartir">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button onclick="deleteQuote(${quote.id})" class="text-red-600 hover:text-red-800" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function generateQuoteDocument(quote) {
            const quoteHTML = `
                <div class="receipt-header">
                    <div class="receipt-logo">üê±</div>
                    <h1 class="text-3xl font-bold mb-2" style="color: #000;">Maneki Store</h1>
                    <p class="text-gray-600">Cotizaci√≥n</p>
                    <div class="mt-4" style="background: #E6D5E6; padding: 8px 16px; border-radius: 8px; display: inline-block;">
                        <p class="text-sm font-bold" style="color: #C5A572;">Folio: ${quote.folio}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-sm text-gray-600">Cliente</p>
                        <p class="font-semibold text-gray-800">${quote.customer}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Fecha</p>
                        <p class="font-semibold text-gray-800">${quote.date}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">V√°lido hasta</p>
                        <p class="font-semibold text-gray-800">${quote.validUntil}</p>
                    </div>
                </div>
                
                <table class="receipt-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${quote.products.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td>$${item.price.toFixed(2)}</td>
                                <td>$${item.subtotal.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="text-right mt-6">
                    <div class="text-2xl font-bold" style="color: #000;">
                        Total: <span style="color: #C5A572;">$${quote.total.toFixed(2)}</span>
                    </div>
                </div>
                
                ${quote.notes ? `
                    <div class="mt-6 p-4 rounded-lg" style="background: #FFF9F0;">
                        <p class="text-sm font-semibold text-gray-700 mb-1">Observaciones:</p>
                        <p class="text-sm text-gray-600">${quote.notes}</p>
                    </div>
                ` : ''}
                
                <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                    <p class="text-sm text-gray-600">Esta cotizaci√≥n es v√°lida hasta ${quote.validUntil}</p>
                    <p class="text-xs text-gray-500 mt-2">www.manekistore.com</p>
                </div>
            `;
            
            document.getElementById('receiptContent').innerHTML = quoteHTML;
            lastReceipt = quote;
            document.getElementById('receiptModal').classList.add('active');
        }
        
        function viewQuote(id) {
            const quote = quotes.find(q => q.id === id);
            if (quote) {
                generateQuoteDocument(quote);
            }
        }
        
        function shareQuote(id) {
            const quote = quotes.find(q => q.id === id);
            if (!quote) return;
            
            const shareText = `üìã *Cotizaci√≥n ${quote.folio}*\n\n` +
                `Cliente: ${quote.customer}\n` +
                `Fecha: ${quote.date}\n` +
                `V√°lido hasta: ${quote.validUntil}\n\n` +
                `*Productos:*\n` +
                quote.products.map(p => `‚Ä¢ ${p.name} (${p.quantity}) - $${p.subtotal.toFixed(2)}`).join('\n') +
                `\n\n*Total: $${quote.total.toFixed(2)}*\n\n` +
                (quote.notes ? `Observaciones: ${quote.notes}\n\n` : '') +
                `¬°Gracias por tu preferencia!\n` +
                `Maneki Store - Regalos Personalizados`;
            
            if (navigator.share) {
                navigator.share({
                    title: `Cotizaci√≥n ${quote.folio}`,
                    text: shareText,
                }).catch(err => console.log('Error sharing', err));
            } else {
                navigator.clipboard.writeText(shareText);
                alert('‚úÖ Cotizaci√≥n copiada al portapapeles. Puedes pegarla en WhatsApp u otro lugar.');
            }
        }
        
        function deleteQuote(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta cotizaci√≥n?')) {
                quotes = quotes.filter(q => q.id !== id);
                saveQuotes();
                renderQuotesTable();
            }
        }
        
        // ============== INVENTORY MODULE ==============
        
        function setupImageUpload() {
            document.getElementById('productImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        currentProductImage = event.target.result;
                        document.getElementById('previewImg').src = event.target.result;
                        document.getElementById('imagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function addVariant() {
            const type = document.getElementById('variantType').value.trim();
            const value = document.getElementById('variantValue').value.trim();
            
            if (type && value) {
                currentVariants.push({ type, value });
                renderVariantsList();
                document.getElementById('variantType').value = '';
                document.getElementById('variantValue').value = '';
            } else {
                alert('Por favor completa ambos campos de la variante');
            }
        }
        
        function renderVariantsList() {
            const container = document.getElementById('variantsList');
            container.innerHTML = currentVariants.map((v, index) => `
                <span class="variant-tag">
                    ${v.type}: ${v.value}
                    <button type="button" onclick="removeVariant(${index})" class="ml-2 text-red-500 hover:text-red-700">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `).join('');
        }
        
        function removeVariant(index) {
            currentVariants.splice(index, 1);
            renderVariantsList();
        }
        
        function generateSKU(categoryId) {
            const categoryMap = {
                'tazas': 'TAZ',
                'llaveros': 'LLV',
                'libretas': 'LIB',
                'peluches': 'PEL',
                'otros': 'OTR'
            };
            
            const prefix = categoryMap[categoryId] || 'PRD';
            const count = products.filter(p => p.category === categoryId).length + 1;
            return `MNK-${prefix}-${String(count).padStart(3, '0')}`;
        }
        
        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTable');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-gray-400">No hay productos en el inventario. Agrega tu primer producto.</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => {
                const category = categories.find(c => c.id === product.category);
                const categoryName = category ? category.name : product.category;
                
                let statusBadge = '';
                if (product.stock === 0) {
                    statusBadge = '<span class="badge-danger">Agotado</span>';
                } else if (product.stock <= 10) {
                    statusBadge = '<span class="badge-warning">Bajo Stock</span>';
                } else {
                    statusBadge = '<span class="badge-success">Disponible</span>';
                }
                
                const imageDisplay = product.imageUrl ? 
                    `<img src="${product.imageUrl}" class="w-16 h-16 object-cover rounded-lg">` :
                    `<span class="text-3xl">${product.image}</span>`;
                
                const variantsDisplay = product.variants && product.variants.length > 0 ?
                    product.variants.map(v => `<span class="variant-tag">${v.type}: ${v.value}</span>`).join('') :
                    '<span class="text-xs text-gray-400">Sin variantes</span>';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">${imageDisplay}</td>
                        <td class="px-6 py-4">
                            <div>
                                <span class="font-semibold text-gray-800">${product.name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-600 text-sm">${product.sku}</td>
                        <td class="px-6 py-4 text-gray-600 capitalize">${categoryName}</td>
                        <td class="px-6 py-4">${variantsDisplay}</td>
                        <td class="px-6 py-4 text-gray-800 font-semibold">$${product.price.toFixed(2)}</td>
                        <td class="px-6 py-4 text-gray-800 font-semibold">${product.stock}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4">
                            <button onclick="editProduct(${product.id})" 
                                    class="text-blue-600 hover:text-blue-800 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteProduct(${product.id})" 
                                    class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function openAddProductModal() {
            currentVariants = [];
            currentProductImage = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('addProductModal').classList.add('active');
        }
        
        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.remove('active');
            document.getElementById('addProductForm').reset();
            currentVariants = [];
            currentProductImage = null;
            renderVariantsList();
        }
        
        document.getElementById('addProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const categoryId = document.getElementById('productCategory').value;
            const category = categories.find(c => c.id === categoryId);
            let sku = document.getElementById('productSKU').value.trim();
            
            if (!sku) {
                sku = generateSKU(categoryId);
            }
            
            const maxId = products.length > 0 ? Math.max(...products.map(p => p.id)) : 0;
            
            const newProduct = {
                id: maxId + 1,
                name: document.getElementById('productName').value,
                category: categoryId,
                cost: parseFloat(document.getElementById('productCost').value),
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                image: category ? category.emoji : 'üì¶',
                imageUrl: currentProductImage,
                sku: sku,
                variants: [...currentVariants]
            };
            
            products.push(newProduct);
            saveProducts();
            
            renderInventoryTable();
            renderProducts();
            updateDashboard();
            closeAddProductModal();
            
            alert('‚úÖ Producto agregado exitosamente');
        });
        
        function editProduct(id) {
            alert('Funci√≥n de edici√≥n en desarrollo');
        }
        
        function deleteProduct(id) {
            if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
                products = products.filter(p => p.id !== id);
                saveProducts();
                renderInventoryTable();
                renderProducts();
                updateDashboard();
            }
        }
        
        // ============== BALANCE MODULE ==============
        
        function renderBalance() {
            const totalIncome = incomes.reduce((sum, i) => sum + i.amount, 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const totalReceivables = receivables.filter(r => r.status === 'pending').reduce((sum, r) => sum + r.amount, 0);
            const totalPayables = payables.filter(p => p.status === 'pending').reduce((sum, p) => sum + p.amount, 0);
            
            document.getElementById('totalIncome').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('totalReceivables').textContent = `$${totalReceivables.toFixed(2)}`;
            document.getElementById('totalPayables').textContent = `$${totalPayables.toFixed(2)}`;
            
            renderIncomeList();
            renderExpenseList();
            renderReceivablesList();
            renderPayablesList();
        }
        
        function renderIncomeList() {
            const container = document.getElementById('incomeList');
            container.innerHTML = incomes.map(income => `
                <div class="flex justify-between items-center p-3 bg-green-50 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${income.concept}</p>
                        <p class="text-xs text-gray-500">${income.date}</p>
                    </div>
                    <span class="font-bold text-green-600">+$${income.amount.toFixed(2)}</span>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center py-4">No hay ingresos registrados</p>';
        }
        
        function renderExpenseList() {
            const container = document.getElementById('expenseList');
            container.innerHTML = expenses.map(expense => `
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${expense.concept}</p>
                        <p class="text-xs text-gray-500">${expense.date}</p>
                    </div>
                    <span class="font-bold text-red-600">-$${expense.amount.toFixed(2)}</span>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center py-4">No hay egresos registrados</p>';
        }
        
        function renderReceivablesList() {
            const container = document.getElementById('receivablesList');
            container.innerHTML = receivables.map(rec => `
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${rec.client}</p>
                        <p class="text-xs text-gray-500">Vence: ${rec.dueDate}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-blue-600">$${rec.amount.toFixed(2)}</p>
                        <button onclick="markAsPaid('receivable', ${rec.id})" class="text-xs text-green-600 hover:text-green-700">
                            Marcar pagado
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center py-4">No hay cuentas por cobrar</p>';
        }
        
        function renderPayablesList() {
            const container = document.getElementById('payablesList');
            container.innerHTML = payables.map(pay => `
                <div class="flex justify-between items-center p-3 bg-orange-50 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${pay.supplier}</p>
                        <p class="text-xs text-gray-500">Vence: ${pay.dueDate}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-orange-600">$${pay.amount.toFixed(2)}</p>
                        <button onclick="markAsPaid('payable', ${pay.id})" class="text-xs text-green-600 hover:text-green-700">
                            Marcar pagado
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center py-4">No hay cuentas por pagar</p>';
        }
        
        function openIncomeModal() {
            document.getElementById('transactionModalTitle').textContent = 'Nuevo Ingreso';
            document.getElementById('transactionType').value = 'income';
            document.getElementById('clientFieldContainer').classList.add('hidden');
            document.getElementById('transactionModal').classList.add('active');
        }
        
        function openExpenseModal() {
            document.getElementById('transactionModalTitle').textContent = 'Nuevo Egreso';
            document.getElementById('transactionType').value = 'expense';
            document.getElementById('clientFieldContainer').classList.add('hidden');
            document.getElementById('transactionModal').classList.add('active');
        }
        
        function openReceivableModal() {
            document.getElementById('transactionModalTitle').textContent = 'Nueva Cuenta por Cobrar';
            document.getElementById('transactionType').value = 'receivable';
            document.getElementById('clientFieldContainer').classList.remove('hidden');
            document.getElementById('transactionModal').classList.add('active');
        }
        
        function openPayableModal() {
            document.getElementById('transactionModalTitle').textContent = 'Nueva Cuenta por Pagar';
            document.getElementById('transactionType').value = 'payable';
            document.getElementById('clientFieldContainer').classList.remove('hidden');
            document.getElementById('transactionModal').classList.add('active');
        }
        
        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
            document.getElementById('transactionForm').reset();
        }
        
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const type = document.getElementById('transactionType').value;
            const concept = document.getElementById('transactionConcept').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const date = document.getElementById('transactionDate').value;
            const client = document.getElementById('transactionClient').value;
            
            if (type === 'income') {
                incomes.push({ id: incomes.length + 1, concept, amount, date });
                saveIncomes();
            } else if (type === 'expense') {
                expenses.push({ id: expenses.length + 1, concept, amount, date });
                saveExpenses();
            } else if (type === 'receivable') {
                receivables.push({ id: receivables.length + 1, client: client || concept, amount, dueDate: date, status: 'pending' });
                saveReceivables();
            } else if (type === 'payable') {
                payables.push({ id: payables.length + 1, supplier: client || concept, amount, dueDate: date, status: 'pending' });
                savePayables();
            }
            
            renderBalance();
            updateDashboard();
            closeTransactionModal();
            alert('‚úÖ Transacci√≥n registrada exitosamente');
        });
        
        function markAsPaid(type, id) {
            if (type === 'receivable') {
                const index = receivables.findIndex(r => r.id === id);
                if (index !== -1) {
                    const amount = receivables[index].amount;
                    receivables.splice(index, 1);
                    incomes.push({ id: incomes.length + 1, concept: 'Cobro realizado', amount, date: new Date().toISOString().split('T')[0] });
                    saveReceivables();
                    saveIncomes();
                }
            } else if (type === 'payable') {
                const index = payables.findIndex(p => p.id === id);
                if (index !== -1) {
                    const amount = payables[index].amount;
                    payables.splice(index, 1);
                    expenses.push({ id: expenses.length + 1, concept: 'Pago realizado', amount, date: new Date().toISOString().split('T')[0] });
                    savePayables();
                    saveExpenses();
                }
            }
            
            renderBalance();
            updateDashboard();
        }
        
        // ============== CLIENTS MODULE ==============
        
        function renderClientsTable() {
            const tbody = document.getElementById('clientsTable');
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-400">No hay clientes registrados</td></tr>';
                updateClientStats();
                return;
            }
            
            tbody.innerHTML = clients.map(client => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: #E6D5E6;">
                                <i class="fas fa-user" style="color: #C5A572;"></i>
                            </div>
                            <span class="font-semibold text-gray-800">${client.name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-600">${client.phone}</td>
                    <td class="px-6 py-4 text-gray-600">${client.email}</td>
                    <td class="px-6 py-4 text-gray-800 font-semibold">$${client.totalPurchases.toFixed(2)}</td>
                    <td class="px-6 py-4 text-gray-600">${client.lastPurchase}</td>
                    <td class="px-6 py-4">
                        ${client.isVIP ? '<span class="badge-vip">VIP</span>' : '<span class="badge-success">Regular</span>'}
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="editClient(${client.id})" 
                                class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteClient(${client.id})" 
                                class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            updateClientStats();
        }
        
        function updateClientStats() {
            document.getElementById('totalClients').textContent = clients.length;
            document.getElementById('vipClients').textContent = clients.filter(c => c.isVIP).length;
            const totalPurchases = clients.reduce((sum, c) => sum + c.totalPurchases, 0);
            document.getElementById('totalPurchases').textContent = `$${totalPurchases.toFixed(2)}`;
        }
        
        function openAddClientModal() {
            document.getElementById('addClientModal').classList.add('active');
        }
        
        function closeAddClientModal() {
            document.getElementById('addClientModal').classList.remove('active');
            document.getElementById('addClientForm').reset();
        }
        
        document.getElementById('addClientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const maxId = clients.length > 0 ? Math.max(...clients.map(c => c.id)) : 0;
            
            const newClient = {
                id: maxId + 1,
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                totalPurchases: 0,
                lastPurchase: new Date().toISOString().split('T')[0],
                isVIP: false
            };
            
            clients.push(newClient);
            saveClients();
            renderClientsTable();
            closeAddClientModal();
            
            alert('‚úÖ Cliente agregado exitosamente');
        });
        
        function editClient(id) {
            alert('Funci√≥n de edici√≥n en desarrollo');
        }
        
        function deleteClient(id) {
            if (confirm('¬øEst√°s seguro de eliminar este cliente?')) {
                clients = clients.filter(c => c.id !== id);
                saveClients();
                renderClientsTable();
            }
        }
        
        function setupClientSearch() {
            document.getElementById('searchClient').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredClients = clients.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) || 
                    c.email.toLowerCase().includes(searchTerm) ||
                    c.phone.includes(searchTerm)
                );
                
                const tbody = document.getElementById('clientsTable');
                tbody.innerHTML = filteredClients.map(client => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: #E6D5E6;">
                                    <i class="fas fa-user" style="color: #C5A572;"></i>
                                </div>
                                <span class="font-semibold text-gray-800">${client.name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-600">${client.phone}</td>
                        <td class="px-6 py-4 text-gray-600">${client.email}</td>
                        <td class="px-6 py-4 text-gray-800 font-semibold">$${client.totalPurchases.toFixed(2)}</td>
                        <td class="px-6 py-4 text-gray-600">${client.lastPurchase}</td>
                        <td class="px-6 py-4">
                            ${client.isVIP ? '<span class="badge-vip">VIP</span>' : '<span class="badge-success">Regular</span>'}
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="editClient(${client.id})" 
                                    class="text-blue-600 hover:text-blue-800 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteClient(${client.id})" 
                                    class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            });
        }
        
        // ============== CATEGORIES MODULE ==============
        
        function renderCategoriesGrid() {
            const grid = document.getElementById('categoriesGrid');
            grid.innerHTML = categories.map(category => {
                const productCount = products.filter(p => p.category === category.id).length;
                return `
                    <div class="category-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-start justify-between mb-4">
                            <div class="text-5xl">${category.emoji}</div>
                            <button onclick="deleteCategory('${category.id}')" 
                                    class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${category.name}</h3>
                        <p class="text-gray-600 text-sm">${productCount} producto${productCount !== 1 ? 's' : ''}</p>
                    </div>
                `;
            }).join('');
        }
        
        function openAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.add('active');
        }
        
        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('active');
            document.getElementById('addCategoryForm').reset();
        }
        
        document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('categoryName').value;
            const emoji = document.getElementById('categoryEmoji').value;
            const id = name.toLowerCase().replace(/\s+/g, '_');
            
            if (categories.find(c => c.id === id)) {
                alert('Ya existe una categor√≠a con ese nombre');
                return;
            }
            
            const newCategory = {
                id: id,
                name: name,
                emoji: emoji
            };
            
            categories.push(newCategory);
            saveCategories();
            renderCategoriesGrid();
            updateCategorySelects();
            closeAddCategoryModal();
            
            alert('‚úÖ Categor√≠a creada exitosamente');
        });
        
        function deleteCategory(categoryId) {
            const productsInCategory = products.filter(p => p.category === categoryId).length;
            
            if (productsInCategory > 0) {
                alert(`No puedes eliminar esta categor√≠a porque tiene ${productsInCategory} producto(s) asociado(s). Elimina o reasigna los productos primero.`);
                return;
            }
            
            if (confirm('¬øEst√°s seguro de eliminar esta categor√≠a?')) {
                categories = categories.filter(c => c.id !== categoryId);
                saveCategories();
                renderCategoriesGrid();
                updateCategorySelects();
            }
        }
        
        function updateCategorySelects() {
            const select = document.getElementById('productCategory');
            select.innerHTML = categories.map(cat => 
                `<option value="${cat.id}">${cat.emoji} ${cat.name}</option>`
            ).join('');
        }
        
        // ============== REPORTS MODULE ==============
        
        function initReports() {
            updateInventoryStats();
            renderTopProducts();
            renderSalesHistory();
            updateMonthlyStats();
            updatePaymentMethods();
        }
        
        function updateInventoryStats() {
            const inventoryValue = products.reduce((sum, p) => sum + (p.cost * p.stock), 0);
            const activeProducts = products.filter(p => p.stock > 0).length;
            const lowStockCount = products.filter(p => p.stock > 0 && p.stock <= 10).length;
            
            document.getElementById('inventoryValue').textContent = `$${inventoryValue.toFixed(2)}`;
            document.getElementById('activeProducts').textContent = activeProducts;
            document.getElementById('lowStockCount').textContent = lowStockCount;
        }
        
        function updateMonthlyStats() {
            const currentMonth = new Date().getMonth();
            const monthlySales = salesHistory
                .filter(s => new Date(s.date).getMonth() === currentMonth)
                .reduce((sum, s) => sum + s.total, 0);
            
            const monthlyCosts = products.reduce((sum, p) => sum + (p.cost * 10), 0);
            const monthlyProfit = monthlySales - monthlyCosts;
            
            const monthlyUnits = salesHistory
                .filter(s => new Date(s.date).getMonth() === currentMonth)
                .reduce((sum, s) => sum + s.products.length, 0);
            
            document.getElementById('monthlySales').textContent = `$${monthlySales.toFixed(2)}`;
            document.getElementById('monthlyProfit').textContent = `$${monthlyProfit.toFixed(2)}`;
            document.getElementById('monthlyUnitsSold').textContent = `${monthlyUnits} unidades`;
        }
        
        function updatePaymentMethods() {
            const cashSales = salesHistory.filter(s => s.method === 'Efectivo').length;
            const cardSales = salesHistory.filter(s => s.method === 'Tarjeta').length;
            const transferSales = salesHistory.filter(s => s.method === 'Transferencia').length;
            const totalSales = salesHistory.length;
            
            const cashPercentage = totalSales > 0 ? ((cashSales / totalSales) * 100).toFixed(0) : 0;
            const cardPercentage = totalSales > 0 ? ((cardSales / totalSales) * 100).toFixed(0) : 0;
            const transferPercentage = totalSales > 0 ? ((transferSales / totalSales) * 100).toFixed(0) : 0;
            
            document.getElementById('cashPercentage').textContent = `${cashPercentage}%`;
            document.getElementById('cardPercentage').textContent = `${cardPercentage}%`;
            document.getElementById('transferPercentage').textContent = `${transferPercentage}%`;
        }
        
        function renderTopProducts() {
            if (salesHistory.length === 0) {
                document.getElementById('topProductsList').innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No hay ventas registradas a√∫n</p>';
                return;
            }
            
            const productSales = {};
            
            salesHistory.forEach(sale => {
                sale.products.forEach(item => {
                    if (!productSales[item.id]) {
                        productSales[item.id] = {
                            name: item.name,
                            sales: 0,
                            revenue: 0
                        };
                    }
                    productSales[item.id].sales += item.quantity;
                    productSales[item.id].revenue += item.price * item.quantity;
                });
            });
            
            const topProducts = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 4);
            
            const container = document.getElementById('topProductsList');
            container.innerHTML = topProducts.map((product, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 text-white rounded-full flex items-center justify-center font-bold text-sm" style="background: #C5A572;">
                            ${index + 1}
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${product.name}</p>
                            <p class="text-xs text-gray-500">${product.sales} vendidos</p>
                        </div>
                    </div>
                    <span class="font-bold text-gray-800">$${product.revenue.toFixed(0)}</span>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center py-4">Sin datos disponibles</p>';
        }
        
        function initCategoryChart() {
            const canvas = document.getElementById('categoryChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
                categoryChart = null;
            }
            
            if (products.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px Inter';
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'center';
                ctx.fillText('No hay productos para mostrar', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const categorySales = {};
            categories.forEach(cat => {
                const categoryProducts = products.filter(p => p.category === cat.id);
                categorySales[cat.name] = categoryProducts.reduce((sum, p) => sum + (p.price * 5), 0);
            });
            
            const labels = [];
            const data = [];
            Object.entries(categorySales).forEach(([name, value]) => {
                if (value > 0) {
                    labels.push(name);
                    data.push(value);
                }
            });
            
            if (labels.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px Inter';
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'center';
                ctx.fillText('Sin ventas por categor√≠a', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#C5A572',
                            '#D8BFD8',
                            '#10B981',
                            '#F59E0B',
                            '#EF4444',
                            '#3B82F6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        }
                    }
                }
            });
        }
        
        function renderSalesHistory() {
            const tbody = document.getElementById('salesHistoryTable');
            
            if (salesHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400">No hay ventas registradas</td></tr>';
                return;
            }
            
            tbody.innerHTML = salesHistory.slice(-10).reverse().map(sale => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-3 text-gray-800">${sale.date}</td>
                    <td class="px-6 py-3 text-gray-800">${sale.customer}</td>
                    <td class="px-6 py-3 text-gray-600">${sale.products.length} item(s)</td>
                    <td class="px-6 py-3">
                        <span class="text-xs ${sale.method === 'Efectivo' ? 'text-green-600' : sale.method === 'Tarjeta' ? 'text-blue-600' : 'text-purple-600'}">
                            ${sale.method}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-gray-800 font-semibold">$${sale.total.toFixed(2)}</td>
                </tr>
            `).join('');
        }
        
        // ============== NAVIGATION ==============
        
        function showSection(sectionName) {
            localStorage.setItem('maneki_activeSection', sectionName);
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
            
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('collapsed');
            }
            
            if (sectionName === 'reportes') {
                setTimeout(() => {
                    initCategoryChart();
                }, 150);
            }
        }
        
        function setupMobileMenu() {
            document.getElementById('openSidebar').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('collapsed');
            });
            
            document.getElementById('closeSidebar').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('collapsed');
            });
        }
        
        // ============== CHART ==============
        
        function initChart() {
            const last7Days = [];
            const salesByDay = {};
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(dateStr);
                salesByDay[dateStr] = 0;
            }
            
            salesHistory.forEach(sale => {
                if (salesByDay.hasOwnProperty(sale.date)) {
                    salesByDay[sale.date] += sale.total;
                }
            });
            
            const labels = last7Days.map(date => {
                const d = new Date(date);
                return ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'][d.getDay()];
            });
            
            const data = last7Days.map(date => salesByDay[date]);
            
            const ctx = document.getElementById('salesChart').getContext('2d');
            salesWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas ($)',
                        data: data,
                        backgroundColor: 'rgba(197, 165, 114, 0.8)',
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // ============== SEARCH FILTER ==============
        
        function setupSearchFilter() {
            document.getElementById('searchProduct').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredProducts = products.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.category.toLowerCase().includes(searchTerm) ||
                    (p.sku && p.sku.toLowerCase().includes(searchTerm))
                );
                
                const grid = document.getElementById('productsGrid');
                
                if (filteredProducts.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-400">No se encontraron productos</p></div>';
                    return;
                }
                
                grid.innerHTML = filteredProducts.map(product => {
                    const imageDisplay = product.imageUrl ? 
                        `<img src="${product.imageUrl}" class="w-full h-24 object-cover rounded-lg mb-2">` :
                        `<div class="text-4xl mb-3 text-center">${product.image}</div>`;
                        
                    return `
                        <div class="product-card bg-gray-50 rounded-xl p-4 border-2 border-transparent hover:shadow-lg" 
                             onclick="addToTicket(${product.id})">
                            ${imageDisplay}
                            <h4 class="font-semibold text-gray-800 text-sm mb-2 line-clamp-2">${product.name}</h4>
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold" style="color: #C5A572;">$${product.price.toFixed(2)}</span>
                                <span class="text-xs ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-orange-600' : 'text-red-600'}">
                                    Stock: ${product.stock}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }
        
    // ============ VENTAS EN ABONOS ============
let abonos = [];
let selectedAbonoMethod = 'cash';

function saveAbonos()      { sbSave('abonos', abonos); }

function openAbonoModal() {
    document.getElementById('abonoForm').reset();
    document.getElementById('abonoResta').value = '$0.00';
    document.getElementById('abonoModal').classList.add('active');
}
function closeAbonoModal() { document.getElementById('abonoModal').classList.remove('active'); }

function calcAbonoResta() {
    const total = parseFloat(document.getElementById('abonoTotal').value) || 0;
    const desc = parseFloat(document.getElementById('abonoDescuento').value) || 0;
    const anticipo = parseFloat(document.getElementById('abonoAnticipo').value) || 0;
    const totalDesc = total * (1 - desc / 100);
    document.getElementById('abonoResta').value = '$' + (totalDesc - anticipo).toFixed(2);
}

function selectAbonoMethod(btn, method) {
    selectedAbonoMethod = method;
    document.querySelectorAll('.abono-method-btn').forEach(b => { b.style.borderColor = '#E5E7EB'; b.style.background = 'white'; });
    btn.style.borderColor = '#C5A572'; btn.style.background = '#FFF9F0';
}

document.addEventListener('submit', function(e) {
    if (e.target.id !== 'abonoForm') return;
    e.preventDefault();
    const total = parseFloat(document.getElementById('abonoTotal').value) || 0;
    const desc = parseFloat(document.getElementById('abonoDescuento').value) || 0;
    const anticipo = parseFloat(document.getElementById('abonoAnticipo').value) || 0;
    const totalDesc = total * (1 - desc / 100);
    const abono = {
        id: Date.now(),
        folio: 'AB-' + String(abonos.length + 1).padStart(6, '0'),
        cliente: document.getElementById('abonoCliente').value,
        telefono: document.getElementById('abonoTelefono').value,
        redes: document.getElementById('abonoRedes').value,
        concepto: document.getElementById('abonoConcepto').value,
        total: totalDesc, descuento: desc,
        abonado: anticipo, resta: totalDesc - anticipo,
        notas: document.getElementById('abonoNotas').value,
        date: new Date().toISOString().split('T')[0],
        status: totalDesc - anticipo <= 0 ? 'pagado' : 'pendiente',
        historial: [{ fecha: new Date().toISOString().split('T')[0], monto: anticipo, metodo: 'Anticipo inicial' }]
    };
    abonos.push(abono); saveAbonos();
    if (anticipo > 0) { incomes.push({ id: Date.now(), concept: 'Anticipo ' + abono.folio, amount: anticipo, date: abono.date }); saveIncomes(); }
    renderAbonosTable(); closeAbonoModal(); alert('‚úÖ Venta en abonos registrada');
});

function renderAbonosTable() {
    const tbody = document.getElementById('abonosTable');
    if (!tbody) return;
    const pend = abonos.filter(a => a.status === 'pendiente').reduce((s, a) => s + a.resta, 0);
    const deuda = new Set(abonos.filter(a => a.status === 'pendiente').map(a => a.cliente)).size;
    const cobrado = abonos.reduce((s, a) => s + a.abonado, 0);
    document.getElementById('abonosTotalPendiente').textContent = '$' + pend.toFixed(2);
    document.getElementById('abonosClientesDeuda').textContent = deuda;
    document.getElementById('abonosTotalCobrado').textContent = '$' + cobrado.toFixed(2);
    if (abonos.length === 0) { tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-gray-400">No hay ventas en abonos registradas</td></tr>'; return; }
    tbody.innerHTML = abonos.map(a => {
        const badge = a.status === 'pagado' ? '<span class="badge-success">Pagado</span>' : '<span class="badge-warning">Pendiente</span>';
        const contacto = a.telefono ? `<a href="https://wa.me/52${a.telefono.replace(/\D/g,'')}" target="_blank" class="text-green-600 text-xs"><i class="fab fa-whatsapp mr-1"></i>${a.telefono}</a>` : (a.redes || '-');
        return `<tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-semibold" style="color:#C5A572;">${a.folio}</td>
            <td class="px-4 py-3 text-sm font-semibold">${a.cliente}</td>
            <td class="px-4 py-3 text-sm">${contacto}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${a.concepto}</td>
            <td class="px-4 py-3 text-sm font-semibold">$${a.total.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm text-green-600 font-semibold">$${a.abonado.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm text-red-600 font-semibold">$${a.resta.toFixed(2)}</td>
            <td class="px-4 py-3">${badge}</td>
            <td class="px-4 py-3 flex gap-2">
                ${a.status === 'pendiente' ? `<button onclick="openRegistrarAbonoModal(${a.id})" class="text-green-600 hover:text-green-800 text-sm font-semibold"><i class="fas fa-plus-circle mr-1"></i>Abonar</button>` : ''}
                <button onclick="deleteAbono(${a.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash text-sm"></i></button>
            </td>
        </tr>`;
    }).join('');
}

function openRegistrarAbonoModal(id) {
    const a = abonos.find(x => x.id === id); if (!a) return;
    document.getElementById('abonoRegistrarId').value = id;
    document.getElementById('abonoDetalleInfo').innerHTML = `
        <div class="flex justify-between text-sm"><span class="text-gray-600">Cliente:</span><span class="font-semibold">${a.cliente}</span></div>
        <div class="flex justify-between text-sm"><span class="text-gray-600">Total:</span><span class="font-semibold">$${a.total.toFixed(2)}</span></div>
        <div class="flex justify-between text-sm"><span class="text-gray-600">Ya abonado:</span><span class="text-green-600 font-semibold">$${a.abonado.toFixed(2)}</span></div>
        <div class="flex justify-between text-sm font-bold border-t pt-2"><span>Resta:</span><span class="text-red-600">$${a.resta.toFixed(2)}</span></div>`;
    document.getElementById('abonoMonto').value = '';
    document.getElementById('registrarAbonoModal').classList.add('active');
}
function closeRegistrarAbonoModal() { document.getElementById('registrarAbonoModal').classList.remove('active'); }

document.addEventListener('submit', function(e) {
    if (e.target.id !== 'registrarAbonoForm') return;
    e.preventDefault();
    const id = parseInt(document.getElementById('abonoRegistrarId').value);
    const monto = parseFloat(document.getElementById('abonoMonto').value) || 0;
    const nota = document.getElementById('abonoNotaRegistro').value;
    const idx = abonos.findIndex(a => a.id === id); if (idx === -1) return;
    if (monto > abonos[idx].resta) { alert('El monto no puede ser mayor al saldo ($' + abonos[idx].resta.toFixed(2) + ')'); return; }
    abonos[idx].abonado += monto; abonos[idx].resta -= monto;
    abonos[idx].historial = abonos[idx].historial || [];
    abonos[idx].historial.push({ fecha: new Date().toISOString().split('T')[0], monto, metodo: selectedAbonoMethod, nota });
    if (abonos[idx].resta <= 0) { abonos[idx].resta = 0; abonos[idx].status = 'pagado'; }
    incomes.push({ id: Date.now(), concept: 'Abono ' + abonos[idx].folio + ' - ' + abonos[idx].cliente, amount: monto, date: new Date().toISOString().split('T')[0] });
    saveAbonos(); saveIncomes(); renderAbonosTable(); closeRegistrarAbonoModal(); alert('‚úÖ Abono registrado');
});

function deleteAbono(id) {
    if (confirm('¬øEliminar esta venta en abonos?')) { abonos = abonos.filter(a => a.id !== id); saveAbonos(); renderAbonosTable(); }
}

// ============ PEDIDOS POR ENCARGO ============
let pedidos = [];
let pedidoFiltroActual = 'todos';

function savePedidos()     { sbSave('pedidos', pedidos); }

function openPedidoModal(editId = null) {
    document.getElementById('pedidoForm').reset();
    document.getElementById('editPedidoId').value = '';
    document.getElementById('pedidoModalTitle').textContent = 'Nuevo Pedido por Encargo';
    document.getElementById('pedidoSubmitBtn').textContent = 'Guardar Pedido';
    document.getElementById('pedidoTotalDisplay').textContent = '$0.00';
    document.getElementById('pedidoSaldo').value = '';
    document.getElementById('pedidoFecha').value = new Date().toISOString().split('T')[0];
    if (editId) {
        const p = pedidos.find(x => x.id === editId); if (!p) return;
        document.getElementById('editPedidoId').value = editId;
        document.getElementById('pedidoModalTitle').textContent = 'Editar Pedido';
        document.getElementById('pedidoSubmitBtn').textContent = 'Actualizar Pedido';
        document.getElementById('pedidoCliente').value = p.cliente;
        document.getElementById('pedidoTelefono').value = p.telefono || '';
        document.getElementById('pedidoRedes').value = p.redes || '';
        document.getElementById('pedidoFecha').value = p.fecha;
        document.getElementById('pedidoEntrega').value = p.entrega;
        document.getElementById('pedidoConcepto').value = p.concepto;
        document.getElementById('pedidoCantidad').value = p.cantidad;
        document.getElementById('pedidoCosto').value = p.costo;
        document.getElementById('pedidoAnticipo').value = p.anticipo;
        document.getElementById('pedidoNotas').value = p.notas || '';
        calcPedidoTotal();
    }
    document.getElementById('pedidoModal').classList.add('active');
}
function closePedidoModal() { document.getElementById('pedidoModal').classList.remove('active'); }

function calcPedidoTotal() {
    const cant = parseFloat(document.getElementById('pedidoCantidad').value) || 1;
    const costo = parseFloat(document.getElementById('pedidoCosto').value) || 0;
    const anticipo = parseFloat(document.getElementById('pedidoAnticipo').value) || 0;
    const total = cant * costo;
    document.getElementById('pedidoTotalDisplay').textContent = '$' + total.toFixed(2);
    document.getElementById('pedidoSaldo').value = '$' + (total - anticipo).toFixed(2);
}

document.addEventListener('submit', function(e) {
    if (e.target.id !== 'pedidoForm') return;
    e.preventDefault();
    const editId = document.getElementById('editPedidoId').value;
    const cant = parseFloat(document.getElementById('pedidoCantidad').value) || 1;
    const costo = parseFloat(document.getElementById('pedidoCosto').value) || 0;
    const anticipo = parseFloat(document.getElementById('pedidoAnticipo').value) || 0;
    const total = cant * costo;
    const data = {
        cliente: document.getElementById('pedidoCliente').value,
        telefono: document.getElementById('pedidoTelefono').value,
        redes: document.getElementById('pedidoRedes').value,
        fecha: document.getElementById('pedidoFecha').value,
        entrega: document.getElementById('pedidoEntrega').value,
        concepto: document.getElementById('pedidoConcepto').value,
        cantidad: cant, costo, anticipo, total,
        resta: total - anticipo,
        notas: document.getElementById('pedidoNotas').value,
        status: 'confirmado'
    };
    if (editId) {
        const idx = pedidos.findIndex(p => p.id === parseInt(editId));
        if (idx !== -1) { pedidos[idx] = { ...pedidos[idx], ...data }; }
    } else {
        data.id = Date.now();
        data.folio = 'PED-' + String(pedidos.length + 1).padStart(6, '0');
        data.fechaCreacion = new Date().toISOString().split('T')[0];
        if (anticipo > 0) { incomes.push({ id: Date.now(), concept: 'Anticipo ' + data.folio, amount: anticipo, date: data.fecha }); saveIncomes(); }
        pedidos.push(data);
    }
    savePedidos(); renderPedidosTable(); closePedidoModal();
    alert(editId ? '‚úÖ Pedido actualizado' : '‚úÖ Pedido registrado');
});

function renderPedidosTable(filtro = pedidoFiltroActual) {
    pedidoFiltroActual = filtro;
    const activos = pedidos.filter(p => p.status !== 'finalizado');
    document.getElementById('pedidosActivos').textContent = activos.length;
    document.getElementById('pedidosPorCobrar').textContent = '$' + activos.reduce((s, p) => s + p.resta, 0).toFixed(2);
    document.getElementById('pedidosAnticipos').textContent = '$' + activos.reduce((s, p) => s + p.anticipo, 0).toFixed(2);
    const mes = new Date().toISOString().slice(0, 7);
    document.getElementById('pedidosMes').textContent = activos.filter(p => p.entrega && p.entrega.startsWith(mes)).length;
    let lista = filtro === 'todos' ? activos : activos.filter(p => p.status === filtro);
    const tbody = document.getElementById('pedidosTable');
    if (!tbody) return;
    if (lista.length === 0) { tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-12 text-center text-gray-400">No hay pedidos</td></tr>'; return; }
    const labels = { confirmado: '‚úÖ Confirmado', pago: 'üí∞ Pago', produccion: 'üîß Producci√≥n', envio: 'üì¶ Env√≠o', salida: 'üöö Sali√≥', retirar: 'üè™ Retirar' };
    tbody.innerHTML = lista.map(p => {
        const hoy = new Date().toISOString().split('T')[0];
        const vencido = p.entrega && p.entrega < hoy;
        const contacto = p.telefono ? `<a href="https://wa.me/52${p.telefono.replace(/\D/g,'')}" target="_blank" class="text-green-600 text-xs"><i class="fab fa-whatsapp"></i> ${p.telefono}</a>` : (p.redes || '-');
        return `<tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-semibold" style="color:#C5A572;">${p.folio}</td>
            <td class="px-4 py-3"><p class="font-semibold text-sm">${p.cliente}</p><p class="text-xs text-gray-500">${contacto}</p></td>
            <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate">${p.concepto}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${p.fecha}</td>
            <td class="px-4 py-3 text-sm font-semibold ${vencido ? 'text-red-600' : 'text-gray-800'}">${p.entrega} ${vencido ? '‚ö†Ô∏è' : ''}</td>
            <td class="px-4 py-3 text-sm font-semibold">$${p.total.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm text-green-600 font-semibold">$${p.anticipo.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm text-red-600 font-semibold">$${p.resta.toFixed(2)}</td>
            <td class="px-4 py-3"><span class="text-xs font-semibold px-2 py-1 rounded-full bg-gray-100">${labels[p.status] || p.status}</span></td>
            <td class="px-4 py-3 flex gap-2 items-center">
                <button onclick="openPedidoStatusModal(${p.id})" class="text-blue-600 hover:text-blue-800" title="Estado"><i class="fas fa-exchange-alt"></i></button>
                <button onclick="openPedidoModal(${p.id})" class="text-yellow-500 hover:text-yellow-700" title="Editar"><i class="fas fa-edit"></i></button>
                <button onclick="deletePedido(${p.id})" class="text-red-500 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');
}

function filterPedidos(filtro, btn) {
    document.querySelectorAll('.pedido-filter').forEach(b => { b.style.borderColor = '#E5E7EB'; b.style.background = 'white'; b.style.color = '#4B5563'; });
    btn.style.borderColor = '#C5A572'; btn.style.background = '#FFF9F0'; btn.style.color = '#C5A572';
    renderPedidosTable(filtro);
}

function openPedidoStatusModal(id) {
    document.getElementById('pedidoStatusId').value = id;
    const p = pedidos.find(x => x.id === id);
    document.getElementById('pedidoStatusFolio').textContent = p ? p.folio : '';
    document.getElementById('pedidoStatusModal').classList.add('active');
}
function closePedidoStatusModal() { document.getElementById('pedidoStatusModal').classList.remove('active'); }

function setPedidoStatus(status) {
    const id = parseInt(document.getElementById('pedidoStatusId').value);
    const idx = pedidos.findIndex(p => p.id === id); if (idx === -1) return;
    if (status === 'finalizado') {
        if (!confirm('¬øFinalizar este pedido? Pasar√° al historial de ventas.')) return;
        const p = pedidos[idx];
        salesHistory.push({
            id: Date.now(), folio: p.folio,
            date: new Date().toISOString().split('T')[0],
            time: new Date().toLocaleTimeString('es-MX'),
            customer: p.cliente, concept: p.concepto, note: p.notas || '',
            products: [{ name: p.concepto, price: p.total, quantity: 1, cost: 0 }],
            subtotal: p.total, discount: 0, tax: 0, total: p.total,
            method: 'Pedido finalizado', type: 'pedido'
        });
        if (p.resta > 0) { incomes.push({ id: Date.now(), concept: 'Liquidaci√≥n ' + p.folio, amount: p.resta, date: new Date().toISOString().split('T')[0] }); saveIncomes(); }
        pedidos.splice(idx, 1);
        savePedidos(); saveSalesHistory();
    } else {
        pedidos[idx].status = status; savePedidos();
    }
    renderPedidosTable(); closePedidoStatusModal();
    alert(status === 'finalizado' ? 'üéâ Pedido finalizado y agregado al historial' : '‚úÖ Estado actualizado');
}

function deletePedido(id) {
    if (confirm('¬øEliminar este pedido?')) { pedidos = pedidos.filter(p => p.id !== id); savePedidos(); renderPedidosTable(); }
}

// ============ EDITAR PRODUCTOS (FIX) ============
function editProduct(id) {
    const p = products.find(x => x.id === id); if (!p) return;
    currentVariants = [...(p.variants || [])];
    currentProductImage = null;
    document.getElementById('editProductId').value = id;
    document.getElementById('productModalTitle').textContent = 'Editar Producto';
    document.getElementById('productSubmitBtn').textContent = 'Actualizar Producto';
    document.getElementById('productName').value = p.name;
    document.getElementById('productSKU').value = p.sku || '';
    updateCategorySelects();
    setTimeout(() => { document.getElementById('productCategory').value = p.category; }, 80);
    document.getElementById('productCost').value = p.cost;
    document.getElementById('productPrice').value = p.price;
    document.getElementById('productStock').value = p.stock;
    if (p.imageUrl) { document.getElementById('previewImg').src = p.imageUrl; document.getElementById('imagePreview').classList.remove('hidden'); }
    else { document.getElementById('imagePreview').classList.add('hidden'); }
    renderVariantsList();
    document.getElementById('addProductModal').classList.add('active');
}

// Inicializar nuevas secciones al cargar

    </script>
<!-- MODAL: Nueva Venta en Abonos -->
<div id="abonoModal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-8 animate-fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Nueva Venta en Abonos</h3>
            <button onclick="closeAbonoModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="abonoForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Cliente *</label><input type="text" id="abonoCliente" required class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono / WhatsApp</label><input type="text" id="abonoTelefono" placeholder="Ej: 81 1234 5678" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            </div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Facebook / Instagram</label><input type="text" id="abonoRedes" placeholder="@usuario o link de perfil" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
<!-- Selector de productos del inventario para Abono -->
<div>
  <label class="block text-sm font-semibold text-gray-700 mb-2">Productos del Inventario</label>
  <div class="flex gap-2 mb-2">
    <select id="abonoProductoSelect" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl outline-none">
      <option value="">-- Seleccionar producto --</option>
    </select>
    <input type="number" id="abonoProductoCantidad" placeholder="Cant." min="1" value="1" class="w-24 px-3 py-3 border border-gray-200 rounded-xl outline-none">
    <button type="button" onclick="agregarProductoAbono()" class="px-4 py-3 text-white rounded-xl font-semibold" style="background:#C5A572">Agregar</button>
  </div>
  <div id="abonoProductosList" class="space-y-2 max-h-40 overflow-y-auto"></div>
</div>
<div><label class="block text-sm font-semibold text-gray-700 mb-2">Concepto *</label><input type="text" id="abonoConcepto" required placeholder="¬øQu√© se vendi√≥?" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Total de la Venta *</label><input type="number" id="abonoTotal" required step="0.01" min="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" oninput="calcAbonoResta()"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Descuento (%)</label><input type="number" id="abonoDescuento" value="0" min="0" max="100" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" oninput="calcAbonoResta()"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Anticipo Inicial *</label><input type="number" id="abonoAnticipo" required step="0.01" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" oninput="calcAbonoResta()"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Saldo Pendiente</label><input type="text" id="abonoResta" readonly class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none bg-gray-50 font-bold text-red-600"></div>
            </div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Notas</label><textarea id="abonoNotas" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none resize-none"></textarea></div>
            <button type="submit" class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg"><i class="fas fa-save mr-2"></i>Registrar Venta en Abonos</button>
        </form>
    </div>
</div>

<!-- MODAL: Registrar Abono -->
<div id="registrarAbonoModal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Registrar Abono</h3>
            <button onclick="closeRegistrarAbonoModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div id="abonoDetalleInfo" class="bg-gray-50 rounded-xl p-4 mb-4 space-y-2 text-sm"></div>
        <form id="registrarAbonoForm" class="space-y-4">
            <input type="hidden" id="abonoRegistrarId">
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Monto del Abono *</label><input type="number" id="abonoMonto" required step="0.01" min="0.01" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none text-xl font-bold"></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">M√©todo de Pago</label>
                <div class="grid grid-cols-3 gap-2">
                    <button type="button" onclick="selectAbonoMethod(this,'cash')" class="abono-method-btn border-2 rounded-xl py-3 flex flex-col items-center cursor-pointer" style="border-color:#C5A572;background:#FFF9F0;"><i class="fas fa-money-bill-wave text-green-600 text-xl mb-1"></i><p class="text-xs font-semibold">Efectivo</p></button>
                    <button type="button" onclick="selectAbonoMethod(this,'card')" class="abono-method-btn border-2 border-gray-200 rounded-xl py-3 flex flex-col items-center cursor-pointer"><i class="fas fa-credit-card text-blue-600 text-xl mb-1"></i><p class="text-xs font-semibold">Tarjeta</p></button>
                    <button type="button" onclick="selectAbonoMethod(this,'transfer')" class="abono-method-btn border-2 border-gray-200 rounded-xl py-3 flex flex-col items-center cursor-pointer"><i class="fas fa-exchange-alt text-purple-600 text-xl mb-1"></i><p class="text-xs font-semibold">Transfer.</p></button>
                </div>
            </div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nota</label><input type="text" id="abonoNotaRegistro" placeholder="Nota opcional" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            <button type="submit" class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg"><i class="fas fa-check mr-2"></i>Confirmar Abono</button>
        </form>
    </div>
</div>

<!-- MODAL: Nuevo/Editar Pedido -->
<div id="pedidoModal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-8 animate-fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800" id="pedidoModalTitle">Nuevo Pedido</h3>
            <button onclick="closePedidoModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="pedidoForm" class="space-y-4">
            <input type="hidden" id="editPedidoId">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Cliente *</label><input type="text" id="pedidoCliente" required class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono / WhatsApp</label><input type="text" id="pedidoTelefono" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            </div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Facebook / Instagram</label><input type="text" id="pedidoRedes" placeholder="@usuario o link" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Fecha del Pedido *</label><input type="date" id="pedidoFecha" required class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Entrega *</label><input type="date" id="pedidoEntrega" required class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            </div>
            <!-- Selector de productos del inventario para Pedido -->
<div>
  <label class="block text-sm font-semibold text-gray-700 mb-2">Productos del Inventario (opcional)</label>
  <div class="flex gap-2 mb-2">
    <select id="pedidoProductoSelect" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl outline-none">
      <option value="">-- Seleccionar producto --</option>
    </select>
    <input type="number" id="pedidoProductoCantidad" placeholder="Cant." min="1" value="1" class="w-24 px-3 py-3 border border-gray-200 rounded-xl outline-none">
    <button type="button" onclick="agregarProductoPedido()" class="px-4 py-3 text-white rounded-xl font-semibold" style="background:#C5A572">Agregar</button>
  </div>
  <div id="pedidoProductosList" class="space-y-2 max-h-40 overflow-y-auto"></div>
</div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">¬øQu√© pidieron? *</label><textarea id="pedidoConcepto" required rows="3" placeholder="Describe el pedido detalladamente..." class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none resize-none"></textarea></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Cantidad</label><input type="number" id="pedidoCantidad" value="1" min="1" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" oninput="calcPedidoTotal()"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Costo Unitario *</label><input type="number" id="pedidoCosto" required step="0.01" min="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" oninput="calcPedidoTotal()"></div>
            </div>
            <div class="bg-gray-50 rounded-xl p-4 space-y-3">
                <div class="flex justify-between text-sm"><span class="text-gray-600">Total del pedido:</span><span class="font-bold text-lg" id="pedidoTotalDisplay">$0.00</span></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-semibold text-gray-700 mb-1">Anticipo Recibido</label><input type="number" id="pedidoAnticipo" step="0.01" min="0" value="0" class="w-full px-3 py-2 border border-gray-200 rounded-xl outline-none" oninput="calcPedidoTotal()"></div>
                    <div><label class="block text-xs font-semibold text-gray-700 mb-1">Saldo Pendiente</label><input type="text" id="pedidoSaldo" readonly class="w-full px-3 py-2 bg-white border border-gray-200 rounded-xl font-bold text-red-600"></div>
                </div>
            </div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Notas adicionales</label><textarea id="pedidoNotas" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none resize-none"></textarea></div>
            <button type="submit" class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg"><i class="fas fa-save mr-2"></i><span id="pedidoSubmitBtn">Guardar Pedido</span></button>
        </form>
    </div>
</div>

<!-- MODAL: Estado del Pedido -->
<div id="pedidoStatusModal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Cambiar Estado del Pedido</h3>
            <button onclick="closePedidoStatusModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <input type="hidden" id="pedidoStatusId">
        <p class="text-sm text-gray-500 mb-4">Pedido: <span id="pedidoStatusFolio" class="font-bold" style="color:#C5A572;"></span></p>
        <div class="space-y-2">
            <button onclick="setPedidoStatus('confirmado')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-yellow-300 cursor-pointer text-left bg-white"><span class="text-2xl">‚úÖ</span><p class="font-semibold">Confirmado</p></button>
            <button onclick="setPedidoStatus('pago')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-green-300 cursor-pointer text-left bg-white"><span class="text-2xl">üí∞</span><p class="font-semibold">Pago</p></button>
            <button onclick="setPedidoStatus('produccion')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-blue-300 cursor-pointer text-left bg-white"><span class="text-2xl">üîß</span><p class="font-semibold">En Producci√≥n</p></button>
            <button onclick="setPedidoStatus('envio')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-purple-300 cursor-pointer text-left bg-white"><span class="text-2xl">üì¶</span><p class="font-semibold">En Env√≠o</p></button>
            <button onclick="setPedidoStatus('salida')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-orange-300 cursor-pointer text-left bg-white"><span class="text-2xl">üöö</span><p class="font-semibold">Sali√≥ a Entregar</p></button>
            <button onclick="setPedidoStatus('retirar')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-teal-300 cursor-pointer text-left bg-white"><span class="text-2xl">üè™</span><p class="font-semibold">Listo para Retirar</p></button>
            <button onclick="setPedidoStatus('finalizado')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-emerald-300 bg-emerald-50 cursor-pointer text-left"><span class="text-2xl">üéâ</span><p class="font-semibold text-emerald-700">Finalizado ‚Üí pasa a Historial</p></button>
        </div>
    </div>
</div>
<script>
// ============================================================
// PRODUCTOS EN ABONO
// ============================================================
let abonoProductosSeleccionados = [];

function poblarSelectAbono() {
    const sel = document.getElementById('abonoProductoSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Seleccionar producto --</option>';
    products.filter(p => p.stock > 0).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name + ' (Stock: ' + p.stock + ') - $' + p.price;
        sel.appendChild(opt);
    });
}

function agregarProductoAbono() {
    const sel = document.getElementById('abonoProductoSelect');
    const cantInput = document.getElementById('abonoProductoCantidad');
    const pid = sel.value;
    const cant = parseInt(cantInput.value) || 1;
    if (!pid) return alert('Selecciona un producto');
    const prod = products.find(p => String(p.id) === String(pid));
    if (!prod) return;
    if (cant > prod.stock) return alert('Stock insuficiente. Disponible: ' + prod.stock);
    const existing = abonoProductosSeleccionados.find(x => String(x.id) === String(pid));
    if (existing) {
        if (existing.quantity + cant > prod.stock) return alert('Stock insuficiente.');
        existing.quantity += cant;
    } else {
        abonoProductosSeleccionados.push({ id: prod.id, name: prod.name, price: prod.price, quantity: cant });
    }
    renderAbonoProductosList();
    const total = abonoProductosSeleccionados.reduce((s, x) => s + x.price * x.quantity, 0);
    document.getElementById('abonoTotal').value = total.toFixed(2);
    calcAbonoResta();
}

function renderAbonoProductosList() {
    const container = document.getElementById('abonoProductosList');
    if (!container) return;
    if (abonoProductosSeleccionados.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm">Sin productos seleccionados</p>';
        return;
    }
    container.innerHTML = abonoProductosSeleccionados.map((item, i) => '<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm"><span class="font-medium">' + item.name + '</span><span class="text-gray-500">x' + item.quantity + ' ‚Äî $' + (item.price * item.quantity).toFixed(2) + '</span><button type="button" onclick="quitarProductoAbono(' + i + ')" class="text-red-400 hover:text-red-600 ml-2"><i class="fas fa-times"></i></button></div>').join('');
}

function quitarProductoAbono(index) {
    abonoProductosSeleccionados.splice(index, 1);
    renderAbonoProductosList();
    const total = abonoProductosSeleccionados.reduce((s, x) => s + x.price * x.quantity, 0);
    if (total > 0) { document.getElementById('abonoTotal').value = total.toFixed(2); calcAbonoResta(); }
}

// ============================================================
// PRODUCTOS EN PEDIDO
// ============================================================
let pedidoProductosSeleccionados = [];

function poblarSelectPedido() {
    const sel = document.getElementById('pedidoProductoSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Seleccionar producto --</option>';
    products.filter(p => p.stock > 0).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name + ' (Stock: ' + p.stock + ') - $' + p.price;
        sel.appendChild(opt);
    });
}

function agregarProductoPedido() {
    const sel = document.getElementById('pedidoProductoSelect');
    const cantInput = document.getElementById('pedidoProductoCantidad');
    const pid = sel.value;
    const cant = parseInt(cantInput.value) || 1;
    if (!pid) return alert('Selecciona un producto');
    const prod = products.find(p => String(p.id) === String(pid));
    if (!prod) return;
    if (cant > prod.stock) return alert('Stock insuficiente. Disponible: ' + prod.stock);
    const existing = pedidoProductosSeleccionados.find(x => String(x.id) === String(pid));
    if (existing) {
        existing.quantity += cant;
    } else {
        pedidoProductosSeleccionados.push({ id: prod.id, name: prod.name, price: prod.price, quantity: cant });
    }
    renderPedidoProductosList();
    const total = pedidoProductosSeleccionados.reduce((s, x) => s + x.price * x.quantity, 0);
    if (total > 0) {
        document.getElementById('pedidoCosto').value = (total / (parseInt(document.getElementById('pedidoCantidad').value) || 1)).toFixed(2);
        calcPedidoTotal();
    }
}

function renderPedidoProductosList() {
    const container = document.getElementById('pedidoProductosList');
    if (!container) return;
    if (pedidoProductosSeleccionados.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm">Sin productos seleccionados</p>';
        return;
    }
    container.innerHTML = pedidoProductosSeleccionados.map((item, i) => '<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm"><span class="font-medium">' + item.name + '</span><span class="text-gray-500">x' + item.quantity + ' ‚Äî $' + (item.price * item.quantity).toFixed(2) + '</span><button type="button" onclick="quitarProductoPedido(' + i + ')" class="text-red-400 hover:text-red-600 ml-2"><i class="fas fa-times"></i></button></div>').join('');
}

function quitarProductoPedido(index) {
    pedidoProductosSeleccionados.splice(index, 1);
    renderPedidoProductosList();
}

// ============================================================
// HOOK: poblar selects al abrir modales
// ============================================================
const _origOpenAbonoModal = openAbonoModal;
openAbonoModal = function() {
    abonoProductosSeleccionados = [];
    _origOpenAbonoModal();
    poblarSelectAbono();
    renderAbonoProductosList();
};

const _origOpenPedidoModal = openPedidoModal;
openPedidoModal = function(editId) {
    pedidoProductosSeleccionados = [];
    _origOpenPedidoModal(editId || null);
    poblarSelectPedido();
    renderPedidoProductosList();
};

// ============================================================
// HOOK: descontar stock y registrar en salesHistory al guardar abono
// ============================================================
document.addEventListener('submit', function(e) {
    if (e.target.id !== 'abonoForm') return;
    // Descontar stock
    abonoProductosSeleccionados.forEach(item => {
        const prod = products.find(p => String(p.id) === String(item.id));
        if (prod) prod.stock -= item.quantity;
    });
    if (abonoProductosSeleccionados.length > 0) saveProducts();

    // Registrar en salesHistory
    setTimeout(function() {
        const lastAbono = abonos[abonos.length - 1];
        if (lastAbono) {
            const saleRecord = {
                id: 'AB-' + Date.now(),
                folio: lastAbono.folio || ('AB-' + abonos.length),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('es-MX'),
                customer: lastAbono.cliente,
                concept: lastAbono.concepto,
                products: abonoProductosSeleccionados.length > 0
                    ? [...abonoProductosSeleccionados]
                    : [{ id: 'abono', name: lastAbono.concepto, price: lastAbono.total, quantity: 1 }],
                subtotal: lastAbono.total,
                discount: 0,
                tax: 0,
                total: lastAbono.total,
                method: 'Abono',
                type: 'abono'
            };
            salesHistory.push(saleRecord);
            saveSalesHistory();
        }
        abonoProductosSeleccionados = [];
    }, 200);
});

// ============================================================
// HOOK: descontar stock al marcar pedido como Entregado/Finalizado
// ============================================================
const _origSetPedidoStatus = setPedidoStatus;
setPedidoStatus = function(id, status) {
    if (status === 'entregado' || status === 'finalizado') {
        const p = pedidos.find(x => x.id === id);
        if (p && p.productosInventario && p.productosInventario.length > 0) {
            p.productosInventario.forEach(item => {
                const prod = products.find(pr => String(pr.id) === String(item.id));
                if (prod) prod.stock -= item.quantity;
            });
            saveProducts();
            const saleRecord = {
                id: 'PE-' + Date.now(),
                folio: p.folio || ('PE-' + id),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('es-MX'),
                customer: p.cliente,
                concept: p.concepto,
                products: [...p.productosInventario],
                subtotal: p.total,
                discount: 0,
                tax: 0,
                total: p.total,
                method: 'Pedido',
                type: 'pedido'
            };
            salesHistory.push(saleRecord);
            saveSalesHistory();
        }
    }
    _origSetPedidoStatus(id, status);
};

// ============================================================
// HOOK: guardar productos seleccionados en pedido al submit
// ============================================================
document.addEventListener('submit', function(e) {
    if (e.target.id !== 'pedidoForm') return;
    setTimeout(function() {
        const lastPedido = pedidos[pedidos.length - 1];
        if (lastPedido && pedidoProductosSeleccionados.length > 0) {
            lastPedido.productosInventario = [...pedidoProductosSeleccionados];
            savePedidos();
        }
        pedidoProductosSeleccionados = [];
    }, 200);
});

// ============================================================
// REPORTES: parchar para incluir abonos y pedidos
// ============================================================
const _origRenderTopProducts = renderTopProducts;
renderTopProducts = function() {
    if (salesHistory.length === 0) {
        const el = document.getElementById('topProductsList');
        if (el) el.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No hay ventas registradas a√∫n</p>';
        return;
    }
    const productSales = {};
    salesHistory.forEach(function(sale) {
        (sale.products || []).forEach(function(item) {
            if (!productSales[item.id]) {
                productSales[item.id] = { name: item.name, sales: 0, revenue: 0 };
            }
            productSales[item.id].sales += item.quantity;
            productSales[item.id].revenue += item.price * item.quantity;
        });
    });
    const topProducts = Object.values(productSales).sort((a, b) => b.revenue - a.revenue).slice(0, 4);
    const container = document.getElementById('topProductsList');
    if (!container) return;
    container.innerHTML = topProducts.map(function(product, index) {
        return '<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl"><div class="flex items-center gap-3"><div class="w-8 h-8 text-white rounded-full flex items-center justify-center font-bold text-sm" style="background:#C5A572">' + (index+1) + '</div><div><p class="font-semibold text-gray-800">' + product.name + '</p><p class="text-xs text-gray-500">' + product.sales + ' vendidos</p></div></div><span class="font-bold text-gray-800">$' + product.revenue.toFixed(0) + '</span></div>';
    }).join('') || '<p class="text-gray-400 text-sm text-center py-4">Sin datos</p>';
};

const _origRenderSalesHistory = renderSalesHistory;
renderSalesHistory = function() {
    const tbody = document.getElementById('salesHistoryTable');
    if (!tbody) return;
    if (salesHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400">No hay ventas registradas</td></tr>';
        return;
    }
    tbody.innerHTML = salesHistory.slice(-20).reverse().map(function(sale) {
        const typeLabel = sale.type === 'abono' ? 'üü° Abono' : sale.type === 'pedido' ? 'üü£ Pedido' : 'üü¢ POS';
        const methodColor = sale.method === 'Efectivo' ? 'text-green-600' : sale.method === 'Tarjeta' ? 'text-blue-600' : sale.method === 'Abono' ? 'text-yellow-600' : sale.method === 'Pedido' ? 'text-purple-600' : 'text-gray-600';
        return '<tr class="hover:bg-gray-50"><td class="px-6 py-3 text-gray-800">' + sale.date + '</td><td class="px-6 py-3 text-gray-800">' + sale.customer + ' <span class="text-xs ' + methodColor + '">' + typeLabel + '</span></td><td class="px-6 py-3 text-gray-600">' + (sale.products || []).length + ' item(s)</td><td class="px-6 py-3"><span class="text-xs ' + methodColor + '">' + sale.method + '</span></td><td class="px-6 py-3 text-gray-800 font-semibold">$' + sale.total.toFixed(2) + '</td></tr>';
    }).join('');
};

const _origUpdateMonthlyStats = updateMonthlyStats;
updateMonthlyStats = function() {
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const monthlySales = salesHistory
        .filter(function(s) { const d = new Date(s.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; })
        .reduce(function(sum, s) { return sum + s.total; }, 0);
    const monthlyUnits = salesHistory
        .filter(function(s) { const d = new Date(s.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; })
        .reduce(function(sum, s) { return sum + (s.products || []).reduce(function(a, p) { return a + p.quantity; }, 0); }, 0);
    const monthlyProfit = monthlySales * 0.4;
    const elSales = document.getElementById('monthlySales');
    const elProfit = document.getElementById('monthlyProfit');
    const elUnits = document.getElementById('monthlyUnitsSold');
    if (elSales) elSales.textContent = '$' + monthlySales.toFixed(2);
    if (elProfit) elProfit.textContent = '$' + monthlyProfit.toFixed(2);
    if (elUnits) elUnits.textContent = monthlyUnits + ' unidades';
};

const _origUpdatePaymentMethods = updatePaymentMethods;
updatePaymentMethods = function() {
    const totalSales = salesHistory.length;
    const elCash = document.getElementById('cashPercentage');
    const elCard = document.getElementById('cardPercentage');
    const elTransfer = document.getElementById('transferPercentage');
    if (totalSales === 0) {
        if (elCash) elCash.textContent = '0%';
        if (elCard) elCard.textContent = '0%';
        if (elTransfer) elTransfer.textContent = '0%';
        return;
    }
    const cashSales = salesHistory.filter(function(s) { return s.method === 'Efectivo'; }).length;
    const cardSales = salesHistory.filter(function(s) { return s.method === 'Tarjeta'; }).length;
    const transferSales = salesHistory.filter(function(s) { return s.method === 'Transferencia'; }).length;
    if (elCash) elCash.textContent = ((cashSales/totalSales)*100).toFixed(0) + '%';
    if (elCard) elCard.textContent = ((cardSales/totalSales)*100).toFixed(0) + '%';
    if (elTransfer) elTransfer.textContent = ((transferSales/totalSales)*100).toFixed(0) + '%';
};

// ============================================================
// DESCARGA DE REPORTE CSV
// ============================================================
function descargarReporteVentas() {
    if (salesHistory.length === 0) return alert('No hay ventas para exportar.');
    const headers = ['Folio','Fecha','Hora','Cliente','Tipo','Productos','Total','M√©todo'];
    const rows = salesHistory.map(function(s) {
        return [
            s.folio || s.id,
            s.date,
            s.time || '',
            '"' + s.customer + '"',
            s.type === 'abono' ? 'Abono' : s.type === 'pedido' ? 'Pedido' : 'POS',
            '"' + (s.products || []).map(function(p) { return p.name + ' x' + p.quantity; }).join('; ') + '"',
            s.total.toFixed(2),
            s.method || ''
        ];
    });
    const csvContent = [headers.join(',')].concat(rows.map(function(r) { return r.join(','); })).join('\n');
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'Reporte_Ventas_Maneki_' + new Date().toISOString().split('T')[0] + '.csv';
    link.click();
    URL.revokeObjectURL(url);
}

// ============================================================
// FIX: EDITAR PRODUCTO (con flag modoEdicion, sin conflictos)
// ============================================================
let modoEdicion = false;
let edicionProductoId = null;

editProduct = function(id) {
    const p = products.find(function(x) { return x.id === id; });
    if (!p) return;

    modoEdicion = true;
    edicionProductoId = id;

    document.getElementById('addProductForm').reset();
    currentVariants = Array.isArray(p.variants) ? [...p.variants] : [];
    currentProductImage = p.imageUrl || null;

    document.getElementById('productName').value = p.name;
    document.getElementById('productCategory').value = p.category;
    document.getElementById('productCost').value = p.cost;
    document.getElementById('productPrice').value = p.price;
    document.getElementById('productStock').value = p.stock;
    document.getElementById('productSKU').value = p.sku || '';

    if (p.imageUrl) {
        const preview = document.getElementById('imagePreview');
        if (preview) { preview.src = p.imageUrl; preview.classList.remove('hidden'); }
    }

    renderVariantsList();

    const modalTitle = document.querySelector('#addProductModal h3');
    if (modalTitle) modalTitle.textContent = 'Editar Producto';
    const submitBtn = document.querySelector('#addProductForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Guardar Cambios';

    document.getElementById('addProductModal').classList.add('active');
};

const _origCloseAddProductModal = closeAddProductModal;
closeAddProductModal = function() {
    modoEdicion = false;
    edicionProductoId = null;
    const modalTitle = document.querySelector('#addProductModal h3');
    if (modalTitle) modalTitle.textContent = 'Nuevo Producto';
    const submitBtn = document.querySelector('#addProductForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Agregar Producto';
    _origCloseAddProductModal();
};

document.getElementById('addProductForm').addEventListener('submit', function(e) {
    if (!modoEdicion) return;
    e.preventDefault();
    e.stopImmediatePropagation();

    const idx = products.findIndex(function(x) { return x.id === edicionProductoId; });
    if (idx === -1) return;

    const categoryId = document.getElementById('productCategory').value;
    const category = categories.find(function(c) { return c.id === categoryId; });
    const sku = document.getElementById('productSKU').value.trim() || products[idx].sku;

    products[idx] = Object.assign({}, products[idx], {
        name: document.getElementById('productName').value,
        category: categoryId,
        cost: parseFloat(document.getElementById('productCost').value) || 0,
        price: parseFloat(document.getElementById('productPrice').value) || 0,
        stock: parseInt(document.getElementById('productStock').value) || 0,
        sku: sku,
        image: category ? category.emoji : products[idx].image,
        imageUrl: currentProductImage || products[idx].imageUrl,
        variants: [...currentVariants]
    });

    saveProducts();
    renderInventoryTable();
    renderProducts();
    updateDashboard();
    closeAddProductModal();
    alert('‚úÖ Producto actualizado correctamente');
}, true);

// ============================================================
// FIX: RECORDAR SECCI√ìN ACTIVA al recargar p√°gina
// ============================================================
const _origShowSection = showSection;
showSection = function(sectionName) {
    _origShowSection(sectionName);
    localStorage.setItem('maneki_activeSection', sectionName);
};

window.addEventListener('load', function() {
    const lastSection = localStorage.getItem('maneki_activeSection');
    if (lastSection) {
        try { showSection(lastSection); } catch(e) { showSection('dashboard'); }
    }
});

</script>
</body>
</html>function loadFromLocalStorage(key, defaultValue = []) { return defaultValue; } html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maneki Store - Sistema de Gesti√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        :root {
            --color-gold: #C5A572;
            --color-purple: #D8BFD8;
            --color-dark-purple: #9370DB;
            --color-light-purple: #E6D5E6;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(197, 165, 114, 0.2);
        }
        
        .product-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 16px rgba(197, 165, 114, 0.3);
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
        }
        
        .sidebar-item:hover {
            background: rgba(197, 165, 114, 0.1);
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, #C5A572 0%, #B8965F 100%);
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #C5A572 0%, #B8965F 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(197, 165, 114, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #D8BFD8 0%, #C8B0D8 100%);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(216, 191, 216, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
        }
        
        .badge-success {
            background: #10B981;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-warning {
            background: #F59E0B;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-danger {
            background: #EF4444;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-vip {
            background: linear-gradient(135deg, #C5A572, #D4AF37);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sidebar {
            transition: all 0.3s ease;
            background: linear-gradient(180deg, #FFFFFF 0%, #FAF9F7 100%);
        }
        
        .category-card {
            transition: all 0.2s ease;
        }
        
        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(197, 165, 114, 0.2);
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 12px;
        }
        
        .variant-tag {
            display: inline-block;
            background: #E6D5E6;
            padding: 4px 12px;
            border-radius: 8px;
            margin: 2px;
            font-size: 12px;
        }
        
        .receipt {
            background: white;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .receipt-header {
            text-align: center;
            border-bottom: 2px solid #C5A572;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .receipt-logo {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .receipt-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }
        
        .receipt-table th {
            background: #E6D5E6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .receipt-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        @media (max-width: 768px) {
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
        }
        
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 shadow-xl z-50 flex flex-col">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-xl flex items-center justify-center">
                        <span class="text-3xl">üê±</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold" style="color: #000;">Maneki Store</h1>
                        <p class="text-xs" style="color: #C5A572;">Regalos Personalizados</p>
                    </div>
                </div>
                <button id="closeSidebar" class="md:hidden text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="showSection('dashboard')" data-section="dashboard" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium">
                <i class="fas fa-home w-5"></i>
                <span>Dashboard</span>
            </button>
            <button onclick="showSection('pos')" data-section="pos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-cash-register w-5"></i>
                <span>Punto de Venta</span>
            </button>
            <button onclick="showSection('abonos')" data-section="abonos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
    <i class="fas fa-hand-holding-usd w-5"></i>
    <span>Ventas en Abonos</span>
</button>
<button onclick="showSection('pedidos')" data-section="pedidos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
    <i class="fas fa-clipboard-list w-5"></i>
    <span>Pedidos por Encargo</span>
</button>
            <button onclick="showSection('quotes')" data-section="quotes" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-file-invoice w-5"></i>
                <span>Cotizaciones</span>
            </button>
            <button onclick="showSection('inventory')" data-section="inventory" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-boxes w-5"></i>
                <span>Inventario</span>
            </button>
            <button onclick="showSection('balance')" data-section="balance" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-balance-scale w-5"></i>
                <span>Balance</span>
            </button>
            <button onclick="showSection('clientes')" data-section="clientes" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-users w-5"></i>
                <span>Clientes</span>
            </button>
            <button onclick="showSection('categorias')" data-section="categorias" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-tags w-5"></i>
                <span>Categor√≠as</span>
            </button>
            <button onclick="showSection('reportes')" data-section="reportes" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium text-gray-700">
                <i class="fas fa-chart-line w-5"></i>
                <span>Reportes</span>
            </button>
        </nav>
        
        <div class="p-4 border-t border-gray-200">
            <button onclick="exportData()" class="w-full mb-2 px-4 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-semibold hover:bg-green-200 transition-all">
                <i class="fas fa-download mr-2"></i>Exportar Datos
            </button>
            <button onclick="clearAllData()" class="w-full mb-3 px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-200 transition-all">
                <i class="fas fa-trash mr-2"></i>Borrar Todo
            </button>
            <div class="flex items-center gap-3 px-4 py-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: #E6D5E6;">
                    <i class="fas fa-user" style="color: #C5A572;"></i>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-semibold text-gray-800">Usuario Admin</p>
                    <p class="text-xs text-gray-500">admin@maneki.com</p>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Mobile Menu Button -->
    <button id="openSidebar" class="md:hidden fixed top-4 left-4 z-40 bg-white p-3 rounded-lg shadow-lg">
        <i class="fas fa-bars text-gray-700"></i>
    </button>
    
    <!-- Main Content -->
    <main class="md:ml-64 min-h-screen">
        
        <!-- DASHBOARD SECTION -->
        <section id="dashboard-section" class="p-4 md:p-8 animate-fade-in">
            <div class="max-w-7xl mx-auto">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard</h2>
                    <p class="text-gray-600">Bienvenido de vuelta, aqu√≠ est√° el resumen de hoy</p>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #E6D5E6;">
                                <i class="fas fa-dollar-sign text-xl" style="color: #C5A572;"></i>
                            </div>
                            <span class="text-green-600 text-sm font-semibold" id="salesTrend">+0%</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Ventas del D√≠a</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="dailySales">$0</h3>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #FFF9F0;">
                                <i class="fas fa-chart-line text-xl" style="color: #C5A572;"></i>
                            </div>
                            <span class="text-green-600 text-sm font-semibold" id="profitTrend">+0%</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Ganancia Neta</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="netProfit">$0</h3>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #FFF9F0;">
                                <i class="fas fa-box text-xl" style="color: #C5A572;"></i>
                            </div>
                            <span class="text-orange-600 text-sm font-semibold" id="lowStockBadge">0 items</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Productos Bajos</p>
                        <h3 class="text-3xl font-bold text-gray-800">Stock</h3>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #E6D5E6;">
                                <i class="fas fa-receipt text-xl" style="color: #C5A572;"></i>
                            </div>
                            <span class="text-red-600 text-sm font-semibold">Pendientes</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Cuentas por Cobrar</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="accountsReceivable">$0</h3>
                    </div>
                </div>
                
                <!-- Chart Section -->
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Ventas de la Semana</h3>
                    <canvas id="salesChart" height="80"></canvas>
                </div>
            </div>
        </section>
        
        <!-- POS SECTION -->
        <section id="pos-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Punto de Venta</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Products Grid -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <div class="mb-6">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="searchProduct" placeholder="Buscar productos..." 
                                           class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                                </div>
                            </div>
                            
                            <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[600px] overflow-y-auto">
                                <!-- Products will be inserted here by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ticket Section -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Ticket de Venta</h3>
                            
                            <!-- Customer Name -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Cliente</label>
                                <input type="text" id="customerName" placeholder="Nombre del cliente (opcional)"
                                       class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none text-sm">
                            </div>
                            
                            <div id="ticketItems" class="space-y-3 mb-6 max-h-[200px] overflow-y-auto">
                                <p class="text-gray-400 text-center py-8 text-sm">No hay productos agregados</p>
                            </div>
                            
                            <div class="border-t border-gray-200 pt-4 space-y-3 mb-4">
                                <div class="flex justify-between text-gray-600">
                                    <span>Subtotal:</span>
                                    <span id="subtotal">$0.00</span>
                                </div>
                                
                                <!-- Discount -->
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Descuento:</span>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="discountPercent" min="0" max="100" value="0" 
                                               class="w-16 px-2 py-1 border border-gray-200 rounded-lg text-sm text-right"
                                               onchange="updateTotals()">
                                        <span class="text-gray-600 text-sm">%</span>
                                        <span id="discountAmount" class="text-red-600 font-semibold">-$0.00</span>
                                    </div>
                                </div>
                                
                                <!-- Tax -->
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="includeTax" onchange="updateTotals()" class="rounded">
                                        <span class="text-gray-600">IVA:</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="taxPercent" min="0" max="100" value="16" 
                                               class="w-16 px-2 py-1 border border-gray-200 rounded-lg text-sm text-right"
                                               onchange="updateTotals()">
                                        <span class="text-gray-600 text-sm">%</span>
                                        <span id="tax" class="font-semibold">$0.00</span>
                                    </div>
                                </div>
                                
                                <div class="flex justify-between text-xl font-bold text-gray-800 pt-2 border-t">
                                    <span>Total:</span>
                                    <span id="total">$0.00</span>
                                </div>
                            </div>
                            
                            <!-- Concept & Notes -->
                            <div class="mb-4 space-y-3">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Concepto</label>
                                    <input type="text" id="saleNotes" placeholder="Ej: Venta de productos"
                                           class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nota</label>
                                    <textarea id="saleNote" placeholder="Nota adicional (opcional)" rows="2"
                                              class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none text-sm"></textarea>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M√©todo de Pago</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="selectPaymentMethod('cash')" 
                                            class="payment-method-btn border-2 rounded-xl py-3 hover:border-opacity-80 transition-all" style="border-color: #C5A572; background: #FFF9F0;">
                                        <i class="fas fa-money-bill-wave text-green-600 text-xl mb-1"></i>
                                        <p class="text-xs font-semibold text-gray-700">Efectivo</p>
                                    </button>
                                    <button onclick="selectPaymentMethod('card')" 
                                            class="payment-method-btn border-2 border-gray-200 rounded-xl py-3 transition-all">
                                        <i class="fas fa-credit-card text-blue-600 text-xl mb-1"></i>
                                        <p class="text-xs font-semibold text-gray-700">Tarjeta</p>
                                    </button>
                                    <button onclick="selectPaymentMethod('transfer')" 
                                            class="payment-method-btn border-2 border-gray-200 rounded-xl py-3 transition-all">
                                        <i class="fas fa-exchange-alt text-purple-600 text-xl mb-1"></i>
                                        <p class="text-xs font-semibold text-gray-700">Transfer.</p>
                                    </button>
                                </div>
                            </div>
                            
                            <button onclick="processPayment()" 
                                    class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg">
                                <i class="fas fa-check mr-2"></i>
                                Cobrar
                            </button>
                            
                            <button onclick="clearTicket()" 
                                    class="w-full mt-3 py-3 rounded-xl text-gray-600 font-semibold border-2 border-gray-200 hover:bg-gray-50 transition-all">
                                <i class="fas fa-trash mr-2"></i>
                                Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- COTIZACIONES SECTION -->
        <section id="quotes-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800">Cotizaciones</h2>
                    <button onclick="openQuoteModal()" 
                            class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">
                        <i class="fas fa-plus mr-2"></i>
                        Nueva Cotizaci√≥n
                    </button>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Folio</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Cliente</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Fecha</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Total</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Estado</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="quotesTable" class="divide-y divide-gray-200">
                                <!-- Rows will be inserted here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- INVENTORY SECTION -->
        <section id="inventory-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800">Inventario</h2>
                    <button onclick="openAddProductModal()" 
                            class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">
                        <i class="fas fa-plus mr-2"></i>
                        Agregar Producto
                    </button>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Imagen</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Producto</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">SKU</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Categor√≠a</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Variantes</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Precio</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Stock</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Estado</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable" class="divide-y divide-gray-200">
                                <!-- Rows will be inserted here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- BALANCE SECTION -->
        <section id="balance-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Balance Financiero</h2>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-arrow-up text-white text-xl"></i>
                            </div>
                        </div>
                        <p class="text-white/80 text-sm mb-1">Total Ingresos</p>
                        <h3 class="text-3xl font-bold" id="totalIncome">$0</h3>
                    </div>
                    
                    <div class="stat-card bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-arrow-down text-white text-xl"></i>
                            </div>
                        </div>
                        <p class="text-white/80 text-sm mb-1">Total Egresos</p>
                        <h3 class="text-3xl font-bold" id="totalExpenses">$0</h3>
                    </div>
                    
                    <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-hand-holding-usd text-white text-xl"></i>
                            </div>
                        </div>
                        <p class="text-white/80 text-sm mb-1">Cuentas por Cobrar</p>
                        <h3 class="text-3xl font-bold" id="totalReceivables">$0</h3>
                    </div>
                    
                    <div class="stat-card bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-file-invoice-dollar text-white text-xl"></i>
                            </div>
                        </div>
                        <p class="text-white/80 text-sm mb-1">Cuentas por Pagar</p>
                        <h3 class="text-3xl font-bold" id="totalPayables">$0</h3>
                    </div>
                </div>
                
                <!-- Transactions Tables -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Ingresos -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Ingresos</h3>
                            <button onclick="openIncomeModal()" class="text-green-600 hover:text-green-700">
                                <i class="fas fa-plus-circle text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto" id="incomeList">
                            <!-- Income items will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Egresos -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Egresos</h3>
                            <button onclick="openExpenseModal()" class="text-red-600 hover:text-red-700">
                                <i class="fas fa-plus-circle text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto" id="expenseList">
                            <!-- Expense items will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Accounts Tables -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Cuentas por Cobrar -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Cuentas por Cobrar</h3>
                            <button onclick="openReceivableModal()" class="text-blue-600 hover:text-blue-700">
                                <i class="fas fa-plus-circle text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto" id="receivablesList">
                            <!-- Receivables will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Cuentas por Pagar -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Cuentas por Pagar</h3>
                            <button onclick="openPayableModal()" class="text-orange-600 hover:text-orange-700">
                                <i class="fas fa-plus-circle text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto" id="payablesList">
                            <!-- Payables will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- CLIENTES SECTION -->
        <section id="clientes-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800">Clientes</h2>
                    <button onclick="openAddClientModal()" 
                            class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">
                        <i class="fas fa-user-plus mr-2"></i>
                        Agregar Cliente
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #E6D5E6;">
                                <i class="fas fa-users text-xl" style="color: #C5A572;"></i>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Total Clientes</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="totalClients">0</h3>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #FFF9F0;">
                                <i class="fas fa-star text-xl" style="color: #C5A572;"></i>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Clientes VIP</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="vipClients">0</h3>
                    </div>
                    
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #E6D5E6;">
                                <i class="fas fa-shopping-bag text-xl" style="color: #C5A572;"></i>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-1">Compras Totales</p>
                        <h3 class="text-3xl font-bold text-gray-800" id="totalPurchases">$0</h3>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="searchClient" placeholder="Buscar clientes..." 
                                   class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Cliente</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Tel√©fono</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Email</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Total Compras</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">√öltima Compra</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Tipo</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTable" class="divide-y divide-gray-200">
                                <!-- Rows will be inserted here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- CATEGOR√çAS SECTION -->
        <section id="categorias-section" class="p-4 md:p-8 hidden">
            <div class="max-w-5xl mx-auto">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Gesti√≥n de Categor√≠as</h2>
                        <p class="text-gray-600 mt-1">Administra las categor√≠as de tus productos</p>
                    </div>
                    <button onclick="openAddCategoryModal()" 
                            class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">
                        <i class="fas fa-plus mr-2"></i>
                        Nueva Categor√≠a
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="categoriesGrid">
                    <!-- Categories will be inserted here by JS -->
                </div>
            </div>
        </section>
        
        <!-- REPORTES SECTION -->
        <section id="reportes-section" class="p-4 md:p-8 hidden">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Reportes y An√°lisis</h2>
                <button onclick="descargarReporteVentas()" class="px-5 py-3 text-white rounded-xl font-semibold flex items-center gap-2" style="background:#C5A572">
  <i class="fas fa-download"></i> Descargar Reporte CSV
</button>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Productos M√°s Vendidos</h3>
                        <div id="topProductsList" class="space-y-3">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Ventas por Categor√≠a</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Resumen Mensual</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ventas del Mes:</span>
                                <span class="font-bold text-gray-800" id="monthlySales">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ganancia Neta:</span>
                                <span class="font-bold text-green-600" id="monthlyProfit">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Productos Vendidos:</span>
                                <span class="font-bold text-gray-800" id="monthlyUnitsSold">0 unidades</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Inventario</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Valor Total:</span>
                                <span class="font-bold text-gray-800" id="inventoryValue">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Productos Activos:</span>
                                <span class="font-bold text-gray-800" id="activeProducts">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Bajo Stock:</span>
                                <span class="font-bold text-orange-600" id="lowStockCount">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">M√©todos de Pago</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600"><i class="fas fa-money-bill-wave text-green-600 mr-2"></i>Efectivo:</span>
                                <span class="font-bold text-gray-800" id="cashPercentage">0%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600"><i class="fas fa-credit-card text-blue-600 mr-2"></i>Tarjeta:</span>
                                <span class="font-bold text-gray-800" id="cardPercentage">0%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600"><i class="fas fa-exchange-alt text-purple-600 mr-2"></i>Transferencia:</span>
                                <span class="font-bold text-gray-800" id="transferPercentage">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Historial de Ventas Recientes</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Fecha</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Cliente</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Productos</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">M√©todo</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Total</th>
                                </tr>
                            </thead>
                            <tbody id="salesHistoryTable" class="divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- VENTAS EN ABONOS -->
<section id="abonos-section" class="p-4 md:p-8 hidden">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Ventas en Abonos</h2>
            <button onclick="openAbonoModal()" class="btn-primary px-6 py-3 rounded-xl text-white font-semibold"><i class="fas fa-plus mr-2"></i>Nueva Venta en Abonos</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border"><p class="text-gray-600 text-sm mb-1">Total por Cobrar</p><h3 class="text-3xl font-bold text-red-600" id="abonosTotalPendiente">$0</h3></div>
            <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border"><p class="text-gray-600 text-sm mb-1">Clientes con Deuda</p><h3 class="text-3xl font-bold" id="abonosClientesDeuda">0</h3></div>
            <div class="stat-card bg-white p-6 rounded-2xl shadow-sm border"><p class="text-gray-600 text-sm mb-1">Total Cobrado</p><h3 class="text-3xl font-bold text-green-600" id="abonosTotalCobrado">$0</h3></div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b"><tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Folio</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Cliente</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Contacto</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Concepto</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Total</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Abonado</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Resta</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Acciones</th>
                    </tr></thead>
                    <tbody id="abonosTable" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- PEDIDOS POR ENCARGO -->
<section id="pedidos-section" class="p-4 md:p-8 hidden">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Pedidos por Encargo</h2>
            <button onclick="openPedidoModal()" class="btn-primary px-6 py-3 rounded-xl text-white font-semibold"><i class="fas fa-plus mr-2"></i>Nuevo Pedido</button>
        </div>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-xs text-gray-500 mb-1">Activos</p><h3 class="text-2xl font-bold" id="pedidosActivos">0</h3></div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-xs text-gray-500 mb-1">Por Cobrar</p><h3 class="text-2xl font-bold text-red-600" id="pedidosPorCobrar">$0</h3></div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-xs text-gray-500 mb-1">Anticipo Cobrado</p><h3 class="text-2xl font-bold text-green-600" id="pedidosAnticipos">$0</h3></div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border"><p class="text-xs text-gray-500 mb-1">Este Mes</p><h3 class="text-2xl font-bold" style="color:#C5A572" id="pedidosMes">0</h3></div>
        </div>
        <div class="flex flex-wrap gap-2 mb-4">
            <button onclick="filterPedidos('todos',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 cursor-pointer" style="border-color:#C5A572;background:#FFF9F0;color:#C5A572;">Todos</button>
            <button onclick="filterPedidos('confirmado',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">‚úÖ Confirmado</button>
            <button onclick="filterPedidos('pago',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">üí∞ Pago</button>
            <button onclick="filterPedidos('produccion',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">üîß Producci√≥n</button>
            <button onclick="filterPedidos('envio',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">üì¶ Env√≠o</button>
            <button onclick="filterPedidos('salida',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">üöö Sali√≥</button>
            <button onclick="filterPedidos('retirar',this)" class="pedido-filter px-4 py-2 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-600 bg-white cursor-pointer">üè™ Retirar</button>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b"><tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Folio</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Cliente</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Concepto</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">F.Pedido</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">F.Entrega</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Total</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Anticipo</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Resta</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Acciones</th>
                    </tr></thead>
                    <tbody id="pedidosTable" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

    </main>
    
    <!-- MODALS -->
    
    <!-- Quote Modal -->
    <div id="quoteModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 p-8 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Nueva Cotizaci√≥n</h3>
                <button onclick="closeQuoteModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="quoteForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Cliente *</label>
                        <input type="text" id="quoteCustomer" required
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">V√°lido hasta</label>
                        <input type="date" id="quoteValidUntil"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Productos</label>
                    <div id="quoteProductsContainer" class="space-y-3 mb-3 max-h-60 overflow-y-auto border border-gray-200 rounded-xl p-4">
                        <!-- Quote products will be added here -->
                    </div>
                    <button type="button" onclick="addProductToQuote()" class="text-sm font-semibold" style="color: #C5A572;">
                        <i class="fas fa-plus mr-1"></i> Agregar Producto
                    </button>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Notas</label>
                    <textarea id="quoteNotes" rows="3" placeholder="Condiciones, observaciones..."
                              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none"></textarea>
                </div>
                
                <div class="flex justify-between items-center pt-4 border-t">
                    <span class="text-lg font-bold">Total:</span>
                    <span id="quoteTotal" class="text-2xl font-bold" style="color: #C5A572;">$0.00</span>
                </div>
                
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-6">
                    <i class="fas fa-save mr-2"></i>
                    Generar Cotizaci√≥n
                </button>
            </form>
        </div>
    </div>
    
    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 p-8 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 no-print">
                <h3 class="text-2xl font-bold text-gray-800">Comprobante</h3>
                <button onclick="closeReceiptModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="receiptContent" class="receipt">
                <!-- Receipt content will be generated here -->
            </div>
            
            <div class="flex gap-3 mt-6 no-print">
                <button onclick="downloadReceipt()" class="btn-primary flex-1 py-3 rounded-xl text-white font-semibold">
                    <i class="fas fa-download mr-2"></i>
                    Descargar PDF
                </button>
                <button onclick="printReceipt()" class="btn-secondary flex-1 py-3 rounded-xl text-white font-semibold">
                    <i class="fas fa-print mr-2"></i>
                    Imprimir
                </button>
                <button onclick="shareReceipt()" class="border-2 px-6 py-3 rounded-xl font-semibold" style="border-color: #C5A572; color: #C5A572;">
                    <i class="fas fa-share-alt mr-2"></i>
                    Compartir
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-8 animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Nuevo Producto</h3>
                <button onclick="closeAddProductModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addProductForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Imagen del Producto</label>
                    <input type="file" id="productImage" accept="image/*"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                    <div id="imagePreview" class="mt-3 hidden">
                        <img id="previewImg" class="image-preview mx-auto" src="" alt="Preview">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre del Producto</label>
                    <input type="text" id="productName" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">C√≥digo SKU</label>
                    <input type="text" id="productSKU" placeholder="Se generar√° autom√°ticamente si est√° vac√≠o"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Categor√≠a</label>
                    <select id="productCategory" required
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Variantes (Opcional)</label>
                    <div class="grid grid-cols-2 gap-4 mb-2">
                        <input type="text" id="variantType" placeholder="Ej: Talla, Color"
                               class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                        <input type="text" id="variantValue" placeholder="Ej: M, Rojo"
                               class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                    </div>
                    <button type="button" onclick="addVariant()" 
                            class="text-sm font-semibold" style="color: #C5A572;">
                        <i class="fas fa-plus mr-1"></i> Agregar Variante
                    </button>
                    <div id="variantsList" class="mt-3"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Costo</label>
                        <input type="number" id="productCost" required step="0.01" min="0"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Precio Venta</label>
                        <input type="number" id="productPrice" required step="0.01" min="0"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Stock Inicial</label>
                    <input type="number" id="productStock" required min="0"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-6">
                    <i class="fas fa-save mr-2"></i>
                    Guardar Producto
                </button>
            </form>
        </div>
    </div>
    
    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Nuevo Cliente</h3>
                <button onclick="closeAddClientModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addClientForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre Completo</label>
                    <input type="text" id="clientName" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono</label>
                    <input type="tel" id="clientPhone" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input type="email" id="clientEmail" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-6">
                    <i class="fas fa-save mr-2"></i>
                    Guardar Cliente
                </button>
            </form>
        </div>
    </div>
    
    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Nueva Categor√≠a</h3>
                <button onclick="closeAddCategoryModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addCategoryForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre de la Categor√≠a</label>
                    <input type="text" id="categoryName" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Emoji/Icono</label>
                    <input type="text" id="categoryEmoji" required maxlength="2" placeholder="üì¶"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:border-transparent outline-none text-center text-3xl">
                    <p class="text-xs text-gray-500 mt-1">Elige un emoji para identificar esta categor√≠a</p>
                </div>
                
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-6">
                    <i class="fas fa-save mr-2"></i>
                    Crear Categor√≠a
                </button>
            </form>
        </div>
    </div>
    
    <!-- Balance Modal -->
    <div id="transactionModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="transactionModalTitle">Nueva Transacci√≥n</h3>
                <button onclick="closeTransactionModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="transactionForm" class="space-y-4">
                <input type="hidden" id="transactionType">
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Concepto</label>
                    <input type="text" id="transactionConcept" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Monto</label>
                    <input type="number" id="transactionAmount" required step="0.01" min="0"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha</label>
                    <input type="date" id="transactionDate" required
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                </div>
                
                <div id="clientFieldContainer" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Cliente/Proveedor</label>
                    <input type="text" id="transactionClient"
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 outline-none">
                </div>
                
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg mt-6">
                    <i class="fas fa-save mr-2"></i>
                    Guardar
                </button>
            </form>
        </div>
    </div>
    
    <script>
  // ============================================================
// SUPABASE CONFIG
// ============================================================
const SUPABASE_URL = 'https://hoqcrljgmamaumtdrtzi.supabase.co';
const SUPABASE_KEY = 'sb_publishable_nYdOuvLjAeE6Zwc0ZcSH5g_JT0jOF-M';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Compatibilidad - ya no usamos localStorage
function saveToLocalStorage(key, data) {}
        
        // Auto-save functions
  function saveCategories()  { sbSave('categories', categories); }
function saveProducts()    { sbSave('products', products); }
function saveClients()     { sbSave('clients', clients); }
function saveSalesHistory(){ sbSave('salesHistory', salesHistory); }
function saveQuotes()      { sbSave('quotes', quotes); }
function saveIncomes()     { sbSave('incomes', incomes); }
function saveExpenses()    { sbSave('expenses', expenses); }
function saveReceivables() { sbSave('receivables', receivables); }
function savePayables()    { sbSave('payables', payables); }
function saveAbonos()      { sbSave('abonos', abonos); }
function savePedidos()     { sbSave('pedidos', pedidos); }
        
        // ============== DEFAULT DATA ==============
        const defaultCategories = [
            { id: 'tazas', name: 'Tazas', emoji: '‚òï' },
            { id: 'llaveros', name: 'Llaveros', emoji: 'üîë' },
            { id: 'libretas', name: 'Libretas', emoji: 'üìì' },
            { id: 'peluches', name: 'Peluches', emoji: 'üß∏' },
            { id: 'otros', name: 'Otros', emoji: 'üéÅ' }
        ];
        
        // ============== DATA (Supabase - se carga en initApp) ==============
let categories = [];
let products = [];
let clients = [];
let salesHistory = [];
let quotes = [];
let incomes = [];
let expenses = [];
let receivables = [];
let payables = [];
        
        let ticket = [];
        let selectedPaymentMethod = 'cash';
        let categoryChart = null;
        let salesWeekChart = null;
        let currentVariants = [];
        let currentProductImage = null;
        let currentQuoteProducts = [];
        let lastReceipt = null;
        
        

// Inicializaci√≥n real con Supabase
(async function initApp() {
    try {
        const [
            { data: cats },
            { data: prods },
            { data: cls },
            { data: sales },
            { data: qs },
            { data: inc },
            { data: exp },
            { data: rec },
            { data: pay },
            { data: abs },
            { data: peds }
        ] = await Promise.all([
            db.from('categories').select('*'),
            db.from('products').select('*'),
            db.from('clients').select('*'),
            db.from('sales').select('*'),
            db.from('quotes').select('*'),
            db.from('incomes').select('*'),
            db.from('expenses').select('*'),
            db.from('receivables').select('*'),
            db.from('payables').select('*'),
            db.from('abonos').select('*'),
            db.from('pedidos').select('*')
        ]);

        categories   = cats || [];
        products     = prods || [];
        clients      = cls || [];
        salesHistory = sales || [];
        quotes       = qs || [];
        incomes      = inc || [];
        expenses     = exp || [];
        receivables  = rec || [];
        payables     = pay || [];
        abonos       = abs || [];
        pedidos      = peds || [];

        // Si no hay categor√≠as, insertar las por defecto
        if (categories.length === 0) {
            await db.from('categories').insert(defaultCategories);
            categories = [...defaultCategories];
        }

        const today = new Date().toISOString().split('T')[0];
        const validUntil = new Date();
        validUntil.setDate(validUntil.getDate() + 15);
        document.getElementById('quoteValidUntil').value = validUntil.toISOString().split('T')[0];
        document.getElementById('transactionDate').value = today;

        updateDashboard();
        renderProducts();
        renderInventoryTable();
        renderClientsTable();
        renderCategoriesGrid();
        renderQuotesTable();
        renderBalance();
        updateCategorySelects();
        initChart();
        initReports();
        setupSearchFilter();
        setupClientSearch();
        setupMobileMenu();
        setupImageUpload();
        renderAbonosTable();
        renderPedidosTable();

        // Restaurar secci√≥n activa
        const lastSection = localStorage.getItem('maneki_activeSection');
        if (lastSection) { try { showSection(lastSection); } catch(e) {} }

        console.log('‚úÖ Maneki Store conectado a Supabase');
    } catch(err) {
        console.error('Error iniciando app:', err);
        alert('Error conectando a Supabase. Revisa la consola.');
    }
})();

        
        // ============== DASHBOARD ==============
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            
            const todaySales = salesHistory
                .filter(s => s.date === today)
                .reduce((sum, s) => sum + s.total, 0);
            
            const totalSales = salesHistory.reduce((sum, s) => sum + s.total, 0);
            const totalCosts = products.reduce((sum, p) => sum + (p.cost * p.stock), 0);
            const netProfit = totalSales - totalCosts;
            
            const lowStock = products.filter(p => p.stock > 0 && p.stock <= 10).length;
            
            const accountsReceivable = receivables
                .filter(r => r.status === 'pending')
                .reduce((sum, r) => sum + r.amount, 0);
            
            document.getElementById('dailySales').textContent = `$${todaySales.toFixed(2)}`;
            document.getElementById('salesTrend').textContent = todaySales > 0 ? '+12%' : '0%';
            document.getElementById('netProfit').textContent = `$${netProfit.toFixed(2)}`;
            document.getElementById('profitTrend').textContent = netProfit > 0 ? '+8%' : '0%';
            document.getElementById('lowStockBadge').textContent = `${lowStock} items`;
            document.getElementById('accountsReceivable').textContent = `$${accountsReceivable.toFixed(2)}`;
        }
        
        // ============== POS MODULE ==============
        
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            
            if (products.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-400 text-lg">No hay productos agregados</p><p class="text-gray-500 text-sm mt-2">Ve a Inventario para agregar tu primer producto</p></div>';
                return;
            }
            
            grid.innerHTML = products.map(product => {
                const imageDisplay = product.imageUrl ? 
                    `<img src="${product.imageUrl}" class="w-full h-24 object-cover rounded-lg mb-2">` :
                    `<div class="text-4xl mb-3 text-center">${product.image}</div>`;
                    
                return `
                    <div class="product-card bg-gray-50 rounded-xl p-4 border-2 border-transparent hover:shadow-lg" 
                         onclick="addToTicket(${product.id})">
                        ${imageDisplay}
                        <h4 class="font-semibold text-gray-800 text-sm mb-2 line-clamp-2">${product.name}</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold" style="color: #C5A572;">$${product.price.toFixed(2)}</span>
                            <span class="text-xs ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-orange-600' : 'text-red-600'}">
                                Stock: ${product.stock}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function addToTicket(productId) {
            const product = products.find(p => p.id === productId);
            if (product.stock <= 0) {
                alert('Producto agotado');
                return;
            }
            
            const existingItem = ticket.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                } else {
                    alert('Stock insuficiente');
                    return;
                }
            } else {
                ticket.push({ ...product, quantity: 1 });
            }
            
            renderTicket();
        }
        
        function renderTicket() {
            const container = document.getElementById('ticketItems');
            
            if (ticket.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8 text-sm">No hay productos agregados</p>';
                updateTotals();
                return;
            }
            
            container.innerHTML = ticket.map(item => `
                <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl">
                    <span class="text-2xl">${item.image}</span>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 text-sm truncate">${item.name}</p>
                        <p class="text-xs text-gray-500">$${item.price.toFixed(2)} c/u</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateQuantity(${item.id}, -1)" 
                                class="w-6 h-6 bg-gray-200 rounded-lg hover:bg-gray-300 text-gray-700">
                            <i class="fas fa-minus text-xs"></i>
                        </button>
                        <span class="w-8 text-center font-semibold">${item.quantity}</span>
                        <button onclick="updateQuantity(${item.id}, 1)" 
                                class="w-6 h-6 bg-gray-200 rounded-lg hover:bg-gray-300 text-gray-700">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                    <button onclick="removeFromTicket(${item.id})" 
                            class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
            `).join('');
            
            updateTotals();
        }
        
        function updateQuantity(productId, change) {
            const item = ticket.find(i => i.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromTicket(productId);
                } else if (item.quantity > product.stock) {
                    item.quantity = product.stock;
                    alert('Stock m√°ximo alcanzado');
                }
                renderTicket();
            }
        }
        
        function removeFromTicket(productId) {
            ticket = ticket.filter(item => item.id !== productId);
            renderTicket();
        }
        
        function updateTotals() {
            const subtotal = ticket.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const subtotalAfterDiscount = subtotal - discountAmount;
            
            const includeTax = document.getElementById('includeTax').checked;
            const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;
            const taxAmount = includeTax ? subtotalAfterDiscount * (taxPercent / 100) : 0;
            
            const total = subtotalAfterDiscount + taxAmount;
            
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('discountAmount').textContent = `-$${discountAmount.toFixed(2)}`;
            document.getElementById('tax').textContent = `$${taxAmount.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }
        
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-method-btn').forEach(btn => {
                btn.classList.remove('border-gray-200');
                btn.style.borderColor = '#E5E7EB';
                btn.style.background = 'white';
            });
            const selectedBtn = event.target.closest('.payment-method-btn');
            selectedBtn.style.borderColor = '#C5A572';
            selectedBtn.style.background = '#FFF9F0';
        }
        
        function processPayment() {
            if (ticket.length === 0) {
                alert('Agrega productos al ticket primero');
                return;
            }
            
            const customerName = document.getElementById('customerName').value || 'Cliente General';
            const concept = document.getElementById('saleNotes').value || 'Venta de productos';
            const note = document.getElementById('saleNote').value || '';
            
            const subtotal = ticket.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const subtotalAfterDiscount = subtotal - discountAmount;
            
            const includeTax = document.getElementById('includeTax').checked;
            const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;
            const taxAmount = includeTax ? subtotalAfterDiscount * (taxPercent / 100) : 0;
            
            const total = subtotalAfterDiscount + taxAmount;
            
            ticket.forEach(item => {
                const product = products.find(p => p.id === item.id);
                product.stock -= item.quantity;
            });
            
            const paymentMethodNames = {
                'cash': 'Efectivo',
                'card': 'Tarjeta',
                'transfer': 'Transferencia'
            };
            
            const saleRecord = {
                id: salesHistory.length + 1,
                folio: `V-${String(salesHistory.length + 1).padStart(6, '0')}`,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('es-MX'),
                customer: customerName,
                concept: concept,
                note: note,
                products: [...ticket],
                subtotal: subtotal,
                discount: discountAmount,
                discountPercent: discountPercent,
                tax: taxAmount,
                taxPercent: includeTax ? taxPercent : 0,
                total: total,
                method: paymentMethodNames[selectedPaymentMethod]
            };
            
            salesHistory.push(saleRecord);
            lastReceipt = saleRecord;
            
            incomes.push({
                id: incomes.length + 1,
                concept: `Venta ${saleRecord.folio}`,
                amount: total,
                date: saleRecord.date
            });
            
            saveProducts();
            saveSalesHistory();
            saveIncomes();
            
            generateReceipt(saleRecord);
            document.getElementById('receiptModal').classList.add('active');
            
            clearTicket();
            renderProducts();
            renderInventoryTable();
            updateDashboard();
            renderBalance();
            
            if (salesWeekChart) {
                salesWeekChart.destroy();
            }
            initChart();
        }
        
        function clearTicket() {
            ticket = [];
            document.getElementById('customerName').value = '';
            document.getElementById('saleNotes').value = '';
            document.getElementById('saleNote').value = '';
            document.getElementById('discountPercent').value = '0';
            document.getElementById('includeTax').checked = false;
            renderTicket();
        }
        
        // ============== RECEIPT GENERATION ==============
        
        function generateReceipt(sale) {
            const receiptHTML = `
                <div class="receipt-header">
                    <div class="receipt-logo">üê±</div>
                    <h1 class="text-3xl font-bold mb-2" style="color: #000;">Maneki Store</h1>
                    <p class="text-gray-600">Regalos Personalizados</p>
                    <div class="mt-4" style="background: #E6D5E6; padding: 8px 16px; border-radius: 8px; display: inline-block;">
                        <p class="text-sm font-bold" style="color: #C5A572;">Folio: ${sale.folio}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-sm text-gray-600">Cliente</p>
                        <p class="font-semibold text-gray-800">${sale.customer}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Fecha y Hora</p>
                        <p class="font-semibold text-gray-800">${sale.date} ${sale.time}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">M√©todo de Pago</p>
                        <p class="font-semibold text-gray-800">${sale.method}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Concepto</p>
                        <p class="font-semibold text-gray-800">${sale.concept}</p>
                    </div>
                </div>
                
                <table class="receipt-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant.</th>
                            <th>Precio</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sale.products.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td>$${item.price.toFixed(2)}</td>
                                <td>$${(item.price * item.quantity).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="space-y-2 mt-6 text-right">
                    <div class="flex justify-between text-gray-700">
                        <span>Subtotal:</span>
                        <span>$${sale.subtotal.toFixed(2)}</span>
                    </div>
                    ${sale.discount > 0 ? `
                        <div class="flex justify-between text-red-600">
                            <span>Descuento (${sale.discountPercent}%):</span>
                            <span>-$${sale.discount.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    ${sale.tax > 0 ? `
                        <div class="flex justify-between text-gray-700">
                            <span>IVA (${sale.taxPercent}%):</span>
                            <span>$${sale.tax.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    <div class="flex justify-between text-2xl font-bold pt-3 border-t-2" style="border-color: #C5A572; color: #000;">
                        <span>Total:</span>
                        <span>$${sale.total.toFixed(2)}</span>
                    </div>
                </div>
                
                ${sale.note ? `
                    <div class="mt-6 p-4 rounded-lg" style="background: #FFF9F0;">
                        <p class="text-sm font-semibold text-gray-700 mb-1">Nota:</p>
                        <p class="text-sm text-gray-600">${sale.note}</p>
                    </div>
                ` : ''}
                
                <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                    <p class="text-sm text-gray-600">¬°Gracias por tu compra!</p>
                    <p class="text-xs text-gray-500 mt-2">www.manekistore.com</p>
                </div>
            `;
            
            document.getElementById('receiptContent').innerHTML = receiptHTML;
        }
        
        function downloadReceipt() {
            const element = document.getElementById('receiptContent');
            const opt = {
                margin: 10,
                filename: `Maneki-${lastReceipt.folio}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }
        
        function printReceipt() {
            window.print();
        }
        
        function shareReceipt() {
            const shareText = `Comprobante de compra\n\nFolio: ${lastReceipt.folio}\nCliente: ${lastReceipt.customer}\nTotal: $${lastReceipt.total.toFixed(2)}\n\n¬°Gracias por tu compra!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Comprobante Maneki Store',
                    text: shareText,
                }).catch(err => console.log('Error sharing', err));
            } else {
                navigator.clipboard.writeText(shareText);
                alert('‚úÖ Texto copiado al portapapeles. Puedes pegarlo en WhatsApp o donde desees.');
            }
        }
        
        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.remove('active');
        }
        
        // ============== QUOTES MODULE ==============
        
        function openQuoteModal() {
            currentQuoteProducts = [];
            document.getElementById('quoteProductsContainer').innerHTML = '';
            document.getElementById('quoteModal').classList.add('active');
            updateQuoteTotal();
        }
        
        function closeQuoteModal() {
            document.getElementById('quoteModal').classList.remove('active');
            document.getElementById('quoteForm').reset();
            currentQuoteProducts = [];
        }
        
        function addProductToQuote() {
            if (products.length === 0) {
                alert('No hay productos disponibles. Agrega productos primero en Inventario.');
                return;
            }
            
            const productSelect = `
                <div class="flex gap-2 items-start p-3 bg-gray-50 rounded-lg quote-product-row">
                    <select class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" onchange="updateQuoteTotal()">
                        <option value="">Seleccionar producto...</option>
                        ${products.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} - $${p.price}</option>`).join('')}
                    </select>
                    <input type="number" min="1" value="1" placeholder="Cant." 
                           class="w-20 px-3 py-2 border border-gray-200 rounded-lg text-sm" 
                           onchange="updateQuoteTotal()">
                    <button type="button" onclick="removeQuoteProduct(this)" class="text-red-500 hover:text-red-700 px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            document.getElementById('quoteProductsContainer').insertAdjacentHTML('beforeend', productSelect);
            updateQuoteTotal();
        }
        
        function removeQuoteProduct(button) {
            button.closest('.quote-product-row').remove();
            updateQuoteTotal();
        }
        
        function updateQuoteTotal() {
            let total = 0;
            const productRows = document.getElementById('quoteProductsContainer').querySelectorAll('.quote-product-row');
            
            productRows.forEach(row => {
                const select = row.querySelector('select');
                const quantityInput = row.querySelector('input[type="number"]');
                const selectedOption = select.options[select.selectedIndex];
                
                if (selectedOption && selectedOption.value) {
                    const price = parseFloat(selectedOption.dataset.price);
                    const quantity = parseInt(quantityInput.value) || 1;
                    total += price * quantity;
                }
            });
            
            document.getElementById('quoteTotal').textContent = `$${total.toFixed(2)}`;
        }
        
        document.getElementById('quoteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customer = document.getElementById('quoteCustomer').value;
            const validUntil = document.getElementById('quoteValidUntil').value;
            const notes = document.getElementById('quoteNotes').value;
            
            const productRows = document.getElementById('quoteProductsContainer').querySelectorAll('.quote-product-row');
            const quoteProducts = [];
            let total = 0;
            
            productRows.forEach(row => {
                const select = row.querySelector('select');
                const quantityInput = row.querySelector('input[type="number"]');
                const selectedOption = select.options[select.selectedIndex];
                
                if (selectedOption && selectedOption.value) {
                    const productId = parseInt(selectedOption.value);
                    const product = products.find(p => p.id === productId);
                    const quantity = parseInt(quantityInput.value) || 1;
                    const subtotal = product.price * quantity;
                    
                    quoteProducts.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        quantity: quantity,
                        subtotal: subtotal
                    });
                    
                    total += subtotal;
                }
            });
            
            if (quoteProducts.length === 0) {
                alert('Agrega al menos un producto a la cotizaci√≥n');
                return;
            }
            
            const newQuote = {
                id: quotes.length + 1,
                folio: `COT-${String(quotes.length + 1).padStart(6, '0')}`,
                customer: customer,
                date: new Date().toISOString().split('T')[0],
                validUntil: validUntil,
                products: quoteProducts,
                notes: notes,
                total: total,
                status: 'pending'
            };
            
            quotes.push(newQuote);
            saveQuotes();
            
            alert('‚úÖ Cotizaci√≥n generada exitosamente');
            closeQuoteModal();
            renderQuotesTable();
            
            generateQuoteDocument(newQuote);
        });
        
        function renderQuotesTable() {
            const tbody = document.getElementById('quotesTable');
            
            if (quotes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-400">No hay cotizaciones creadas</td></tr>';
                return;
            }
            
            tbody.innerHTML = quotes.map(quote => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold" style="color: #C5A572;">${quote.folio}</td>
                    <td class="px-6 py-4 text-gray-800">${quote.customer}</td>
                    <td class="px-6 py-4 text-gray-600">${quote.date}</td>
                    <td class="px-6 py-4 text-gray-800 font-semibold">$${quote.total.toFixed(2)}</td>
                    <td class="px-6 py-4">
                        <span class="badge-${quote.status === 'pending' ? 'warning' : 'success'}">
                            ${quote.status === 'pending' ? 'Pendiente' : 'Aprobada'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="viewQuote(${quote.id})" class="text-blue-600 hover:text-blue-800 mr-3" title="Ver">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="shareQuote(${quote.id})" class="text-green-600 hover:text-green-800 mr-3" title="Compartir">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button onclick="deleteQuote(${quote.id})" class="text-red-600 hover:text-red-800" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function generateQuoteDocument(quote) {
            const quoteHTML = `
                <div class="receipt-header">
                    <div class="receipt-logo">üê±</div>
                    <h1 class="text-3xl font-bold mb-2" style="color: #000;">Maneki Store</h1>
                    <p class="text-gray-600">Cotizaci√≥n</p>
                    <div class="mt-4" style="background: #E6D5E6; padding: 8px 16px; border-radius: 8px; display: inline-block;">
                        <p class="text-sm font-bold" style="color: #C5A572;">Folio: ${quote.folio}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-sm text-gray-600">Cliente</p>
                        <p class="font-semibold text-gray-800">${quote.customer}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Fecha</p>
                        <p class="font-semibold text-gray-800">${quote.date}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">V√°lido hasta</p>
                        <p class="font-semibold text-gray-800">${quote.validUntil}</p>
                    </div>
                </div>
                
                <table class="receipt-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${quote.products.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td>$${item.price.toFixed(2)}</td>
                                <td>$${item.subtotal.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="text-right mt-6">
                    <div class="text-2xl font-bold" style="color: #000;">
                        Total: <span style="color: #C5A572;">$${quote.total.toFixed(2)}</span>
                    </div>
                </div>
                
                ${quote.notes ? `
                    <div class="mt-6 p-4 rounded-lg" style="background: #FFF9F0;">
                        <p class="text-sm font-semibold text-gray-700 mb-1">Observaciones:</p>
                        <p class="text-sm text-gray-600">${quote.notes}</p>
                    </div>
                ` : ''}
                
                <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                    <p class="text-sm text-gray-600">Esta cotizaci√≥n es v√°lida hasta ${quote.validUntil}</p>
                    <p class="text-xs text-gray-500 mt-2">www.manekistore.com</p>
                </div>
            `;
            
            document.getElementById('receiptContent').innerHTML = quoteHTML;
            lastReceipt = quote;
            document.getElementById('receiptModal').classList.add('active');
        }
        
        function viewQuote(id) {
            const quote = quotes.find(q => q.id === id);
            if (quote) {
                generateQuoteDocument(quote);
            }
        }
        
        function shareQuote(id) {
            const quote = quotes.find(q => q.id === id);
            if (!quote) return;
            
            const shareText = `üìã *Cotizaci√≥n ${quote.folio}*\n\n` +
                `Cliente: ${quote.customer}\n` +
                `Fecha: ${quote.date}\n` +
                `V√°lido hasta: ${quote.validUntil}\n\n` +
                `*Productos:*\n` +
                quote.products.map(p => `‚Ä¢ ${p.name} (${p.quantity}) - $${p.subtotal.toFixed(2)}`).join('\n') +
                `\n\n*Total: $${quote.total.toFixed(2)}*\n\n` +
                (quote.notes ? `Observaciones: ${quote.notes}\n\n` : '') +
                `¬°Gracias por tu preferencia!\n` +
                `Maneki Store - Regalos Personalizados`;
            
            if (navigator.share) {
                navigator.share({
                    title: `Cotizaci√≥n ${quote.folio}`,
                    text: shareText,
                }).catch(err => console.log('Error sharing', err));
            } else {
                navigator.clipboard.writeText(shareText);
                alert('‚úÖ Cotizaci√≥n copiada al portapapeles. Puedes pegarla en WhatsApp u otro lugar.');
            }
        }
        
        function deleteQuote(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta cotizaci√≥n?')) {
                quotes = quotes.filter(q => q.id !== id);
                saveQuotes();
                renderQuotesTable();
            }
        }
        
        // ============== INVENTORY MODULE ==============
        
        function setupImageUpload() {
            document.getElementById('productImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        currentProductImage = event.target.result;
                        document.getElementById('previewImg').src = event.target.result;
                        document.getElementById('imagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function addVariant() {
            const type = document.getElementById('variantType').value.trim();
            const value = document.getElementById('variantValue').value.trim();
            
            if (type && value) {
                currentVariants.push({ type, value });
                renderVariantsList();
                document.getElementById('variantType').value = '';
                document.getElementById('variantValue').value = '';
            } else {
                alert('Por favor completa ambos campos de la variante');
            }
        }
        
        function renderVariantsList() {
            const container = document.getElementById('variantsList');
            container.innerHTML = currentVariants.map((v, index) => `
                <span class="variant-tag">
                    ${v.type}: ${v.value}
                    <button type="button" onclick="removeVariant(${index})" class="ml-2 text-red-500 hover:text-red-700">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `).join('');
        }
        
        function removeVariant(index) {
            currentVariants.splice(index, 1);
            renderVariantsList();
        }
        
        function generateSKU(categoryId) {
            const categoryMap = {
                'tazas': 'TAZ',
                'llaveros': 'LLV',
                'libretas': 'LIB',
                'peluches': 'PEL',
                'otros': 'OTR'
            };
            
            const prefix = categoryMap[categoryId] || 'PRD';
            const count = products.filter(p => p.category === categoryId).length + 1;
            return `MNK-${prefix}-${String(count).padStart(3, '0')}`;
        }
        
        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTable');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-gray-400">No hay productos en el inventario. Agrega tu primer producto.</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => {
                const category = categories.find(c => c.id === product.category);
                const categoryName = category ? category.name : product.category;
                
                let statusBadge = '';
                if (product.stock === 0) {
                    statusBadge = '<span class="badge-danger">Agotado</span>';
                } else if (product.stock <= 10) {
                    statusBadge = '<span class="badge-warning">Bajo Stock</span>';
                } else {
                    statusBadge = '<span class="badge-success">Disponible</span>';
                }
                
                const imageDisplay = product.imageUrl ? 
                    `<img src="${product.imageUrl}" class="w-16 h-16 object-cover rounded-lg">` :
                    `<span class="text-3xl">${product.image}</span>`;
                
                const variantsDisplay = product.variants && product.variants.length > 0 ?
                    product.variants.map(v => `<span class="variant-tag">${v.type}: ${v.value}</span>`).join('') :
                    '<span class="text-xs text-gray-400">Sin variantes</span>';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">${imageDisplay}</td>
                        <td class="px-6 py-4">
                            <div>
                                <span class="font-semibold text-gray-800">${product.name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-600 text-sm">${product.sku}</td>
                        <td class="px-6 py-4 text-gray-600 capitalize">${categoryName}</td>
                        <td class="px-6 py-4">${variantsDisplay}</td>
                        <td class="px-6 py-4 text-gray-800 font-semibold">$${product.price.toFixed(2)}</td>
                        <td class="px-6 py-4 text-gray-800 font-semibold">${product.stock}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4">
                            <button onclick="editProduct(${product.id})" 
                                    class="text-blue-600 hover:text-blue-800 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteProduct(${product.id})" 
                                    class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function openAddProductModal() {
            currentVariants = [];
            currentProductImage = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('addProductModal').classList.add('active');
        }
        
        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.remove('active');
            document.getElementById('addProductForm').reset();
            currentVariants = [];
            currentProductImage = null;
            renderVariantsList();
        }
        
        document.getElementById('addProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const categoryId = document.getElementById('productCategory').value;
            const category = categories.find(c => c.id === categoryId);
            let sku = document.getElementById('productSKU').value.trim();
            
            if (!sku) {
                sku = generateSKU(categoryId);
            }
            
            const maxId = products.length > 0 ? Math.max(...products.map(p => p.id)) : 0;
            
            const newProduct = {
                id: maxId + 1,
                name: document.getElementById('productName').value,
                category: categoryId,
                cost: parseFloat(document.getElementById('productCost').value),
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                image: category ? category.emoji : 'üì¶',
                imageUrl: currentProductImage,
                sku: sku,
                variants: [...currentVariants]
            };
            
            products.push(newProduct);
            saveProducts();
            
            renderInventoryTable();
            renderProducts();
            updateDashboard();
            closeAddProductModal();
            
            alert('‚úÖ Producto agregado exitosamente');
        });
        
        function editProduct(id) {
            alert('Funci√≥n de edici√≥n en desarrollo');
        }
        
        function deleteProduct(id) {
            if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
                products = products.filter(p => p.id !== id);
                saveProducts();
                renderInventoryTable();
                renderProducts();
                updateDashboard();
            }
        }
        
        // ============== BALANCE MODULE ==============
        
        function renderBalance() {
            const totalIncome = incomes.reduce((sum, i) => sum + i.amount, 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const totalReceivables = receivables.filter(r => r.status === 'pending').reduce((sum, r) => sum + r.amount, 0);
            const totalPayables = payables.filter(p => p.status === 'pending').reduce((sum, p) => sum + p.amount, 0);
            
            document.getElementById('totalIncome').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('totalReceivables').textContent = `$${totalReceivables.toFixed(2)}`;
            document.getElementById('totalPayables').textContent = `$${totalPayables.toFixed(2)}`;
            
            renderIncomeList();
            renderExpenseList();
            renderReceivablesList();
            renderPayablesList();
        }
        
        function renderIncomeList() {
            const container = document.getElementById('incomeList');
            container.innerHTML = incomes.map(income => `
                <div class="flex justify-between items-center p-3 bg-green-50 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${income.concept}</p>
                        <p class="text-xs text-gray-500">${income.date}</p>
                    </div>
                    <span class="font-bold text-green-600">+$${income.amount.toFixed(2)}</span>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center py-4">No hay ingresos registrados</p>';
        }
        
        function renderExpenseList() {
            const container = document.getElementById('expenseList');
            container.innerHTML = expenses.map(expense => `
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${expense.concept}</p>
                        <p class="text-xs text-gray-500">${expense.date}</p>
                    </div>
                    <span class="font-bold text-red-600">-$${expense.amount.toFixed(2)}</span>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center py-4">No hay egresos registrados</p>';
        }
        
        function renderReceivablesList() {
            const container = document.getElementById('receivablesList');
            container.innerHTML = receivables.map(rec => `
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${rec.client}</p>
                        <p class="text-xs text-gray-500">Vence: ${rec.dueDate}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-blue-600">$${rec.amount.toFixed(2)}</p>
                        <button onclick="markAsPaid('receivable', ${rec.id})" class="text-xs text-green-600 hover:text-green-700">
                            Marcar pagado
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center py-4">No hay cuentas por cobrar</p>';
        }
        
        function renderPayablesList() {
            const container = document.getElementById('payablesList');
            container.innerHTML = payables.map(pay => `
                <div class="flex justify-between items-center p-3 bg-orange-50 rounded-xl">
                    <div>
                        <p class="font-semibold text-gray-800">${pay.supplier}</p>
                        <p class="text-xs text-gray-500">Vence: ${pay.dueDate}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-orange-600">$${pay.amount.toFixed(2)}</p>
                        <button onclick="markAsPaid('payable', ${pay.id})" class="text-xs text-green-600 hover:text-green-700">
                            Marcar pagado
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center py-4">No hay cuentas por pagar</p>';
        }
        
        function openIncomeModal() {
            document.getElementById('transactionModalTitle').textContent = 'Nuevo Ingreso';
            document.getElementById('transactionType').value = 'income';
            document.getElementById('clientFieldContainer').classList.add('hidden');
            document.getElementById('transactionModal').classList.add('active');
        }
        
        function openExpenseModal() {
            document.getElementById('transactionModalTitle').textContent = 'Nuevo Egreso';
            document.getElementById('transactionType').value = 'expense';
            document.getElementById('clientFieldContainer').classList.add('hidden');
            document.getElementById('transactionModal').classList.add('active');
        }
        
        function openReceivableModal() {
            document.getElementById('transactionModalTitle').textContent = 'Nueva Cuenta por Cobrar';
            document.getElementById('transactionType').value = 'receivable';
            document.getElementById('clientFieldContainer').classList.remove('hidden');
            document.getElementById('transactionModal').classList.add('active');
        }
        
        function openPayableModal() {
            document.getElementById('transactionModalTitle').textContent = 'Nueva Cuenta por Pagar';
            document.getElementById('transactionType').value = 'payable';
            document.getElementById('clientFieldContainer').classList.remove('hidden');
            document.getElementById('transactionModal').classList.add('active');
        }
        
        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
            document.getElementById('transactionForm').reset();
        }
        
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const type = document.getElementById('transactionType').value;
            const concept = document.getElementById('transactionConcept').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const date = document.getElementById('transactionDate').value;
            const client = document.getElementById('transactionClient').value;
            
            if (type === 'income') {
                incomes.push({ id: incomes.length + 1, concept, amount, date });
                saveIncomes();
            } else if (type === 'expense') {
                expenses.push({ id: expenses.length + 1, concept, amount, date });
                saveExpenses();
            } else if (type === 'receivable') {
                receivables.push({ id: receivables.length + 1, client: client || concept, amount, dueDate: date, status: 'pending' });
                saveReceivables();
            } else if (type === 'payable') {
                payables.push({ id: payables.length + 1, supplier: client || concept, amount, dueDate: date, status: 'pending' });
                savePayables();
            }
            
            renderBalance();
            updateDashboard();
            closeTransactionModal();
            alert('‚úÖ Transacci√≥n registrada exitosamente');
        });
        
        function markAsPaid(type, id) {
            if (type === 'receivable') {
                const index = receivables.findIndex(r => r.id === id);
                if (index !== -1) {
                    const amount = receivables[index].amount;
                    receivables.splice(index, 1);
                    incomes.push({ id: incomes.length + 1, concept: 'Cobro realizado', amount, date: new Date().toISOString().split('T')[0] });
                    saveReceivables();
                    saveIncomes();
                }
            } else if (type === 'payable') {
                const index = payables.findIndex(p => p.id === id);
                if (index !== -1) {
                    const amount = payables[index].amount;
                    payables.splice(index, 1);
                    expenses.push({ id: expenses.length + 1, concept: 'Pago realizado', amount, date: new Date().toISOString().split('T')[0] });
                    savePayables();
                    saveExpenses();
                }
            }
            
            renderBalance();
            updateDashboard();
        }
        
        // ============== CLIENTS MODULE ==============
        
        function renderClientsTable() {
            const tbody = document.getElementById('clientsTable');
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-400">No hay clientes registrados</td></tr>';
                updateClientStats();
                return;
            }
            
            tbody.innerHTML = clients.map(client => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: #E6D5E6;">
                                <i class="fas fa-user" style="color: #C5A572;"></i>
                            </div>
                            <span class="font-semibold text-gray-800">${client.name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-600">${client.phone}</td>
                    <td class="px-6 py-4 text-gray-600">${client.email}</td>
                    <td class="px-6 py-4 text-gray-800 font-semibold">$${client.totalPurchases.toFixed(2)}</td>
                    <td class="px-6 py-4 text-gray-600">${client.lastPurchase}</td>
                    <td class="px-6 py-4">
                        ${client.isVIP ? '<span class="badge-vip">VIP</span>' : '<span class="badge-success">Regular</span>'}
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="editClient(${client.id})" 
                                class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteClient(${client.id})" 
                                class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            updateClientStats();
        }
        
        function updateClientStats() {
            document.getElementById('totalClients').textContent = clients.length;
            document.getElementById('vipClients').textContent = clients.filter(c => c.isVIP).length;
            const totalPurchases = clients.reduce((sum, c) => sum + c.totalPurchases, 0);
            document.getElementById('totalPurchases').textContent = `$${totalPurchases.toFixed(2)}`;
        }
        
        function openAddClientModal() {
            document.getElementById('addClientModal').classList.add('active');
        }
        
        function closeAddClientModal() {
            document.getElementById('addClientModal').classList.remove('active');
            document.getElementById('addClientForm').reset();
        }
        
        document.getElementById('addClientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const maxId = clients.length > 0 ? Math.max(...clients.map(c => c.id)) : 0;
            
            const newClient = {
                id: maxId + 1,
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                totalPurchases: 0,
                lastPurchase: new Date().toISOString().split('T')[0],
                isVIP: false
            };
            
            clients.push(newClient);
            saveClients();
            renderClientsTable();
            closeAddClientModal();
            
            alert('‚úÖ Cliente agregado exitosamente');
        });
        
        function editClient(id) {
            alert('Funci√≥n de edici√≥n en desarrollo');
        }
        
        function deleteClient(id) {
            if (confirm('¬øEst√°s seguro de eliminar este cliente?')) {
                clients = clients.filter(c => c.id !== id);
                saveClients();
                renderClientsTable();
            }
        }
        
        function setupClientSearch() {
            document.getElementById('searchClient').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredClients = clients.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) || 
                    c.email.toLowerCase().includes(searchTerm) ||
                    c.phone.includes(searchTerm)
                );
                
                const tbody = document.getElementById('clientsTable');
                tbody.innerHTML = filteredClients.map(client => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: #E6D5E6;">
                                    <i class="fas fa-user" style="color: #C5A572;"></i>
                                </div>
                                <span class="font-semibold text-gray-800">${client.name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-600">${client.phone}</td>
                        <td class="px-6 py-4 text-gray-600">${client.email}</td>
                        <td class="px-6 py-4 text-gray-800 font-semibold">$${client.totalPurchases.toFixed(2)}</td>
                        <td class="px-6 py-4 text-gray-600">${client.lastPurchase}</td>
                        <td class="px-6 py-4">
                            ${client.isVIP ? '<span class="badge-vip">VIP</span>' : '<span class="badge-success">Regular</span>'}
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="editClient(${client.id})" 
                                    class="text-blue-600 hover:text-blue-800 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteClient(${client.id})" 
                                    class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            });
        }
        
        // ============== CATEGORIES MODULE ==============
        
        function renderCategoriesGrid() {
            const grid = document.getElementById('categoriesGrid');
            grid.innerHTML = categories.map(category => {
                const productCount = products.filter(p => p.category === category.id).length;
                return `
                    <div class="category-card bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-start justify-between mb-4">
                            <div class="text-5xl">${category.emoji}</div>
                            <button onclick="deleteCategory('${category.id}')" 
                                    class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${category.name}</h3>
                        <p class="text-gray-600 text-sm">${productCount} producto${productCount !== 1 ? 's' : ''}</p>
                    </div>
                `;
            }).join('');
        }
        
        function openAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.add('active');
        }
        
        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('active');
            document.getElementById('addCategoryForm').reset();
        }
        
        document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('categoryName').value;
            const emoji = document.getElementById('categoryEmoji').value;
            const id = name.toLowerCase().replace(/\s+/g, '_');
            
            if (categories.find(c => c.id === id)) {
                alert('Ya existe una categor√≠a con ese nombre');
                return;
            }
            
            const newCategory = {
                id: id,
                name: name,
                emoji: emoji
            };
            
            categories.push(newCategory);
            saveCategories();
            renderCategoriesGrid();
            updateCategorySelects();
            closeAddCategoryModal();
            
            alert('‚úÖ Categor√≠a creada exitosamente');
        });
        
        function deleteCategory(categoryId) {
            const productsInCategory = products.filter(p => p.category === categoryId).length;
            
            if (productsInCategory > 0) {
                alert(`No puedes eliminar esta categor√≠a porque tiene ${productsInCategory} producto(s) asociado(s). Elimina o reasigna los productos primero.`);
                return;
            }
            
            if (confirm('¬øEst√°s seguro de eliminar esta categor√≠a?')) {
                categories = categories.filter(c => c.id !== categoryId);
                saveCategories();
                renderCategoriesGrid();
                updateCategorySelects();
            }
        }
        
        function updateCategorySelects() {
            const select = document.getElementById('productCategory');
            select.innerHTML = categories.map(cat => 
                `<option value="${cat.id}">${cat.emoji} ${cat.name}</option>`
            ).join('');
        }
        
        // ============== REPORTS MODULE ==============
        
        function initReports() {
            updateInventoryStats();
            renderTopProducts();
            renderSalesHistory();
            updateMonthlyStats();
            updatePaymentMethods();
        }
        
        function updateInventoryStats() {
            const inventoryValue = products.reduce((sum, p) => sum + (p.cost * p.stock), 0);
            const activeProducts = products.filter(p => p.stock > 0).length;
            const lowStockCount = products.filter(p => p.stock > 0 && p.stock <= 10).length;
            
            document.getElementById('inventoryValue').textContent = `$${inventoryValue.toFixed(2)}`;
            document.getElementById('activeProducts').textContent = activeProducts;
            document.getElementById('lowStockCount').textContent = lowStockCount;
        }
        
        function updateMonthlyStats() {
            const currentMonth = new Date().getMonth();
            const monthlySales = salesHistory
                .filter(s => new Date(s.date).getMonth() === currentMonth)
                .reduce((sum, s) => sum + s.total, 0);
            
            const monthlyCosts = products.reduce((sum, p) => sum + (p.cost * 10), 0);
            const monthlyProfit = monthlySales - monthlyCosts;
            
            const monthlyUnits = salesHistory
                .filter(s => new Date(s.date).getMonth() === currentMonth)
                .reduce((sum, s) => sum + s.products.length, 0);
            
            document.getElementById('monthlySales').textContent = `$${monthlySales.toFixed(2)}`;
            document.getElementById('monthlyProfit').textContent = `$${monthlyProfit.toFixed(2)}`;
            document.getElementById('monthlyUnitsSold').textContent = `${monthlyUnits} unidades`;
        }
        
        function updatePaymentMethods() {
            const cashSales = salesHistory.filter(s => s.method === 'Efectivo').length;
            const cardSales = salesHistory.filter(s => s.method === 'Tarjeta').length;
            const transferSales = salesHistory.filter(s => s.method === 'Transferencia').length;
            const totalSales = salesHistory.length;
            
            const cashPercentage = totalSales > 0 ? ((cashSales / totalSales) * 100).toFixed(0) : 0;
            const cardPercentage = totalSales > 0 ? ((cardSales / totalSales) * 100).toFixed(0) : 0;
            const transferPercentage = totalSales > 0 ? ((transferSales / totalSales) * 100).toFixed(0) : 0;
            
            document.getElementById('cashPercentage').textContent = `${cashPercentage}%`;
            document.getElementById('cardPercentage').textContent = `${cardPercentage}%`;
            document.getElementById('transferPercentage').textContent = `${transferPercentage}%`;
        }
        
        function renderTopProducts() {
            if (salesHistory.length === 0) {
                document.getElementById('topProductsList').innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No hay ventas registradas a√∫n</p>';
                return;
            }
            
            const productSales = {};
            
            salesHistory.forEach(sale => {
                sale.products.forEach(item => {
                    if (!productSales[item.id]) {
                        productSales[item.id] = {
                            name: item.name,
                            sales: 0,
                            revenue: 0
                        };
                    }
                    productSales[item.id].sales += item.quantity;
                    productSales[item.id].revenue += item.price * item.quantity;
                });
            });
            
            const topProducts = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 4);
            
            const container = document.getElementById('topProductsList');
            container.innerHTML = topProducts.map((product, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 text-white rounded-full flex items-center justify-center font-bold text-sm" style="background: #C5A572;">
                            ${index + 1}
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${product.name}</p>
                            <p class="text-xs text-gray-500">${product.sales} vendidos</p>
                        </div>
                    </div>
                    <span class="font-bold text-gray-800">$${product.revenue.toFixed(0)}</span>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center py-4">Sin datos disponibles</p>';
        }
        
        function initCategoryChart() {
            const canvas = document.getElementById('categoryChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
                categoryChart = null;
            }
            
            if (products.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px Inter';
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'center';
                ctx.fillText('No hay productos para mostrar', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const categorySales = {};
            categories.forEach(cat => {
                const categoryProducts = products.filter(p => p.category === cat.id);
                categorySales[cat.name] = categoryProducts.reduce((sum, p) => sum + (p.price * 5), 0);
            });
            
            const labels = [];
            const data = [];
            Object.entries(categorySales).forEach(([name, value]) => {
                if (value > 0) {
                    labels.push(name);
                    data.push(value);
                }
            });
            
            if (labels.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px Inter';
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'center';
                ctx.fillText('Sin ventas por categor√≠a', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#C5A572',
                            '#D8BFD8',
                            '#10B981',
                            '#F59E0B',
                            '#EF4444',
                            '#3B82F6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        }
                    }
                }
            });
        }
        
        function renderSalesHistory() {
            const tbody = document.getElementById('salesHistoryTable');
            
            if (salesHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400">No hay ventas registradas</td></tr>';
                return;
            }
            
            tbody.innerHTML = salesHistory.slice(-10).reverse().map(sale => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-3 text-gray-800">${sale.date}</td>
                    <td class="px-6 py-3 text-gray-800">${sale.customer}</td>
                    <td class="px-6 py-3 text-gray-600">${sale.products.length} item(s)</td>
                    <td class="px-6 py-3">
                        <span class="text-xs ${sale.method === 'Efectivo' ? 'text-green-600' : sale.method === 'Tarjeta' ? 'text-blue-600' : 'text-purple-600'}">
                            ${sale.method}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-gray-800 font-semibold">$${sale.total.toFixed(2)}</td>
                </tr>
            `).join('');
        }
        
        // ============== NAVIGATION ==============
        
        function showSection(sectionName) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
            
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('collapsed');
            }
            
            if (sectionName === 'reportes') {
                setTimeout(() => {
                    initCategoryChart();
                }, 150);
            }
        }
        
        function setupMobileMenu() {
            document.getElementById('openSidebar').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('collapsed');
            });
            
            document.getElementById('closeSidebar').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('collapsed');
            });
        }
        
        // ============== CHART ==============
        
        function initChart() {
            const last7Days = [];
            const salesByDay = {};
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(dateStr);
                salesByDay[dateStr] = 0;
            }
            
            salesHistory.forEach(sale => {
                if (salesByDay.hasOwnProperty(sale.date)) {
                    salesByDay[sale.date] += sale.total;
                }
            });
            
            const labels = last7Days.map(date => {
                const d = new Date(date);
                return ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'][d.getDay()];
            });
            
            const data = last7Days.map(date => salesByDay[date]);
            
            const ctx = document.getElementById('salesChart').getContext('2d');
            salesWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas ($)',
                        data: data,
                        backgroundColor: 'rgba(197, 165, 114, 0.8)',
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // ============== SEARCH FILTER ==============
        
        function setupSearchFilter() {
            document.getElementById('searchProduct').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredProducts = products.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.category.toLowerCase().includes(searchTerm) ||
                    (p.sku && p.sku.toLowerCase().includes(searchTerm))
                );
                
                const grid = document.getElementById('productsGrid');
                
                if (filteredProducts.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-400">No se encontraron productos</p></div>';
                    return;
                }
                
                grid.innerHTML = filteredProducts.map(product => {
                    const imageDisplay = product.imageUrl ? 
                        `<img src="${product.imageUrl}" class="w-full h-24 object-cover rounded-lg mb-2">` :
                        `<div class="text-4xl mb-3 text-center">${product.image}</div>`;
                        
                    return `
                        <div class="product-card bg-gray-50 rounded-xl p-4 border-2 border-transparent hover:shadow-lg" 
                             onclick="addToTicket(${product.id})">
                            ${imageDisplay}
                            <h4 class="font-semibold text-gray-800 text-sm mb-2 line-clamp-2">${product.name}</h4>
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold" style="color: #C5A572;">$${product.price.toFixed(2)}</span>
                                <span class="text-xs ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-orange-600' : 'text-red-600'}">
                                    Stock: ${product.stock}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }
        
    // ============ VENTAS EN ABONOS ============
let abonos = [];
let selectedAbonoMethod = 'cash';

function saveAbonos()      { sbSave('abonos', abonos); }

function openAbonoModal() {
    document.getElementById('abonoForm').reset();
    document.getElementById('abonoResta').value = '$0.00';
    document.getElementById('abonoModal').classList.add('active');
}
function closeAbonoModal() { document.getElementById('abonoModal').classList.remove('active'); }

function calcAbonoResta() {
    const total = parseFloat(document.getElementById('abonoTotal').value) || 0;
    const desc = parseFloat(document.getElementById('abonoDescuento').value) || 0;
    const anticipo = parseFloat(document.getElementById('abonoAnticipo').value) || 0;
    const totalDesc = total * (1 - desc / 100);
    document.getElementById('abonoResta').value = '$' + (totalDesc - anticipo).toFixed(2);
}

function selectAbonoMethod(btn, method) {
    selectedAbonoMethod = method;
    document.querySelectorAll('.abono-method-btn').forEach(b => { b.style.borderColor = '#E5E7EB'; b.style.background = 'white'; });
    btn.style.borderColor = '#C5A572'; btn.style.background = '#FFF9F0';
}

document.addEventListener('submit', function(e) {
    if (e.target.id !== 'abonoForm') return;
    e.preventDefault();
    const total = parseFloat(document.getElementById('abonoTotal').value) || 0;
    const desc = parseFloat(document.getElementById('abonoDescuento').value) || 0;
    const anticipo = parseFloat(document.getElementById('abonoAnticipo').value) || 0;
    const totalDesc = total * (1 - desc / 100);
    const abono = {
        id: Date.now(),
        folio: 'AB-' + String(abonos.length + 1).padStart(6, '0'),
        cliente: document.getElementById('abonoCliente').value,
        telefono: document.getElementById('abonoTelefono').value,
        redes: document.getElementById('abonoRedes').value,
        concepto: document.getElementById('abonoConcepto').value,
        total: totalDesc, descuento: desc,
        abonado: anticipo, resta: totalDesc - anticipo,
        notas: document.getElementById('abonoNotas').value,
        date: new Date().toISOString().split('T')[0],
        status: totalDesc - anticipo <= 0 ? 'pagado' : 'pendiente',
        historial: [{ fecha: new Date().toISOString().split('T')[0], monto: anticipo, metodo: 'Anticipo inicial' }]
    };
    abonos.push(abono); saveAbonos();
    if (anticipo > 0) { incomes.push({ id: Date.now(), concept: 'Anticipo ' + abono.folio, amount: anticipo, date: abono.date }); saveIncomes(); }
    renderAbonosTable(); closeAbonoModal(); alert('‚úÖ Venta en abonos registrada');
});

function renderAbonosTable() {
    const tbody = document.getElementById('abonosTable');
    if (!tbody) return;
    const pend = abonos.filter(a => a.status === 'pendiente').reduce((s, a) => s + a.resta, 0);
    const deuda = new Set(abonos.filter(a => a.status === 'pendiente').map(a => a.cliente)).size;
    const cobrado = abonos.reduce((s, a) => s + a.abonado, 0);
    document.getElementById('abonosTotalPendiente').textContent = '$' + pend.toFixed(2);
    document.getElementById('abonosClientesDeuda').textContent = deuda;
    document.getElementById('abonosTotalCobrado').textContent = '$' + cobrado.toFixed(2);
    if (abonos.length === 0) { tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-12 text-center text-gray-400">No hay ventas en abonos registradas</td></tr>'; return; }
    tbody.innerHTML = abonos.map(a => {
        const badge = a.status === 'pagado' ? '<span class="badge-success">Pagado</span>' : '<span class="badge-warning">Pendiente</span>';
        const contacto = a.telefono ? `<a href="https://wa.me/52${a.telefono.replace(/\D/g,'')}" target="_blank" class="text-green-600 text-xs"><i class="fab fa-whatsapp mr-1"></i>${a.telefono}</a>` : (a.redes || '-');
        return `<tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-semibold" style="color:#C5A572;">${a.folio}</td>
            <td class="px-4 py-3 text-sm font-semibold">${a.cliente}</td>
            <td class="px-4 py-3 text-sm">${contacto}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${a.concepto}</td>
            <td class="px-4 py-3 text-sm font-semibold">$${a.total.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm text-green-600 font-semibold">$${a.abonado.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm text-red-600 font-semibold">$${a.resta.toFixed(2)}</td>
            <td class="px-4 py-3">${badge}</td>
            <td class="px-4 py-3 flex gap-2">
                ${a.status === 'pendiente' ? `<button onclick="openRegistrarAbonoModal(${a.id})" class="text-green-600 hover:text-green-800 text-sm font-semibold"><i class="fas fa-plus-circle mr-1"></i>Abonar</button>` : ''}
                <button onclick="deleteAbono(${a.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash text-sm"></i></button>
            </td>
        </tr>`;
    }).join('');
}

function openRegistrarAbonoModal(id) {
    const a = abonos.find(x => x.id === id); if (!a) return;
    document.getElementById('abonoRegistrarId').value = id;
    document.getElementById('abonoDetalleInfo').innerHTML = `
        <div class="flex justify-between text-sm"><span class="text-gray-600">Cliente:</span><span class="font-semibold">${a.cliente}</span></div>
        <div class="flex justify-between text-sm"><span class="text-gray-600">Total:</span><span class="font-semibold">$${a.total.toFixed(2)}</span></div>
        <div class="flex justify-between text-sm"><span class="text-gray-600">Ya abonado:</span><span class="text-green-600 font-semibold">$${a.abonado.toFixed(2)}</span></div>
        <div class="flex justify-between text-sm font-bold border-t pt-2"><span>Resta:</span><span class="text-red-600">$${a.resta.toFixed(2)}</span></div>`;
    document.getElementById('abonoMonto').value = '';
    document.getElementById('registrarAbonoModal').classList.add('active');
}
function closeRegistrarAbonoModal() { document.getElementById('registrarAbonoModal').classList.remove('active'); }

document.addEventListener('submit', function(e) {
    if (e.target.id !== 'registrarAbonoForm') return;
    e.preventDefault();
    const id = parseInt(document.getElementById('abonoRegistrarId').value);
    const monto = parseFloat(document.getElementById('abonoMonto').value) || 0;
    const nota = document.getElementById('abonoNotaRegistro').value;
    const idx = abonos.findIndex(a => a.id === id); if (idx === -1) return;
    if (monto > abonos[idx].resta) { alert('El monto no puede ser mayor al saldo ($' + abonos[idx].resta.toFixed(2) + ')'); return; }
    abonos[idx].abonado += monto; abonos[idx].resta -= monto;
    abonos[idx].historial = abonos[idx].historial || [];
    abonos[idx].historial.push({ fecha: new Date().toISOString().split('T')[0], monto, metodo: selectedAbonoMethod, nota });
    if (abonos[idx].resta <= 0) { abonos[idx].resta = 0; abonos[idx].status = 'pagado'; }
    incomes.push({ id: Date.now(), concept: 'Abono ' + abonos[idx].folio + ' - ' + abonos[idx].cliente, amount: monto, date: new Date().toISOString().split('T')[0] });
    saveAbonos(); saveIncomes(); renderAbonosTable(); closeRegistrarAbonoModal(); alert('‚úÖ Abono registrado');
});

function deleteAbono(id) {
    if (confirm('¬øEliminar esta venta en abonos?')) { abonos = abonos.filter(a => a.id !== id); saveAbonos(); renderAbonosTable(); }
}

// ============ PEDIDOS POR ENCARGO ============
let pedidos = [];
let pedidoFiltroActual = 'todos';

function savePedidos()     { sbSave('pedidos', pedidos); }

function openPedidoModal(editId = null) {
    document.getElementById('pedidoForm').reset();
    document.getElementById('editPedidoId').value = '';
    document.getElementById('pedidoModalTitle').textContent = 'Nuevo Pedido por Encargo';
    document.getElementById('pedidoSubmitBtn').textContent = 'Guardar Pedido';
    document.getElementById('pedidoTotalDisplay').textContent = '$0.00';
    document.getElementById('pedidoSaldo').value = '';
    document.getElementById('pedidoFecha').value = new Date().toISOString().split('T')[0];
    if (editId) {
        const p = pedidos.find(x => x.id === editId); if (!p) return;
        document.getElementById('editPedidoId').value = editId;
        document.getElementById('pedidoModalTitle').textContent = 'Editar Pedido';
        document.getElementById('pedidoSubmitBtn').textContent = 'Actualizar Pedido';
        document.getElementById('pedidoCliente').value = p.cliente;
        document.getElementById('pedidoTelefono').value = p.telefono || '';
        document.getElementById('pedidoRedes').value = p.redes || '';
        document.getElementById('pedidoFecha').value = p.fecha;
        document.getElementById('pedidoEntrega').value = p.entrega;
        document.getElementById('pedidoConcepto').value = p.concepto;
        document.getElementById('pedidoCantidad').value = p.cantidad;
        document.getElementById('pedidoCosto').value = p.costo;
        document.getElementById('pedidoAnticipo').value = p.anticipo;
        document.getElementById('pedidoNotas').value = p.notas || '';
        calcPedidoTotal();
    }
    document.getElementById('pedidoModal').classList.add('active');
}
function closePedidoModal() { document.getElementById('pedidoModal').classList.remove('active'); }

function calcPedidoTotal() {
    const cant = parseFloat(document.getElementById('pedidoCantidad').value) || 1;
    const costo = parseFloat(document.getElementById('pedidoCosto').value) || 0;
    const anticipo = parseFloat(document.getElementById('pedidoAnticipo').value) || 0;
    const total = cant * costo;
    document.getElementById('pedidoTotalDisplay').textContent = '$' + total.toFixed(2);
    document.getElementById('pedidoSaldo').value = '$' + (total - anticipo).toFixed(2);
}

document.addEventListener('submit', function(e) {
    if (e.target.id !== 'pedidoForm') return;
    e.preventDefault();
    const editId = document.getElementById('editPedidoId').value;
    const cant = parseFloat(document.getElementById('pedidoCantidad').value) || 1;
    const costo = parseFloat(document.getElementById('pedidoCosto').value) || 0;
    const anticipo = parseFloat(document.getElementById('pedidoAnticipo').value) || 0;
    const total = cant * costo;
    const data = {
        cliente: document.getElementById('pedidoCliente').value,
        telefono: document.getElementById('pedidoTelefono').value,
        redes: document.getElementById('pedidoRedes').value,
        fecha: document.getElementById('pedidoFecha').value,
        entrega: document.getElementById('pedidoEntrega').value,
        concepto: document.getElementById('pedidoConcepto').value,
        cantidad: cant, costo, anticipo, total,
        resta: total - anticipo,
        notas: document.getElementById('pedidoNotas').value,
        status: 'confirmado'
    };
    if (editId) {
        const idx = pedidos.findIndex(p => p.id === parseInt(editId));
        if (idx !== -1) { pedidos[idx] = { ...pedidos[idx], ...data }; }
    } else {
        data.id = Date.now();
        data.folio = 'PED-' + String(pedidos.length + 1).padStart(6, '0');
        data.fechaCreacion = new Date().toISOString().split('T')[0];
        if (anticipo > 0) { incomes.push({ id: Date.now(), concept: 'Anticipo ' + data.folio, amount: anticipo, date: data.fecha }); saveIncomes(); }
        pedidos.push(data);
    }
    savePedidos(); renderPedidosTable(); closePedidoModal();
    alert(editId ? '‚úÖ Pedido actualizado' : '‚úÖ Pedido registrado');
});

function renderPedidosTable(filtro = pedidoFiltroActual) {
    pedidoFiltroActual = filtro;
    const activos = pedidos.filter(p => p.status !== 'finalizado');
    document.getElementById('pedidosActivos').textContent = activos.length;
    document.getElementById('pedidosPorCobrar').textContent = '$' + activos.reduce((s, p) => s + p.resta, 0).toFixed(2);
    document.getElementById('pedidosAnticipos').textContent = '$' + activos.reduce((s, p) => s + p.anticipo, 0).toFixed(2);
    const mes = new Date().toISOString().slice(0, 7);
    document.getElementById('pedidosMes').textContent = activos.filter(p => p.entrega && p.entrega.startsWith(mes)).length;
    let lista = filtro === 'todos' ? activos : activos.filter(p => p.status === filtro);
    const tbody = document.getElementById('pedidosTable');
    if (!tbody) return;
    if (lista.length === 0) { tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-12 text-center text-gray-400">No hay pedidos</td></tr>'; return; }
    const labels = { confirmado: '‚úÖ Confirmado', pago: 'üí∞ Pago', produccion: 'üîß Producci√≥n', envio: 'üì¶ Env√≠o', salida: 'üöö Sali√≥', retirar: 'üè™ Retirar' };
    tbody.innerHTML = lista.map(p => {
        const hoy = new Date().toISOString().split('T')[0];
        const vencido = p.entrega && p.entrega < hoy;
        const contacto = p.telefono ? `<a href="https://wa.me/52${p.telefono.replace(/\D/g,'')}" target="_blank" class="text-green-600 text-xs"><i class="fab fa-whatsapp"></i> ${p.telefono}</a>` : (p.redes || '-');
        return `<tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-semibold" style="color:#C5A572;">${p.folio}</td>
            <td class="px-4 py-3"><p class="font-semibold text-sm">${p.cliente}</p><p class="text-xs text-gray-500">${contacto}</p></td>
            <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate">${p.concepto}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${p.fecha}</td>
            <td class="px-4 py-3 text-sm font-semibold ${vencido ? 'text-red-600' : 'text-gray-800'}">${p.entrega} ${vencido ? '‚ö†Ô∏è' : ''}</td>
            <td class="px-4 py-3 text-sm font-semibold">$${p.total.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm text-green-600 font-semibold">$${p.anticipo.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm text-red-600 font-semibold">$${p.resta.toFixed(2)}</td>
            <td class="px-4 py-3"><span class="text-xs font-semibold px-2 py-1 rounded-full bg-gray-100">${labels[p.status] || p.status}</span></td>
            <td class="px-4 py-3 flex gap-2 items-center">
                <button onclick="openPedidoStatusModal(${p.id})" class="text-blue-600 hover:text-blue-800" title="Estado"><i class="fas fa-exchange-alt"></i></button>
                <button onclick="openPedidoModal(${p.id})" class="text-yellow-500 hover:text-yellow-700" title="Editar"><i class="fas fa-edit"></i></button>
                <button onclick="deletePedido(${p.id})" class="text-red-500 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');
}

function filterPedidos(filtro, btn) {
    document.querySelectorAll('.pedido-filter').forEach(b => { b.style.borderColor = '#E5E7EB'; b.style.background = 'white'; b.style.color = '#4B5563'; });
    btn.style.borderColor = '#C5A572'; btn.style.background = '#FFF9F0'; btn.style.color = '#C5A572';
    renderPedidosTable(filtro);
}

function openPedidoStatusModal(id) {
    document.getElementById('pedidoStatusId').value = id;
    const p = pedidos.find(x => x.id === id);
    document.getElementById('pedidoStatusFolio').textContent = p ? p.folio : '';
    document.getElementById('pedidoStatusModal').classList.add('active');
}
function closePedidoStatusModal() { document.getElementById('pedidoStatusModal').classList.remove('active'); }

function setPedidoStatus(status) {
    const id = parseInt(document.getElementById('pedidoStatusId').value);
    const idx = pedidos.findIndex(p => p.id === id); if (idx === -1) return;
    if (status === 'finalizado') {
        if (!confirm('¬øFinalizar este pedido? Pasar√° al historial de ventas.')) return;
        const p = pedidos[idx];
        salesHistory.push({
            id: Date.now(), folio: p.folio,
            date: new Date().toISOString().split('T')[0],
            time: new Date().toLocaleTimeString('es-MX'),
            customer: p.cliente, concept: p.concepto, note: p.notas || '',
            products: [{ name: p.concepto, price: p.total, quantity: 1, cost: 0 }],
            subtotal: p.total, discount: 0, tax: 0, total: p.total,
            method: 'Pedido finalizado', type: 'pedido'
        });
        if (p.resta > 0) { incomes.push({ id: Date.now(), concept: 'Liquidaci√≥n ' + p.folio, amount: p.resta, date: new Date().toISOString().split('T')[0] }); saveIncomes(); }
        pedidos.splice(idx, 1);
        savePedidos(); saveSalesHistory();
    } else {
        pedidos[idx].status = status; savePedidos();
    }
    renderPedidosTable(); closePedidoStatusModal();
    alert(status === 'finalizado' ? 'üéâ Pedido finalizado y agregado al historial' : '‚úÖ Estado actualizado');
}

function deletePedido(id) {
    if (confirm('¬øEliminar este pedido?')) { pedidos = pedidos.filter(p => p.id !== id); savePedidos(); renderPedidosTable(); }
}

// ============ EDITAR PRODUCTOS (FIX) ============
function editProduct(id) {
    const p = products.find(x => x.id === id); if (!p) return;
    currentVariants = [...(p.variants || [])];
    currentProductImage = null;
    document.getElementById('editProductId').value = id;
    document.getElementById('productModalTitle').textContent = 'Editar Producto';
    document.getElementById('productSubmitBtn').textContent = 'Actualizar Producto';
    document.getElementById('productName').value = p.name;
    document.getElementById('productSKU').value = p.sku || '';
    updateCategorySelects();
    setTimeout(() => { document.getElementById('productCategory').value = p.category; }, 80);
    document.getElementById('productCost').value = p.cost;
    document.getElementById('productPrice').value = p.price;
    document.getElementById('productStock').value = p.stock;
    if (p.imageUrl) { document.getElementById('previewImg').src = p.imageUrl; document.getElementById('imagePreview').classList.remove('hidden'); }
    else { document.getElementById('imagePreview').classList.add('hidden'); }
    renderVariantsList();
    document.getElementById('addProductModal').classList.add('active');
}

// Inicializar nuevas secciones al cargar

    </script>
<!-- MODAL: Nueva Venta en Abonos -->
<div id="abonoModal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-8 animate-fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Nueva Venta en Abonos</h3>
            <button onclick="closeAbonoModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="abonoForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Cliente *</label><input type="text" id="abonoCliente" required class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono / WhatsApp</label><input type="text" id="abonoTelefono" placeholder="Ej: 81 1234 5678" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            </div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Facebook / Instagram</label><input type="text" id="abonoRedes" placeholder="@usuario o link de perfil" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
<!-- Selector de productos del inventario para Abono -->
<div>
  <label class="block text-sm font-semibold text-gray-700 mb-2">Productos del Inventario</label>
  <div class="flex gap-2 mb-2">
    <select id="abonoProductoSelect" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl outline-none">
      <option value="">-- Seleccionar producto --</option>
    </select>
    <input type="number" id="abonoProductoCantidad" placeholder="Cant." min="1" value="1" class="w-24 px-3 py-3 border border-gray-200 rounded-xl outline-none">
    <button type="button" onclick="agregarProductoAbono()" class="px-4 py-3 text-white rounded-xl font-semibold" style="background:#C5A572">Agregar</button>
  </div>
  <div id="abonoProductosList" class="space-y-2 max-h-40 overflow-y-auto"></div>
</div>
<div><label class="block text-sm font-semibold text-gray-700 mb-2">Concepto *</label><input type="text" id="abonoConcepto" required placeholder="¬øQu√© se vendi√≥?" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Total de la Venta *</label><input type="number" id="abonoTotal" required step="0.01" min="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" oninput="calcAbonoResta()"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Descuento (%)</label><input type="number" id="abonoDescuento" value="0" min="0" max="100" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" oninput="calcAbonoResta()"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Anticipo Inicial *</label><input type="number" id="abonoAnticipo" required step="0.01" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" oninput="calcAbonoResta()"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Saldo Pendiente</label><input type="text" id="abonoResta" readonly class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none bg-gray-50 font-bold text-red-600"></div>
            </div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Notas</label><textarea id="abonoNotas" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none resize-none"></textarea></div>
            <button type="submit" class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg"><i class="fas fa-save mr-2"></i>Registrar Venta en Abonos</button>
        </form>
    </div>
</div>

<!-- MODAL: Registrar Abono -->
<div id="registrarAbonoModal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Registrar Abono</h3>
            <button onclick="closeRegistrarAbonoModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div id="abonoDetalleInfo" class="bg-gray-50 rounded-xl p-4 mb-4 space-y-2 text-sm"></div>
        <form id="registrarAbonoForm" class="space-y-4">
            <input type="hidden" id="abonoRegistrarId">
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Monto del Abono *</label><input type="number" id="abonoMonto" required step="0.01" min="0.01" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none text-xl font-bold"></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">M√©todo de Pago</label>
                <div class="grid grid-cols-3 gap-2">
                    <button type="button" onclick="selectAbonoMethod(this,'cash')" class="abono-method-btn border-2 rounded-xl py-3 flex flex-col items-center cursor-pointer" style="border-color:#C5A572;background:#FFF9F0;"><i class="fas fa-money-bill-wave text-green-600 text-xl mb-1"></i><p class="text-xs font-semibold">Efectivo</p></button>
                    <button type="button" onclick="selectAbonoMethod(this,'card')" class="abono-method-btn border-2 border-gray-200 rounded-xl py-3 flex flex-col items-center cursor-pointer"><i class="fas fa-credit-card text-blue-600 text-xl mb-1"></i><p class="text-xs font-semibold">Tarjeta</p></button>
                    <button type="button" onclick="selectAbonoMethod(this,'transfer')" class="abono-method-btn border-2 border-gray-200 rounded-xl py-3 flex flex-col items-center cursor-pointer"><i class="fas fa-exchange-alt text-purple-600 text-xl mb-1"></i><p class="text-xs font-semibold">Transfer.</p></button>
                </div>
            </div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nota</label><input type="text" id="abonoNotaRegistro" placeholder="Nota opcional" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            <button type="submit" class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg"><i class="fas fa-check mr-2"></i>Confirmar Abono</button>
        </form>
    </div>
</div>

<!-- MODAL: Nuevo/Editar Pedido -->
<div id="pedidoModal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-8 animate-fade-in max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800" id="pedidoModalTitle">Nuevo Pedido</h3>
            <button onclick="closePedidoModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="pedidoForm" class="space-y-4">
            <input type="hidden" id="editPedidoId">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Cliente *</label><input type="text" id="pedidoCliente" required class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono / WhatsApp</label><input type="text" id="pedidoTelefono" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            </div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Facebook / Instagram</label><input type="text" id="pedidoRedes" placeholder="@usuario o link" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Fecha del Pedido *</label><input type="date" id="pedidoFecha" required class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Entrega *</label><input type="date" id="pedidoEntrega" required class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none"></div>
            </div>
            <!-- Selector de productos del inventario para Pedido -->
<div>
  <label class="block text-sm font-semibold text-gray-700 mb-2">Productos del Inventario (opcional)</label>
  <div class="flex gap-2 mb-2">
    <select id="pedidoProductoSelect" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl outline-none">
      <option value="">-- Seleccionar producto --</option>
    </select>
    <input type="number" id="pedidoProductoCantidad" placeholder="Cant." min="1" value="1" class="w-24 px-3 py-3 border border-gray-200 rounded-xl outline-none">
    <button type="button" onclick="agregarProductoPedido()" class="px-4 py-3 text-white rounded-xl font-semibold" style="background:#C5A572">Agregar</button>
  </div>
  <div id="pedidoProductosList" class="space-y-2 max-h-40 overflow-y-auto"></div>
</div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">¬øQu√© pidieron? *</label><textarea id="pedidoConcepto" required rows="3" placeholder="Describe el pedido detalladamente..." class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none resize-none"></textarea></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Cantidad</label><input type="number" id="pedidoCantidad" value="1" min="1" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" oninput="calcPedidoTotal()"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-2">Costo Unitario *</label><input type="number" id="pedidoCosto" required step="0.01" min="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none" oninput="calcPedidoTotal()"></div>
            </div>
            <div class="bg-gray-50 rounded-xl p-4 space-y-3">
                <div class="flex justify-between text-sm"><span class="text-gray-600">Total del pedido:</span><span class="font-bold text-lg" id="pedidoTotalDisplay">$0.00</span></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-semibold text-gray-700 mb-1">Anticipo Recibido</label><input type="number" id="pedidoAnticipo" step="0.01" min="0" value="0" class="w-full px-3 py-2 border border-gray-200 rounded-xl outline-none" oninput="calcPedidoTotal()"></div>
                    <div><label class="block text-xs font-semibold text-gray-700 mb-1">Saldo Pendiente</label><input type="text" id="pedidoSaldo" readonly class="w-full px-3 py-2 bg-white border border-gray-200 rounded-xl font-bold text-red-600"></div>
                </div>
            </div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2">Notas adicionales</label><textarea id="pedidoNotas" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl outline-none resize-none"></textarea></div>
            <button type="submit" class="btn-primary w-full py-4 rounded-xl text-white font-bold text-lg"><i class="fas fa-save mr-2"></i><span id="pedidoSubmitBtn">Guardar Pedido</span></button>
        </form>
    </div>
</div>

<!-- MODAL: Estado del Pedido -->
<div id="pedidoStatusModal" class="modal">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Cambiar Estado del Pedido</h3>
            <button onclick="closePedidoStatusModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <input type="hidden" id="pedidoStatusId">
        <p class="text-sm text-gray-500 mb-4">Pedido: <span id="pedidoStatusFolio" class="font-bold" style="color:#C5A572;"></span></p>
        <div class="space-y-2">
            <button onclick="setPedidoStatus('confirmado')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-yellow-300 cursor-pointer text-left bg-white"><span class="text-2xl">‚úÖ</span><p class="font-semibold">Confirmado</p></button>
            <button onclick="setPedidoStatus('pago')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-green-300 cursor-pointer text-left bg-white"><span class="text-2xl">üí∞</span><p class="font-semibold">Pago</p></button>
            <button onclick="setPedidoStatus('produccion')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-blue-300 cursor-pointer text-left bg-white"><span class="text-2xl">üîß</span><p class="font-semibold">En Producci√≥n</p></button>
            <button onclick="setPedidoStatus('envio')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-purple-300 cursor-pointer text-left bg-white"><span class="text-2xl">üì¶</span><p class="font-semibold">En Env√≠o</p></button>
            <button onclick="setPedidoStatus('salida')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-orange-300 cursor-pointer text-left bg-white"><span class="text-2xl">üöö</span><p class="font-semibold">Sali√≥ a Entregar</p></button>
            <button onclick="setPedidoStatus('retirar')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-gray-200 hover:border-teal-300 cursor-pointer text-left bg-white"><span class="text-2xl">üè™</span><p class="font-semibold">Listo para Retirar</p></button>
            <button onclick="setPedidoStatus('finalizado')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl border-2 border-emerald-300 bg-emerald-50 cursor-pointer text-left"><span class="text-2xl">üéâ</span><p class="font-semibold text-emerald-700">Finalizado ‚Üí pasa a Historial</p></button>
        </div>
    </div>
</div>
<script>
// ============================================================
// PRODUCTOS EN ABONO
// ============================================================
let abonoProductosSeleccionados = [];

function poblarSelectAbono() {
    const sel = document.getElementById('abonoProductoSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Seleccionar producto --</option>';
    products.filter(p => p.stock > 0).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name + ' (Stock: ' + p.stock + ') - $' + p.price;
        sel.appendChild(opt);
    });
}

function agregarProductoAbono() {
    const sel = document.getElementById('abonoProductoSelect');
    const cantInput = document.getElementById('abonoProductoCantidad');
    const pid = sel.value;
    const cant = parseInt(cantInput.value) || 1;
    if (!pid) return alert('Selecciona un producto');
    const prod = products.find(p => String(p.id) === String(pid));
    if (!prod) return;
    if (cant > prod.stock) return alert('Stock insuficiente. Disponible: ' + prod.stock);
    const existing = abonoProductosSeleccionados.find(x => String(x.id) === String(pid));
    if (existing) {
        if (existing.quantity + cant > prod.stock) return alert('Stock insuficiente.');
        existing.quantity += cant;
    } else {
        abonoProductosSeleccionados.push({ id: prod.id, name: prod.name, price: prod.price, quantity: cant });
    }
    renderAbonoProductosList();
    const total = abonoProductosSeleccionados.reduce((s, x) => s + x.price * x.quantity, 0);
    document.getElementById('abonoTotal').value = total.toFixed(2);
    calcAbonoResta();
}

function renderAbonoProductosList() {
    const container = document.getElementById('abonoProductosList');
    if (!container) return;
    if (abonoProductosSeleccionados.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm">Sin productos seleccionados</p>';
        return;
    }
    container.innerHTML = abonoProductosSeleccionados.map((item, i) => '<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm"><span class="font-medium">' + item.name + '</span><span class="text-gray-500">x' + item.quantity + ' ‚Äî $' + (item.price * item.quantity).toFixed(2) + '</span><button type="button" onclick="quitarProductoAbono(' + i + ')" class="text-red-400 hover:text-red-600 ml-2"><i class="fas fa-times"></i></button></div>').join('');
}

function quitarProductoAbono(index) {
    abonoProductosSeleccionados.splice(index, 1);
    renderAbonoProductosList();
    const total = abonoProductosSeleccionados.reduce((s, x) => s + x.price * x.quantity, 0);
    if (total > 0) { document.getElementById('abonoTotal').value = total.toFixed(2); calcAbonoResta(); }
}

// ============================================================
// PRODUCTOS EN PEDIDO
// ============================================================
let pedidoProductosSeleccionados = [];

function poblarSelectPedido() {
    const sel = document.getElementById('pedidoProductoSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Seleccionar producto --</option>';
    products.filter(p => p.stock > 0).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name + ' (Stock: ' + p.stock + ') - $' + p.price;
        sel.appendChild(opt);
    });
}

function agregarProductoPedido() {
    const sel = document.getElementById('pedidoProductoSelect');
    const cantInput = document.getElementById('pedidoProductoCantidad');
    const pid = sel.value;
    const cant = parseInt(cantInput.value) || 1;
    if (!pid) return alert('Selecciona un producto');
    const prod = products.find(p => String(p.id) === String(pid));
    if (!prod) return;
    if (cant > prod.stock) return alert('Stock insuficiente. Disponible: ' + prod.stock);
    const existing = pedidoProductosSeleccionados.find(x => String(x.id) === String(pid));
    if (existing) {
        existing.quantity += cant;
    } else {
        pedidoProductosSeleccionados.push({ id: prod.id, name: prod.name, price: prod.price, quantity: cant });
    }
    renderPedidoProductosList();
    const total = pedidoProductosSeleccionados.reduce((s, x) => s + x.price * x.quantity, 0);
    if (total > 0) {
        document.getElementById('pedidoCosto').value = (total / (parseInt(document.getElementById('pedidoCantidad').value) || 1)).toFixed(2);
        calcPedidoTotal();
    }
}

function renderPedidoProductosList() {
    const container = document.getElementById('pedidoProductosList');
    if (!container) return;
    if (pedidoProductosSeleccionados.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm">Sin productos seleccionados</p>';
        return;
    }
    container.innerHTML = pedidoProductosSeleccionados.map((item, i) => '<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm"><span class="font-medium">' + item.name + '</span><span class="text-gray-500">x' + item.quantity + ' ‚Äî $' + (item.price * item.quantity).toFixed(2) + '</span><button type="button" onclick="quitarProductoPedido(' + i + ')" class="text-red-400 hover:text-red-600 ml-2"><i class="fas fa-times"></i></button></div>').join('');
}

function quitarProductoPedido(index) {
    pedidoProductosSeleccionados.splice(index, 1);
    renderPedidoProductosList();
}

// ============================================================
// HOOK: poblar selects al abrir modales
// ============================================================
const _origOpenAbonoModal = openAbonoModal;
openAbonoModal = function() {
    abonoProductosSeleccionados = [];
    _origOpenAbonoModal();
    poblarSelectAbono();
    renderAbonoProductosList();
};

const _origOpenPedidoModal = openPedidoModal;
openPedidoModal = function(editId) {
    pedidoProductosSeleccionados = [];
    _origOpenPedidoModal(editId || null);
    poblarSelectPedido();
    renderPedidoProductosList();
};

// ============================================================
// HOOK: descontar stock y registrar en salesHistory al guardar abono
// ============================================================
document.addEventListener('submit', function(e) {
    if (e.target.id !== 'abonoForm') return;
    // Descontar stock
    abonoProductosSeleccionados.forEach(item => {
        const prod = products.find(p => String(p.id) === String(item.id));
        if (prod) prod.stock -= item.quantity;
    });
    if (abonoProductosSeleccionados.length > 0) saveProducts();

    // Registrar en salesHistory
    setTimeout(function() {
        const lastAbono = abonos[abonos.length - 1];
        if (lastAbono) {
            const saleRecord = {
                id: 'AB-' + Date.now(),
                folio: lastAbono.folio || ('AB-' + abonos.length),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('es-MX'),
                customer: lastAbono.cliente,
                concept: lastAbono.concepto,
                products: abonoProductosSeleccionados.length > 0
                    ? [...abonoProductosSeleccionados]
                    : [{ id: 'abono', name: lastAbono.concepto, price: lastAbono.total, quantity: 1 }],
                subtotal: lastAbono.total,
                discount: 0,
                tax: 0,
                total: lastAbono.total,
                method: 'Abono',
                type: 'abono'
            };
            salesHistory.push(saleRecord);
            saveSalesHistory();
        }
        abonoProductosSeleccionados = [];
    }, 200);
});

// ============================================================
// HOOK: descontar stock al marcar pedido como Entregado/Finalizado
// ============================================================
const _origSetPedidoStatus = setPedidoStatus;
setPedidoStatus = function(id, status) {
    if (status === 'entregado' || status === 'finalizado') {
        const p = pedidos.find(x => x.id === id);
        if (p && p.productosInventario && p.productosInventario.length > 0) {
            p.productosInventario.forEach(item => {
                const prod = products.find(pr => String(pr.id) === String(item.id));
                if (prod) prod.stock -= item.quantity;
            });
            saveProducts();
            const saleRecord = {
                id: 'PE-' + Date.now(),
                folio: p.folio || ('PE-' + id),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('es-MX'),
                customer: p.cliente,
                concept: p.concepto,
                products: [...p.productosInventario],
                subtotal: p.total,
                discount: 0,
                tax: 0,
                total: p.total,
                method: 'Pedido',
                type: 'pedido'
            };
            salesHistory.push(saleRecord);
            saveSalesHistory();
        }
    }
    _origSetPedidoStatus(id, status);
};

// ============================================================
// HOOK: guardar productos seleccionados en pedido al submit
// ============================================================
document.addEventListener('submit', function(e) {
    if (e.target.id !== 'pedidoForm') return;
    setTimeout(function() {
        const lastPedido = pedidos[pedidos.length - 1];
        if (lastPedido && pedidoProductosSeleccionados.length > 0) {
            lastPedido.productosInventario = [...pedidoProductosSeleccionados];
            savePedidos();
        }
        pedidoProductosSeleccionados = [];
    }, 200);
});

// ============================================================
// REPORTES: parchar para incluir abonos y pedidos
// ============================================================
const _origRenderTopProducts = renderTopProducts;
renderTopProducts = function() {
    if (salesHistory.length === 0) {
        const el = document.getElementById('topProductsList');
        if (el) el.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No hay ventas registradas a√∫n</p>';
        return;
    }
    const productSales = {};
    salesHistory.forEach(function(sale) {
        (sale.products || []).forEach(function(item) {
            if (!productSales[item.id]) {
                productSales[item.id] = { name: item.name, sales: 0, revenue: 0 };
            }
            productSales[item.id].sales += item.quantity;
            productSales[item.id].revenue += item.price * item.quantity;
        });
    });
    const topProducts = Object.values(productSales).sort((a, b) => b.revenue - a.revenue).slice(0, 4);
    const container = document.getElementById('topProductsList');
    if (!container) return;
    container.innerHTML = topProducts.map(function(product, index) {
        return '<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl"><div class="flex items-center gap-3"><div class="w-8 h-8 text-white rounded-full flex items-center justify-center font-bold text-sm" style="background:#C5A572">' + (index+1) + '</div><div><p class="font-semibold text-gray-800">' + product.name + '</p><p class="text-xs text-gray-500">' + product.sales + ' vendidos</p></div></div><span class="font-bold text-gray-800">$' + product.revenue.toFixed(0) + '</span></div>';
    }).join('') || '<p class="text-gray-400 text-sm text-center py-4">Sin datos</p>';
};

const _origRenderSalesHistory = renderSalesHistory;
renderSalesHistory = function() {
    const tbody = document.getElementById('salesHistoryTable');
    if (!tbody) return;
    if (salesHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400">No hay ventas registradas</td></tr>';
        return;
    }
    tbody.innerHTML = salesHistory.slice(-20).reverse().map(function(sale) {
        const typeLabel = sale.type === 'abono' ? 'üü° Abono' : sale.type === 'pedido' ? 'üü£ Pedido' : 'üü¢ POS';
        const methodColor = sale.method === 'Efectivo' ? 'text-green-600' : sale.method === 'Tarjeta' ? 'text-blue-600' : sale.method === 'Abono' ? 'text-yellow-600' : sale.method === 'Pedido' ? 'text-purple-600' : 'text-gray-600';
        return '<tr class="hover:bg-gray-50"><td class="px-6 py-3 text-gray-800">' + sale.date + '</td><td class="px-6 py-3 text-gray-800">' + sale.customer + ' <span class="text-xs ' + methodColor + '">' + typeLabel + '</span></td><td class="px-6 py-3 text-gray-600">' + (sale.products || []).length + ' item(s)</td><td class="px-6 py-3"><span class="text-xs ' + methodColor + '">' + sale.method + '</span></td><td class="px-6 py-3 text-gray-800 font-semibold">$' + sale.total.toFixed(2) + '</td></tr>';
    }).join('');
};

const _origUpdateMonthlyStats = updateMonthlyStats;
updateMonthlyStats = function() {
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const monthlySales = salesHistory
        .filter(function(s) { const d = new Date(s.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; })
        .reduce(function(sum, s) { return sum + s.total; }, 0);
    const monthlyUnits = salesHistory
        .filter(function(s) { const d = new Date(s.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; })
        .reduce(function(sum, s) { return sum + (s.products || []).reduce(function(a, p) { return a + p.quantity; }, 0); }, 0);
    const monthlyProfit = monthlySales * 0.4;
    const elSales = document.getElementById('monthlySales');
    const elProfit = document.getElementById('monthlyProfit');
    const elUnits = document.getElementById('monthlyUnitsSold');
    if (elSales) elSales.textContent = '$' + monthlySales.toFixed(2);
    if (elProfit) elProfit.textContent = '$' + monthlyProfit.toFixed(2);
    if (elUnits) elUnits.textContent = monthlyUnits + ' unidades';
};

const _origUpdatePaymentMethods = updatePaymentMethods;
updatePaymentMethods = function() {
    const totalSales = salesHistory.length;
    const elCash = document.getElementById('cashPercentage');
    const elCard = document.getElementById('cardPercentage');
    const elTransfer = document.getElementById('transferPercentage');
    if (totalSales === 0) {
        if (elCash) elCash.textContent = '0%';
        if (elCard) elCard.textContent = '0%';
        if (elTransfer) elTransfer.textContent = '0%';
        return;
    }
    const cashSales = salesHistory.filter(function(s) { return s.method === 'Efectivo'; }).length;
    const cardSales = salesHistory.filter(function(s) { return s.method === 'Tarjeta'; }).length;
    const transferSales = salesHistory.filter(function(s) { return s.method === 'Transferencia'; }).length;
    if (elCash) elCash.textContent = ((cashSales/totalSales)*100).toFixed(0) + '%';
    if (elCard) elCard.textContent = ((cardSales/totalSales)*100).toFixed(0) + '%';
    if (elTransfer) elTransfer.textContent = ((transferSales/totalSales)*100).toFixed(0) + '%';
};

// ============================================================
// DESCARGA DE REPORTE CSV
// ============================================================
function descargarReporteVentas() {
    if (salesHistory.length === 0) return alert('No hay ventas para exportar.');
    const headers = ['Folio','Fecha','Hora','Cliente','Tipo','Productos','Total','M√©todo'];
    const rows = salesHistory.map(function(s) {
        return [
            s.folio || s.id,
            s.date,
            s.time || '',
            '"' + s.customer + '"',
            s.type === 'abono' ? 'Abono' : s.type === 'pedido' ? 'Pedido' : 'POS',
            '"' + (s.products || []).map(function(p) { return p.name + ' x' + p.quantity; }).join('; ') + '"',
            s.total.toFixed(2),
            s.method || ''
        ];
    });
    const csvContent = [headers.join(',')].concat(rows.map(function(r) { return r.join(','); })).join('\n');
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'Reporte_Ventas_Maneki_' + new Date().toISOString().split('T')[0] + '.csv';
    link.click();
    URL.revokeObjectURL(url);
}

// ============================================================
// FIX: EDITAR PRODUCTO (con flag modoEdicion, sin conflictos)
// ============================================================
let modoEdicion = false;
let edicionProductoId = null;

editProduct = function(id) {
    const p = products.find(function(x) { return x.id === id; });
    if (!p) return;

    modoEdicion = true;
    edicionProductoId = id;

    document.getElementById('addProductForm').reset();
    currentVariants = Array.isArray(p.variants) ? [...p.variants] : [];
    currentProductImage = p.imageUrl || null;

    document.getElementById('productName').value = p.name;
    document.getElementById('productCategory').value = p.category;
    document.getElementById('productCost').value = p.cost;
    document.getElementById('productPrice').value = p.price;
    document.getElementById('productStock').value = p.stock;
    document.getElementById('productSKU').value = p.sku || '';

    if (p.imageUrl) {
        const preview = document.getElementById('imagePreview');
        if (preview) { preview.src = p.imageUrl; preview.classList.remove('hidden'); }
    }

    renderVariantsList();

    const modalTitle = document.querySelector('#addProductModal h3');
    if (modalTitle) modalTitle.textContent = 'Editar Producto';
    const submitBtn = document.querySelector('#addProductForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Guardar Cambios';

    document.getElementById('addProductModal').classList.add('active');
};

const _origCloseAddProductModal = closeAddProductModal;
closeAddProductModal = function() {
    modoEdicion = false;
    edicionProductoId = null;
    const modalTitle = document.querySelector('#addProductModal h3');
    if (modalTitle) modalTitle.textContent = 'Nuevo Producto';
    const submitBtn = document.querySelector('#addProductForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Agregar Producto';
    _origCloseAddProductModal();
};

document.getElementById('addProductForm').addEventListener('submit', function(e) {
    if (!modoEdicion) return;
    e.preventDefault();
    e.stopImmediatePropagation();

    const idx = products.findIndex(function(x) { return x.id === edicionProductoId; });
    if (idx === -1) return;

    const categoryId = document.getElementById('productCategory').value;
    const category = categories.find(function(c) { return c.id === categoryId; });
    const sku = document.getElementById('productSKU').value.trim() || products[idx].sku;

    products[idx] = Object.assign({}, products[idx], {
        name: document.getElementById('productName').value,
        category: categoryId,
        cost: parseFloat(document.getElementById('productCost').value) || 0,
        price: parseFloat(document.getElementById('productPrice').value) || 0,
        stock: parseInt(document.getElementById('productStock').value) || 0,
        sku: sku,
        image: category ? category.emoji : products[idx].image,
        imageUrl: currentProductImage || products[idx].imageUrl,
        variants: [...currentVariants]
    });

    saveProducts();
    renderInventoryTable();
    renderProducts();
    updateDashboard();
    closeAddProductModal();
    alert('‚úÖ Producto actualizado correctamente');
}, true);

// ============================================================
// FIX: RECORDAR SECCI√ìN ACTIVA al recargar p√°gina
// ============================================================
const _origShowSection = showSection;
showSection = function(sectionName) {
    _origShowSection(sectionName);
    localStorage.setItem('maneki_activeSection', sectionName);
};

window.addEventListener('load', function() {
    const lastSection = localStorage.getItem('maneki_activeSection');
    if (lastSection) {
        try { showSection(lastSection); } catch(e) { showSection('dashboard'); }
    }
});

</script>
</body>
</html>
